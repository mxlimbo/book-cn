<HTML>
<HEAD>
<TITLE>Lab: Accessing Data Using ADO Objects</TITLE>
<link rel="STYLESHEET" type="text/css" href="Library.css">

</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch06f.htm", "ch06h.htm", "images/unit_o_a1.gif", "images/unit_o_a2.gif", "images/unit_o_b1.gif", "images/unit_o_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#ff9900", "2");
//--></SCRIPT>


<A NAME="259"><H1>Lab: Accessing Data Using ADO Objects</H1></A>

<P>In this lab you will create the ADOCOM component and a user-interface to test this component. The component will use ADO to connect to the Chateau St. Mark hotel's Rsvn database and retrieve records in the Reservations table containing a specific Check-in date. These records will be returned to the user-interface and be used to fill a Hierarchical FlexGrid control.</P>

<p>
<img src="images/video.gif" width=78 height=54 border="0">
</p>


<P>To see a demonstration of this lab, run the Lab06.exe animation located in the Animations folder on the Supplemental Course Materials CD-ROM that accompanies this book. </P>

<P><div class="note"><blockquote><b>NOTE</b><hr>
Before you can complete this lab, you must import the Rsvn database into SQL Server by completing the lab in Chapter 5, &quot;<A HREF="ch05a.htm#194">Introducing ActiveX Data Objects</A>.&quot;
</blockquote></div></p>


<b>Estimated lesson time: 30 minutes</b>


<A NAME="260"><H2>Exercise 1: Creating the COM Component that Uses ADO</H2></A>

<P>In this exercise you will create and ActiveX DLL component named ADOCOM. The ADOCOM component will create a connection to the Rsvn database and return a recordset value to the client created in Exercise 2.</P>

<p><li><b>To build the ADOCOM object</B></li></P>

<ol>
<p><li>Create a new <B>ActiveX DLL </B>project.</li></p>

<p><li>On the <B>Project</B> Menu, click <B>References</B>.</li></p>

<p><li>Check <B>Microsoft ActiveX Data Objects 2.0 Library</B> and click <B>OK</B>.</li></p>

<p><li>Set the project <B>Name</B> property to <B>ADOCOM</B>.</li></p>

<p><li>Set the class modules <B>Name</B> property to <B>CConnection</B>.</li></p>

<p><li>In the <B>CConnection</B> module declare the following module level variables:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Private cn As ADODB.Connection
Private rs As ADODB.Recordset
</pre></td></tr></table></p>
</ol>

<p><li><b>To connect to the SQL Server</B></li></P>

<ol>
<p><li>In the <B>Class_Initialize</B> event, add the following code:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Private Sub Class_Initialize()

    Set cn = New ADODB.Connection
    With cn
            ' Verify the name of your server, uid, and password
            .ConnectionString = &quot;Provider=SQLOLEDB.1;&quot; &amp; _
                &quot;Persist Security Info=False;User ID=sa;&quot; &amp; _ 
                &quot;Initial Catalog=Rsvn;Data Source=VB6ENTSVR&quot;
            .Open
        'Optional, to verify the connection was made
        If .State = adStateOpen Then
            ' Connection was successful
        Else
            ' Connection was not successful
        End If
    End With
End Sub

</pre></td></tr></table></p>

<p><li>Add the following Class_Initialize event procedure:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Private Sub Class_Terminate()
    Set rs = Nothing
    Set cn = Nothing
End Sub
</pre></td></tr></table></p>
</ol>

<p><li><b>To create a recordset object</B></li></P>

<ol>
<p><li>In <B>CConnection</B> add a new function procedure called <B>GetReservation</B> that defines the recordset and handles errors:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Public Function GetReservation(dtCheckInDate As Date, ByRef _
    ReservationData As Object) As Boolean
On Error GoTo Err_Trap
    Set rs = New ADODB.Recordset
    rs.Open &quot;Select * FROM Reservation WHERE CheckInDate = '&quot; &amp; _
         dtCheckInDate &amp; &quot;'&quot;, cn, adOpenDynamic, adLockPessimistic
    Set ReservationData = rs
Exit_Trap:
    Exit Function
Err_Trap:
    GetReservation = False
    Set rs = Nothing
    Err.Raise Err.Number, &quot;Problem in DLL&quot;, Err.Description
    Resume Exit_Trap
End Function
</pre></td></tr></table></p>

<p><li>Save your work.</li></p>
</ol>

<A NAME="261"><H2>Exercise 2: Creating the Client</H2></A>

<P>In this exercise you will add a Standard EXE project to the ADOCOM component created in Exercise 1. You will then create a reference to this component and create the user interface that calls the ADOCOM component.</P>

<p><li><b>To create the user interface</B></li></P>

<ol>
<p><li>Add a <B>Standard EXE</B> project to the ADOCOM project. Name the project <B>TestADO</B> and the form <B>frmRes</B>.</li></p>

<p><li>Add a <B>Hierarchical FlexGrid</B> control to the form. Set the <B>Name</B> property to <B>flexRes</B>.</li></p>

<p><li>Set the flexRes<B> FixedCols</B> property to <B>0.</B></li></p>

<p><li>Add a CommandButton to the form. Set the <B>Name</B> property to <B>cmdFindReservation</B>, the <B>Caption</B> property to <B>&amp;Find Reservation</B>, and the Enabled property to <B>False</B>.</li></p>

<p><li>Add a TextBox control with the <B>Name</B> property set to <B>txtCheckInDate</B> and the Text property set to <B>&lt;blank&gt;</B>.<B> </B></li></p>

<p><li>Add a Label control and set the <B>Caption</B> property to <B>Enter Check-in date:</B>. Figure 6.4 shows the form layout.</li></p>

<P>
<A HREF="javascript:fullSize('F06xx04x.htm')"> <img src="images/F06xx04.JPG" width=404 height=383 border=0 ALT = "Click to view at full size."> </A>
</P><P>
<!--caption--><b>Figure 6.4</b> <i>Lab 6 User interface</i><!--/caption-->
</P>


<p><li>Add the following code to the <B>txtCheckInDate_Change</B> event procedure:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Private Sub txtCheckInDate_Change()
    If txtCheckInDate.Text = &quot;&quot; Then
        cmdFindReservation.Enabled = False
    Else
        cmdFindReservation.Enabled = True
    End If
End Sub
</pre></td></tr></table></p>
</ol>

<p><li><b>To instantiate the ADOCOM DLL</B></li></P>

<ol>
<p><li>Select the TestADO project in the Project Group window.</li></p>

<p><li>Select <B>References</B> from the Project menu.</li></p>

<p><li>Check <B>ADOCOM</B> to create a reference to the ADOCOM object library and click <B>OK</B>.</li></p>

<p><li>Set the TestADO project as the startup project.</li></p>

<p><li>Add the following code to <B>cmdFindReservation</B>:</li></p>

<P><TABLE CELLPADDING=5 WIDTH="95%"><TR><TD><PRE>
Private Sub cmdFindReservation_Click()
    Dim Reservations As Object
    Dim Success As Boolean
    Dim PubsConn As ADOCOM.CConnection

On Error GoTo ERR_FIND
    Set PubsConn = New ADOCOM.CConnection
    Success = PubsConn.GetReservation( _
        txtCheckInDate.Text, Reservations)
    Set flexRes.DataSource = Reservations
    Set PubsConn = Nothing
EXIT_FIND:
    Exit Sub
ERR_FIND:
    MsgBox Err.Number &amp; vbCrLf &amp; Err.Source &amp; vbCrLf &amp; _
        Err.Description
    Resume EXIT_FIND
End Sub
</pre></td></tr></table></p>

<p><li>Save and test the application by entering the following Check-in Dates:</li></p>

<ul>
<p><li>5/26/99</li></p>

<p><li>4/8/99</li></p>

<p><li>11/20/99</li></p>
</ul></ol>


</BODY>
</HTML>



