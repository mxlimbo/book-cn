<HTML>
<HEAD>
<TITLE>Lesson 1: Windows Setup Programs</TITLE>
<link rel="STYLESHEET" type="text/css" href="Library.css">

</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch14a.htm", "ch14c.htm", "images/unit_o_a1.gif", "images/unit_o_a2.gif", "images/unit_o_b1.gif", "images/unit_o_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#ff9900", "2");
//--></SCRIPT>

<A NAME="537"><H1>Lesson 1: Windows Setup Programs</H1></A>

<p>Deployment consists of two steps. The first step is to transfer all necessary files
to the users' hard disks. The second step, which is potentially more complicated,
involves configuring the host system so that it recognizes and correctly runs the
installed application. To help ensure proper deployment, you should automate the
process of getting an application up and running as much as possible. Windows users are
accustomed to an installation program that does most of the work for them.</p>

<p>
<div class="sidebar"><blockquote>
<b>After this lesson, you will be able to:</b>


<ul>
<p><li> Describe how an application is installed on and removed from a user's
system.</li></p>

<p><li> List the services provided by a typical installation program.</li></p>

<p><li> Describe various entries that an installation program places in a user's
registry.</li></p>

<p><li> Create cabinet and registry files.</li></p>
</ul>


<b>Estimated lesson time: 20 minutes</b>
</blockquote></div>
</p>


<A NAME="538"><H2>Setup Program Conventions</H2></A>

<p>An installation program should always be named Setup for two reasons:</p>

<ul>
<p><li> To conform to convention.</li></p>

<p><li> To be recognizable to the Add/Remove Programs applet in Control Panel.</li></p>
</ul>


<p>Consistent use of the Setup file name has become standard practice for application
deployment programs, which helps to minimize confusion among users. The standard
Windows user knows how to work with programs named Setup, though the programs can
differ in individual style and methods. For purposes of discussion, this lesson refers
to installation programs generically as Setup programs.</p>

<p>If your application distribution requires several disks or CD-ROMs, the Setup
program should exist on the first disk or CD-ROM of the series to ensure that it is
easily located by the Windows Add/Remove Programs applet.</p>

<p>A number of installation services can be provided to users. A typical setup program
will:</p>

<ul>
<p><li> Prompt for selected program options.</li></p>

<p><li> Create folders on a user's hard disk as required.</li></p>

<p><li> Copy files from the distribution media to the hard disk.</li></p>

<p><li> Add registry information for shared DLLs.</li></p>

<p><li> Register an application's ActiveX controls and other COM components.</li></p>

<p><li> Add information to the system registry specifying the command needed to remove the application. This allows the Add/Remove Programs applet to identify
the application's uninstall program.</li></p>

<p><li> Record the extension used for the application's document files in the system
registry to allow users to launch the application from Windows Explorer by
double-clicking a document in a file list.</li></p>

<p><li> Add an entry to the Windows <b>Programs</b> menu, or a desktop shortcut if
stipulated.</li></p>

<p><li> Execute &quot;run-once code&quot; to minimize installation size if the Setup
program is not copied to the hard disk.</li></p>

<p><li> Add or make unavailable selected options from the installed application when the
Setup program is run again.</li></p>
</ul>


<p>The user should need only to select an installation option and insert any additional
disks or CD-ROMs as prompted. Microsoft recommends that an installation program include
the following four options:</p>

<ul>
<p><li> <i>Compact</i> for laptops and systems with limited disk space.</li></p>

<p><li> <i>Custom</i> to give users control over what is installed.</li></p>

<p><li> <i>Typical</i> to provide a common default suitable for most users.</li></p>

<p><li> <i>Silent</i> for unattended installation.</li></p>
</ul>


<p>Silent installation is necessary for systems managers who want to install an
application across a network. While running in silent mode, the Setup program should
not query or display error messages, and must assume intelligent default settings for
all cases.</p>

<A NAME="539"><H2>Guidelines for Writing a Setup Program</H2></A>

<p>Keep the following points in mind when you plan a Setup program for your
application's deployment. An intelligent Setup program should:</p>

<ul>
<p><li> Store private initialization (.ini) files in the application directory if the
application is running locally, or in the directory returned by the <b>
GetWindowsDirectory()</b> API function if the application is shared.</li></p>

<p><li> Avoid inappropriately copying files to the Windows, WinNT, System, or System32 directories. If your application package includes font files, they should
be copied to the system's Fonts folder.</li></p>

<p><li> Check that a file does not already exist on the hard disk before copying it. If
the Setup program finds a conflict, it should decide which file is most recent and
avoid overwriting a newer file.</li></p>

<p><li> Supply defaults. In particular, the Setup program should provide a common
response to every option so users press only the ENTER key at each prompt for a
successful default installation.</li></p>

<p><li> Avoid prompting users to insert the same disk more than once.</li></p>

<p><li> Inform users about required disk space.</li></p>

<p><li> Display a progress indicator.</li></p>

<p><li> Store intermediate files in the Temp directory. However, if the Setup program
must restart Windows before reading intermediate files, it should confirm that the Temp
directory exists on a hard disk and not on a RAM disk. This procedure ensures that the
necessary files will still exist after restarting.</li></p>

<p><li> Give users a chance to cancel installations before finishing. The Setup program
should keep a log of files that have been copied and settings that have been registered
so that it can clean up canceled installations.</li></p>
</ul>


<p>A user installs your application either by running the Setup program directly or by
running the Add/Remove Programs applet in Control Panel. Add/Remove Programs
automatically searches the disk or CDROM drive for a program named Setup.exe. If the
file is found and the user agrees to finish the installation, Add/Remove Programs
starts the Setup program and closes. After Add/Remove Programs closes, the Setup
program is responsible for guiding the user through the rest of the installation
process.</p>

<A NAME="540"><H2>Uninstall Program Conventions</H2></A>

<p>An installed product should be able to safely, and as completely as possible,
remove all traces of itself. This operation, sometimes known as <i>de-installing</i> or
<i>uninstalling</i>, is typically carried out by a separate program with a descriptive
name such as Uninstall or Uninst. Alternatively, the Setup program itself can be
written to act as the uninstaller. You have much more flexibility when choosing a name
for your uninstall program because the location and file name of the uninstall program
are identified in the Setup program and written to the system registry during the
installation process. This action assures that Add/Remove Programs can locate the
correct uninstaller executable regardless of its name.</p>

<p>Uninstalling is an important feature for users, and also is one of the prerequisites
for an application to be approved for the Windows compliance logo. Uninstalling
includes deleting application files (but not documents) and removing entries added to
the system registry.</p>

<p>Because many applications share resources and make modifications throughout the
system, deleting an application is rarely a matter of simply deleting files in a single
subdirectory. Users must be able to uninstall cleanly and reinstall to correct
problems, change configurations, or upgrade applications. The uninstall feature also
allows users to free disk space and to abide by licensing agreements when deleting an
application from one computer before installing it on others.</p>

<p>Uninstalling a Windows application must be done carefully. A potential problem
arises when deleting a program's dependency modules such as DLLs and ActiveX
controls. (Dependencies are described in <a href="ch13f.htm#512">Lesson 5</a> of Chapter 13.) The uninstall
operation must not delete modules upon which other applications
depend.</p>

<p>An uninstall program cannot directly determine if a module serves other programs,
but can infer whether a module is shared by consulting a usage count stored in a common
area of the registry. Usage counts are described in the next section.</p>

<A NAME="541"><H2>Adding and Removing Registry Information</H2></A>

<p>An installation program adds all the necessary information about your application to the registry. User preference data should be written to the registry's
<b>HKEY_CURRENT_USER\SOFTWARE</b> key. In earlier versions of Windows, this information
was written to the Win.ini file. For information specific to the application, add
entries to the <b>HKEY_LOCAL_MACHINE\SOFTWARE</b>
registry key using this format:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\<i>CompanyName</i>\<i>ProductName</i>\<i>Version</i></pre>
</td></tr>
</table>
</p>

<p>Substitute names for the italicized placeholders that are appropriate for your
application.</p>

<A NAME="542"><H3>PATH Environment Variable</H3></A>

<p>Each running application has its own PATH environment setting, containing a list of
paths to various folders. The list specifies the paths that the operating system should
search when looking for executable modules required by the application. By default,
Windows searches certain system folders first in an effort to locate files required for
loading an application. Since most applications are installed to unique directories,
the path to the application's components must be specified in an
application-specific PATH setting.</p>

<p>For example, consider an application in the MyApp folder that uses a DLL in the
MyDLL folder. Assuming normal linkage&#8212;that is, assuming the application does not
call the <b>LoadLibrary()</b> API function to load the DLL&#8212;the application cannot
run unless MyDLL appears in the PATH list. The operating system will search only for
DLL files in the default system folders and the folders specified in the PATH variable.
If a referenced DLL is not located, the system will refuse to run the application. The
application's installation program must therefore specify a PATH setting that
includes the MyDLL folder where the required DLL file resides.</p>

<p>To register a PATH, a Setup program should write the desired value in the <b>
HKEY_LOCAL_MACHINE</b> root under the <b>\SOFTWARE\Microsoft\
Windows\CurrentVersion\App Paths</b> key. This is the same string contained
in the <b>REGSTR_PATH_APPPATHS</b> text macro defined in the Regstr.h file. Notice that
the last nested key, <b>App Paths</b>, is two words.</p>

<p>The Setup program should create a new registry key having the same name as the
application's executable file, and then insert a Path value containing the
desired path. Here's an example of how the Path registry value might look for the
NewApp program located in the MyApp folder of the preceding code:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\
App Paths\NewApp.exe

Default=D:\MyPrograms\MyApp\NewApp.exe

Path=D:\MyPrograms\MyDLL;D:\MyPrograms\MyApp\Utilities</pre>
</td></tr>
</table>
</p>

<p>The Default value specifies the full path to the executable file. The operating
system refers to this value when a user types the application name in the <b>Run</b>
dialog box without specifying a full path to the executable file. Windows locates the
requested executable by searching the <b>App Paths</b> key, then reads the full path
from the Default value.</p>

<p>The Path value contains NewApp's PATH environment, which includes a reference to
the MyDLL folder. When the operating system loads NewApp, it searches the prescribed
locations for the DLL that NewApp needs. By including the MyDLL folder in the
application's PATH, the Setup program ensures that the system can always locate the
required DLL file when running NewApp.</p>

<A NAME="543"><H3>Usage Counts for Shared Modules</H3></A>

<p>For each shared module that it installs, the Setup program should consult the
registry and increment the module's usage count. When the application is removed,
the uninstall program must decrement the usage count. If the count drops to zero, the
uninstaller can delete the module&#8212;though usually only after querying the user for
permission. If every Setup program were to follow this procedure, dependency modules
could be safely removed. Unfortunately, not every developer creating installation
programs conforms to this convention; thus, it is customary to query users before
removing a file for which the usage count has reached zero.</p>

<p>Usage counts for shared modules are stored in the <b>HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\SharedDLLs</b> key. Figure 14.1 shows an example in the RegEdit utility (described later), in which the usage
count for an ActiveX control named msinet.ocx is
currently 2.</p>

<p>
<A HREF="javascript:fullSize('f14DA01x.htm')"> <img src="images/f14DA01.jpg" width=404 height=181 border=0 ALT="Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 14.1</b> <i>Viewing a usage count in the RegEdit utility</i><!-- /caption -->
</p>

<A NAME="544"><H2>Cabinet Files</H2></A>

<p>A <i>cabinet file</i> contains files in compressed form, resulting in a single file
that serves as a file library. Cabinet files, recognizable by their .cab extension, are
often used when deploying large applications because they reduce the number of disks or
CD-ROMs required. The application's Setup program reads the .cab files,
decompresses their contents into the original files, and writes the files to the
user's hard disk.</p>

<p>A .cab file is similar to a .zip file in that it serves as a compressed archive for
a group of files. A .cab file can contain any kind of file, and can also have a digital
signature that identifies the file's creator and ensures that the file has not been
maliciously or accidentally altered. Digital signatures are described in more detail in
<a href="ch14e.htm#557">Lesson 4</a> of this chapter.</p>

<p>Creating a .cab file requires either the MakeCab or CabArc (Cabinet Archiver)
utilities. Both programs are part of the Microsoft Cabinet Software Development Kit
(SDK), available as a free download from
<A HREF="http://msdn.microsoft.com/workshop/management/cab/cabdl.asp" TARGET="_window2">msdn.microsoft.com/workshop/management/cab/cabdl.asp</A>. MakeCab creates compressed disk
images containing a product's files, and is designed to work with Setup programs.
CabArc is a console-based program that can read and write .cab files. To run CabArc,
type a list of options, the name of the .cab file, and a list of files to compress or
decompress. For example, the line</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>cabarc n images.cab \myapp\images\*.jpg \myapp\images\*.gif</pre>
</td></tr>
</table>
</p>

<p>creates the Images.cab file, and adds, in compressed form, all the .jpg and .gif
graphics files in the MyApp\Images folder. The <i>n</i> option tells CabArc to create a
new file. The Cabinet SDK contains examples and documentation for the CabArc and
MakeCab programs.</p>

<A NAME="545"><H2>Registry Files</H2></A>

<p>Setup programs sometimes use registry files to write entries into the system
registry. Recognizable by its .reg extension, a registry file serves as a script that
lists keys, values, and locations to be added to the registry. Because a registry file
is in ASCII format, it can be viewed and edited in a text editor. For example, the
registry file for the NewApp program mentioned earlier specifies the program's PATH
environment as shown in the following code:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>REGEDIT4

[HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\CurrentVersion\
App Paths\NewApp.exe]

@=&quot;D:\\MyPrograms\\MyApp\\NewApp.exe&quot;

&quot;Path&quot;=&quot;D:\\MyPrograms\\MyDLL;D:\\MyPrograms\\MyApp\\Utilities&quot;</pre>
</td></tr>
</table>
</p>

<p>Although long lines in the script have been broken to fit on the printed page, each
entry must occupy a single unbroken line in the registry file. No continuation
character for registry scripts exists.</p>

<p>The code as shown assumes that the NewApp program is in the MyPrograms\ MyApp
subdirectory, and demonstrates a potential problem with registry files. The Setup
program must ensure that any paths specified in the script correspond to the location
where a user ultimately decides to install the application. Therefore, the Setup
program must be prepared to alter a .reg file before using it.</p>

<p>Windows provides the RegEdit utility to read and write registry files. A Setup
program can use RegEdit to write (or <i>import</i>) the script into the user's
system registry, and supply a registry file in the command line like this:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>regedit newapp.reg</pre>
</td></tr>
</table>
</p>

<p>This command writes the contents of the NewApp.reg file to the system registry. The
following code demonstrates how to create a file named IEpath.reg, which contains a
copy of the path information for Internet Explorer:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>regedit /e IEpath.reg &quot;HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows\
CurrentVersion\App Paths\IEXPLORE.exe&quot;</pre>
</td></tr>
</table>
</p>

<p>The <i>/e</i> switch causes RegEdit to read (or <i>export</i>) a section of the
registry to a specified file. It is necessary to include the registry key information
in double quotation marks only when the key contains a space, as in <b>App Paths</b>.
Otherwise, quotation marks are not required.</p>

<p>The RegEdit utility provides a simple Windows user interface, so it does not need to
be run from the command line. The following exercise demonstrates how to write a .reg
file by invoking a command on the program's <b>Registry</b> menu.</p>

<p><li> <b>To create the IEpath.reg file in RegEdit</b></li></p>

<ol>
<p><li> On the taskbar, click the <b>Start</b> button, and then click <b>Run</b>. In the
<b>Open</b> box, type <b>regedit</b>, and then click <b>OK</b> to start the RegEdit
utility.</li></p>

<p><li> Beginning with the <b>HKEY_LOCAL_MACHINE</b> root, expand the tree view and
select the <b>IEXPLORE.EXE</b> key as shown in Figure 14.2. The full path to the <b>IEXPLORE.EXE</b> key is shown at the bottom of the RegEdit window in the
figure.</li></p>


<p>
<A HREF="javascript:fullSize('f14DA02x.htm')"> <img src="images/f14DA02.jpg" width=404 height=178 border=0 ALT="Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 14.2</b> <i>Selecting Internet Explorer's PATH entry in the system registry</i><!-- /caption -->
</p>


<p><li> On the <b>Registry</b> menu, click <b>Export Registry File</b>.</li></p>

<p><li> Select the desired folder and type <b>IEpath</b> in the <b>File name</b>
box.</li></p>

<p><li> Click <b>Save</b>, and then exit RegEdit.</li></p>

<p><li> Start a text editor such as Notepad and open the new IEpath.reg file that has
been created in your default document directory. The script shows that, like many
programs, Internet Explorer includes its own application folder as part of its PATH
environment.</li></p>
</ol>

<p>A registry file is most useful when a large amount of registry data is being
manipulated or when the data is transitory and the Setup program must load and then
unload the information again. A Setup program can also use the RegEdit utility to
create a backup copy of selected registry information. The uninstall program can then
restore the original settings if the user chooses to delete the application.</p>

<A NAME="546"><H2>Lesson Summary</H2></A>

<p>This lesson presented a general overview of the installation process in which a
Setup program configures a user's computer to run an application.</p>

<p>A Setup program should ideally provide installation options labeled Compact, Custom,
Typical, and Silent. Silent installation allows administrators to run the Setup program
unattended when installing the application across a network.
Professional-quality Setup programs seek to make the installation process as easy as
possible for the user.</p>

<p>If the application requires a custom PATH environment, the Setup program should
record the desired variable in the registry. This specifies the PATH setting that
Windows makes current when the application runs. The Setup program should also consult
the registry when installing shared modules such as DLLs and ActiveX controls,
incrementing usage counts for the modules. When the
application is removed, the uninstall program decrements the counts and prompts to
remove the file when the count reaches zero.</p>

<p>The lesson finished with an introduction to cabinet and registry files. Cabinet
files serve as archives that contain other files in compressed form. Microsoft makes
available utilities such as MakeCab and CabArc for creating and using cabinet files.
Registry files are scripts that can be inserted into the system registry using the
RegEdit utility.</p>

</BODY>
</HTML>







