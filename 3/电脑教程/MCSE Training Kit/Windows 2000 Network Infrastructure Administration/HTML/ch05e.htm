<HTML>
<HEAD>
<TITLE>Lesson 4: Monitoring IPSec</TITLE>
<link rel="STYLESHEET" type="text/css" href="mmnet.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<BODY BGCOLOR="#ffffff" TEXT="#000000">
<A HREF="ch05d.htm">[Previous]</A> <A HREF="ch05f.htm">[Next]</A><P>



<A NAME="234"><H1>Lesson 4: Monitoring IPSec</H1></A>

<p>To view how your IPSec policies and rules are being used in your network, you may want to monitor IPSec. In this lesson, you will use several tools to do just that. You will focus on IPSec monitoring tools like IPSECMON.EXE, Event Viewer, Performance Monitor, and Network Monitor. These tools will help you maintain a secure, IPSec-rich network.</p>

<p><div class="sidebar"><blockquote>
<b>After this lesson, you will be able to</b>

<ul>
<p><li>Troubleshoot IPSec with IPSECMON.EXE</li></p>

<p><li>Troubleshoot IPSec with Event Viewer</li></p>

<p><li>Troubleshoot IPSec with Network Monitor</li></p>

<p><li>Describe troubleshooting with an IPSECPA.LOG or OAKLEY.LOG file</li></p>
</ul>

<p><b>Estimated lesson time: 30 minutes</b></p>
</blockquote></div></p>

<A NAME="235"><H2>IPSec Management and Troubleshooting Tools</H2></A>

<p>Windows 2000 provides tools that you can use to manage and troubleshoot IPSec. This section provides an overview of these tools.</p>

<A NAME="236"><H3>Management Tools</H3></A>

<ul>
<p><li>The IP Security Policy Management snap-in creates and edits policies (the Group Policy Editor can also be used).</li></p>

<p><li>The IP Security Management tool is also on the default Start/Programs/Administrative Tools menu.</li></p>
</ul>

<A NAME="237"><H3>Monitoring and Troubleshooting Tools</H3></A>

<p>IP Security Monitor (IPSECMON.EXE), illustrated in Figure 5.13, is started at a command prompt. This tool monitors IP SAs, rekeys, negotiation errors, and other IP Security statistics.</p>

<A NAME="238"><H3>IPSec Statistics</H3></A>

<p>The following IPSec statistics can be measured using IP Security Monitor:</p>

<ul>
<p><li><b>Active Associations.</b> Simply a counter of active SAs.</li></p>

<p><li><b>Confidential Bytes Sent/Received.</b> Total of bytes sent and received using the ESP protocol.</li></p>

<p><li><b>Authenticated Bytes Sent/Received.</b> Total of bytes sent and received using the AH protocol.</li></p>

<p>
<A HREF="javascript:fullSize('05ntk13x.htm')"> <img src="images/05ntk13.JPG" width=404 height=303 border=0 ALT="Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 5.13</b> <i>IP Security Monitor</i><!-- /caption -->
</p>

<p><li><b>Bad SPI Packets.</b> Total number of packets for which the SPI was wrong. As discussed earlier in this module, the SPI is used to match inbound packets with SAs. If the SPI is bad, it may mean that the inbound SA has expired but that a packet using the old SPI has just arrived. This number is likely to increase if rekey intervals are short and there are a large number of SAs. Because SAs expire normally, a bad SPI packet does not necessarily indicate that IPSec is failing.</li></p>

<p><li><b>Packets Not Decrypted.</b> Total number of packets that failed decryption. As with bad SPI packets, this failure may indicate that a packet arrived for which the SA had expired. If the SA expires, the session key used to decrypt the packet dies, too. This does not necessarily indicate that IPSec is failing.</li></p>

<p><li><b>Packets Not Authenticated.</b> Similar to Bad SPI Packets and Packets Not Decrypted, this is the total number of packets containing data that could not be verified. The most likely cause is an expired SA.</li></p>

<p><li><b>Key Additions.</b> The total number of keys that ISAKMP has sent to the IPSec driver. This indicates the total number of successful Phase 2 negotiations.</li></p>
</ul>

<A NAME="239"><H3>ISAKMP/Oakley Statistics</H3></A>

<p>The following ISAKMP/Oakley statistics can be measured using IP Security Monitor:</p>

<ul>
<p><li><b>Oakley Main Modes.</b> Total number of successful ISAKMP SAs created during Phase 1 negotiations.</li></p>

<p><li><b>Oakley Quick Modes.</b> Total number of successful IPSec SAs created during Phase 2 negotiations. Because these SAs may expire at different rates, this number will not necessarily match the Main Modes number.</li></p>

<p><li><b>Soft Associations.</b> Total number of Phase 2 negotiations that resulted in agreements to send using clear text. This typically reflects the number of associations formed with non-IPSec-aware computers.</li></p>

<p><li><b>Authentication Failures.</b> Total number of identity authentication failures (Kerberos, user certificate, manually configured passwords). This is not the same statistic as Packets Not Authenticated (message authentication through hashing).</li></p>
</ul>

<p><div class="note"><blockquote><b>NOTE</b><HR>
To reset the statistics in IP Security Monitor, restart the IP Security Policy Agent.
</blockquote></div></p>

<p>Performance Monitor includes IPSec objects and counters that can be examined. These related events can also be recorded and then later analyzed in Event Viewer:</p>

<ul>
<p><li>Policy agent and IPSec driver events in the system log</li></p>

<p><li>Oakley events in the application log</li></p>

<p><li>ISAKMP events (SA details) in the security log (if logon auditing is enabled)</li></p>
</ul>

<A NAME="240"><H2>Using Network Monitor</H2></A>

<p>Network Monitor Version is a useful troubleshooting tool with IPSec. Both the limited version included with Windows 2000 Server and the full version included with Microsoft Systems Management Server version 2.0 feature parsers for ISAKMP, AH, and ESP. Network Monitor captures all information transferred over a network interface at any given time.</p>

<p>Network Monitor version 2.0 contains parsers for IPSec packets. If IPSec is encrypting the packets, then the contents will not be visible, but the packet itself will. If only authentication is being used, the entire packet, including its contents, will be visible. ESP will be displayed as IP protocol number 50 (decimal) and AH will be displayed as 51 (decimal). ISAKMP/Oakley will be displayed as UDP port number 500 (decimal).</p>

<p><div class="note"><blockquote><b>NOTE</b><HR>
The ESP data itself will not be readable because of the encryption.
</blockquote></div></p>

<p>
<img src="images/practic.JPG" width=90 height=72 border="0">
</p>

<A NAME="241"><H2>Practice: Using Network Monitor to View Clear Text Traffic</H2></A>

<p>Using this tool, you will capture and view the data being sent across the wire between your computer and your second computer. Network Monitor version 2.0 contains parsers for IPSec and ISAKMP packets. Network Monitor gets the packet after IPSec, so if IPSec encrypts the packet, then the contents will not be visible.</p>

<p><div class="note"><blockquote><b>NOTE</b><HR>
Do the entire practice on both computers. This exercise will be done one computer at a time.
</blockquote></div></p>

<p><li><b>To view IPSec integrity packets (AH format)</b></li></p>

<ol>
<p><li>Start Network Monitor and set the capture network to the media access control address of the network card that connects to the second system.</li></p>
</ol>

<p><div class="note"><blockquote><b>NOTE</b><HR>
You can run ipconfig with the /all parameter to find the media access control address of your network interface card.
</blockquote></div></p>

<ol start=2>
<p><li>In the Local Security Settings MMC interface, assign the Two Computer Policy (from the practice in <a href="ch05d.htm#215">Lesson 3</a>).</li></p>

<p><li>Start capturing packets with Network Monitor.</li></p>

<p><li>Run the ipsecmon utility.</li></p>

<p><li>PING your second computer's IP address.</li></p>

<p><li>You may have to repeat this step, as PING has a very short time-out, and there is some delay in establishing the IPSec association between the two computers.</li></p>

<p><li>Stop and view the Network Monitor trace.</li></p>

<p><li>View ipsecmon.</li></p>

<p><li>Double-click the first Internet Control Message Protocol (ICMP) packet.</li></p>

<p><li>Notice that you see lines indicating headers for frame, Ethernet, IP, and AH.</li></p>

<p><li>From the details pane, expand the IP entry.</li></p>

<p><li>Record the IP Protocol number.</li></p>

<p>Scroll to the bottom of the IP details and click on IP Data: Number Of Data Bytes Remaining = 64 (0x0040). Notice the IP payload is in clear text. The data in a PING is abcdefghij&#8230;</p>
</ol>

<p>IPSec has created an ICV from the IP, ICMP, and Data fields of the frame. By doing this, IPSec prevents someone from capturing the data, altering it, and re-sending the bad data. Looking at the Hex pane you can still see the 32 characters sent in the PING. By configuring AH security method, we ensure authentication but do not encrypt the data in the packet. AH just makes sure that the packet data, as well as most parts of the IP header, such as source and destination IP addresses, are not modified. Next we will look at packets using the ESP security method that will encrypt the data part of the IP packet.</p>

<p>
<img src="images/practic.JPG" width=90 height=72 border="0">
</p>

<A NAME="242"><H2>Practice: Using Network Monitor to View Encrypted Traffic</H2></A>

<p>In this practice, you will use Network Monitor to set ESP encryption and view encrypted packets.</p>

<p><li><b>To set ESP encryption</b></li></p>

<ol>
<p><li>Unassign the Two Computer Policy.</li></p>

<p><li>Edit the Two Computer Policy by right-clicking on it, then click Properties.</li></p>

<p><li>Click the Filter Action tab.</li></p>

<p><li>Edit the active New Filter Action.</li></p>

<p><li>Click Edit to modify the Security Method.</li></p>

<p><li>Change Medium to High (ESP).</li></p>

<p><li>Close all dialog boxes.</li></p>

<p><li>Assign the Two Computer Policy.</li></p>
</ol>

<p><li><b>To view IPSec encrypted (ESP) packets</b></li></p>

<ol>
<p><li>Begin capturing packets with Network Monitor.</li></p>

<p><li>Run the ipsecmon utility.</li></p>

<p><li>PING the second computer's IP Address.</li></p>

<p><li>You may have to repeat this step as PING has a very short time-out and there is some delay in establishing the IPSec association between the two computers.</li></p>

<p><li>Stop and view the Netmon trace.</li></p>

<p><li>View ipsecmon.</li></p>

<p><li>Double-click the first ESP frame.</li></p>

<p><li>This time you will see four entries in the details pane: Frame, Ethernet, IP, and ESP. IPSec has created a hash of the ICMP and Data fields of the frame.</li></p>

<p><li>Expand the IP section and record the IP Protocol.</li></p>

<p><li>Scroll to the bottom of the IP details and double-click the IP: Data: Number Of Data Bytes Remaining = 76 (0x004C) line. Look at the Hex pane; you will see the data has been encrypted.</li></p>
</ol>

<p>
<img src="images/practic.JPG" width=90 height=72 border="0">
</p>

<A NAME="243"><H2>Practice: Using Diagnostic Aids</H2></A>

<p>In this practice, you will use the IPSec Monitor diagnostic aid to verify that IPSec is active and to view the active SAs.</p>

<A NAME="244"><H3>Using IPSec Monitor</H3></A>

<p>Windows 2000 Server contains a monitoring tool for IPSec called IPSecmon. Run this tool to see active security associations, &quot;soft&quot; or &quot;hard,&quot; on the local or remote machines. It does not show failed SAs or other filters.</p>

<p>Click Start, point to Run, then type <b>ipsecmon [machine name]</b>. For each soft or hard SA, you will see one line in the white box. The column on the left titled Policy Name is the name of the policy that had been assigned and enforced on the computer. The Negotiation Policy column is actually the specific security method that was agreed to during the negotiation. An attempt is made to resolve the IP addresses for source and destination to DNS names.</p>

<p>There are a number of global statistics to note that are accumulated since the computer was last started:</p>

<ul>
<p><li>Successful IPSec SAs will initially cause one ISAKMP/Oakley Main Mode and one Quick Mode. Key renewal operations are generally reflected as additional quick modes.</li></p>

<p><li>The total number of confidential (ESP) or authenticated (ESP and AH) bytes sent or received for all &quot;hard&quot; SAs is shown on the left. Because ESP provides both confidentiality and authenticity, both counters are incremented. Because AH provides only authenticity and not confidentiality, only the authenticated-bytes-sent counter is incremented.</li></p>

<p><li>The total number of soft associations is shown on the right.</li></p>
</ul>

<p><li><b>To see if IPSec is active and to view the active SAs</b></li></p>

<ol>
<p><li>Open Network and Dial-Up Connections from Control Panel.</li></p>

<p><li>Right-click on Local Area Connection, then click Properties.</li></p>

<p><li>Select Internet Protocol (TCP/IP), then click Properties.</li></p>

<p><li>Click Advanced.</li></p>

<p><li>Click the Options tab, select IP Security, then click Properties.</li></p>

<p>If the computer is using local policy, then the name of the local policy will be shown under Use This IP Security Policy. If you are using policy assigned through the Group Policy mechanisms in Active Directory, then the dialog will be grayed out and the name of the assigned policy will be shown in the same box.</p>
</ol>

<A NAME="245"><H2>Lesson Summary</H2></A>

<p>We have seen how to view your IPSec policies and rules used in a network. In this lesson, you used several tools to do just that. You focused on IPSec monitoring tools like IPSECMON.EXE and Network Monitor. These tools will help you to monitor and troubleshoot IPSec communications on your network.</p>

</BODY>
</HTML>





