<HTML>
<HEAD>
<TITLE>Lesson 3: Customizing IPSec Policies and Rules</TITLE>
<link rel="STYLESHEET" type="text/css" href="mmnet.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<BODY BGCOLOR="#ffffff" TEXT="#000000">
<A HREF="ch05c.htm">[Previous]</A> <A HREF="ch05e.htm">[Next]</A><P>



<A NAME="215"><H1>Lesson 3: Customizing IPSec Policies and Rules</H1></A>

<p>IPSec is easily customizable with policies and rules. In this lesson you will explore how to secure a network using these various methods, taking into consideration such things as proxies, network address translation (NAT), Simple Network Management Protocol (SNMP), Dynamic Host Configuration Protocol (DHCP), Domain Name System (DNS), Windows Internet Name Service (WINS), and domain controllers.</p>

<p><div class="sidebar"><blockquote>
<b>After this lesson, you will be able to</b>

<ul>
<p><li>Explain IPSec policies and rules</li></p>

<p><li>Describe how to configure IPSec for use with firewalls, NAT, and proxies</li></p>

<p><li>Describe how to use IPSec to secure a network with SNMP, DHCP, DNS, WINS, or domain controllers</li></p>
</ul>

<p><b>Estimated lesson time: 40 minutes</b></p>
</blockquote></div></p>

<A NAME="216"><H2>Policy-Based Security</H2></A>

<p>Strong, cryptographic security methods have become necessary to protect communications, but they can also increase administrative overhead. IPSec reduces this by providing policy-based administration. Your network security administrator can configure IPSec policies to meet the security requirements of a user, group, application, domain, site, or global enterprise. Windows 2000 provides an administrative interface, called IPSec Policy Management, to define IPSec policies for individual computers or groups of computers within Active Directory.</p>

<A NAME="217"><H3>IPSec Policies</H3></A>

<p>An IPSec policy is a named collection of rules and key exchange settings. The policy may be assigned as a domain security policy or an individual computer's security policy. A domain computer will automatically inherit the IPSec policy assigned to the domain security policy when it logs on to the domain. If a computer is not connected to a domain (for example, a roving laptop or a stand-alone server), IPSec policies are stored in and retrieved from the computer registry.</p>

<p>This allows great flexibility in configuring security policies for groups of similar computers or individual computers with special requirements. For example, one security policy can be created for all users on the same network or all users in a particular department. IPSec policies are created with the IPSec Management snap-in, as illustrated in Figure 5.12, for a Windows 2000 member server.</p>

<p>
<A HREF="javascript:fullSize('05ntk12x.htm')"> <img src="images/05ntk12.JPG" width=404 height=190 border=0 ALT="Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 5.12</b> <i>MMC of a Windows 2000 member server</i><!-- /caption -->
</p>

<A NAME="218"><H3>Rules</H3></A>

<p>Rules govern how and when IPSec is used. A rule contains a list of IP filters and specifies the security actions that will take place upon a filter match. A rule is a collection of</p>

<ul>
<p><li>IP filters</li></p>

<p><li>Negotiation policies</li></p>

<p><li>Authentication methods</li></p>

<p><li>IP tunneling attributes</li></p>

<p><li>Adapter types</li></p>
</ul>

<p>Each security policy may contain multiple rules. This provides the flexibility of assigning one IPSec policy to multiple computers with different communication scenarios. For example, one policy may cover all users in a department or network, but multiple rules may be required: one for intranet communications and another for Internet communications that require tunneling.</p>

<A NAME="219"><H2>IP Filters and Filter Specifications</H2></A>

<p>All rules are based on packets matching an IP filter. Each rule may only have a single IP filter active. The IPSec driver watches each IP datagram for a match with the active IP filter. If a match occurs, the action specified in the associated rule is implemented for that communication.</p>

<A NAME="220"><H3>Filter Specifications</H3></A>

<p>IP datagrams are checked for a match against each filter specification. Filter specifications contain the following properties:</p>

<ul>
<p><li>The source and destination address of an IP datagram, based on IP address, DNS name, or by a specific subnet or network</li></p>

<p><li>The protocol, TCP or UDP</li></p>

<p><li>The specific source and destination protocol port numbers for either TCP or UDP</li></p>
</ul>

<A NAME="221"><H2>Security Methods and Negotiation Policies</H2></A>

<p>The level of security used for a communication is determined by the security methods and the negotiation policy.</p>

<A NAME="222"><H3>Security Methods</H3></A>

<p>Each security method specifies a unique level of security to be used for the communication. Multiple security methods can be part of a single negotiation policy to increase the ability of two computers finding a common security method. The ISAKMP/Oakley service on each computer traverses the list of security methods in descending order until a common method is found. You can choose between preconfigured security methods or your own custom method:</p>

<ul>
<p><li><b>High.</b> The IP ESP provides confidentiality, integrity, authentication, and antireplay protection services.</li></p>

<p><li><b>Medium.</b> The IP AH security protocol provides integrity, authentication, and antireplay protection services. Confidentiality is not a part of AH.</li></p>

<p><li><b>Custom.</b> In addition to choosing between ESP and AH, expert users can specify the algorithms for authentication, integrity, and confidentiality.</li></p>
</ul>

<A NAME="223"><H3>Negotiation Policies</H3></A>

<p>A negotiation policy is a named collection of security methods. Each rule can have a single negotiation policy specified as currently active. If a common security method cannot be established between two computers, the negotiation policy can be configured to refuse communication with that computer or send the data in the clear (without encryption).</p>

<p>Because IPSec does not disturb the original IP header, it is considered normal IP traffic and is routed as such. This is also true for both transport and tunnel modes.</p>

<p><b>ESP and Routers</b></p>

<p>ESP neither encrypts nor authenticates the IP header, leaving it undisturbed. Even in tunnel mode, where the original IP header is encrypted, routing does not pose a problem. The new tunnel IP header (left undisturbed) is used to route between the tunnel endpoints. Once the packet reaches the tunnel destination endpoint, it is authenticated and decrypted. The original IP packet is forwarded without IPSec authentication or encryption to the final destination.</p>

<p><b>AH and Routers</b></p>

<p>AH uses all fields in the IP header to create the Integrity Check Value (ICV). Because routers modify fields in the IP header as they forward packets, this could cause problems; however, the fields that may be modified are set to zero for ICV calculation. Therefore, routers can change the mutable fields (Time to Live [TTL], checksum, and so on) without affecting the ICV calculation. At the receiving end, IPSec once again sets the mutable fields to zero for ICV calculation.</p>

<p>The same is true for tunnel mode, where the new tunnel IP header would be used to calculate the ICV, but the mutable fields would be set to zero. At the tunnel destination endpoint, the hash is verified and the original IP packet forwarded without further authentication.</p>

<A NAME="224"><H2>IPSec Through Firewalls</H2></A>

<p>Any routers or switches in the data path between the communicating hosts will simply forward the encrypted and/or authenticated IP packets to their destination. However, if there is a firewall or filtering router, IP forwarding must be enabled for the following IP protocols and UDP port:</p>

<ul>
<p><li><b>IP Protocol ID of 51.</b> Both inbound and outbound filters should be set to pass AH traffic.</li></p>

<p><li><b>IP Protocol ID of 50.</b> Both inbound and outbound filters should be set to pass ESP traffic.</li></p>

<p><li><b>UDP Port 500.</b> Both inbound and outbound filters should be set to pass ISAKMP traffic.</li></p>
</ul>

<p>Be aware that these settings would be used to allow IPSec traffic to pass through the firewall only when using transport mode, or if the firewall is on the public side of the tunnel server. IPSec cannot be used in such a way that the firewall would implement IPSec on all incoming or outgoing packets. The router would have to create and maintain all the SAs associated with each connection.</p>

<p><div class="note"><blockquote><b>NOTE</b><HR>
Traditional firewall filtering (filtering on TCP or UDP ports) cannot be done to ESP traffic, as the port numbers are encrypted.
</blockquote></div></p>

<A NAME="225"><H2>IPSec Through NAT and Proxies</H2></A>

<p>It is not possible to use IPSec through a NAT or application proxy. Even though the IP header is left intact, the encryption and authentication do not allow for other fields in the packet to be changed.</p>

<A NAME="226"><H3>NAT</H3></A>

<p>The following sections will discuss why IPSec does not work through NAT.</p>

<p><b>Inability to Distinguish Multiple IPSec Data Streams</b></p>

<p>The ESP header contains the Security Parameters Index (SPI). The SPI is used in conjunction with the destination IP address in the standard IP header and IPSec header to identify an IPSec SA.</p>

<p>For outbound traffic from the NAT gateway, the destination IP address is not changed, but the source IP address is. For inbound traffic to the NAT, the destination IP address must be mapped to a private IP address. For IPSec to work properly, the SPI would also have to be mapped. Although mapping the SPI could be done, it would require the SPI field to change. If the SPI field changes, the ICV calculation would not validate.</p>

<p>The same holds true for AH, where the SPI is part of the AH and is used in calculating the ICV.</p>

<p><b>Inability to Change TCP and UDP Checksums</b></p>

<p>The UDP and TCP headers contain a checksum that includes the source and destination IP address of the standard IP header. The addresses in the standard IP header cannot be changed without invalidating the checksum in the TCP and UDP headers. Therefore, NAT cannot update the UDP and TCP headers because they are within the encrypted portion of the ESP or have been used in the ICV calculation.</p>

<A NAME="227"><H3>Application Proxies</H3></A>

<p>Because application proxies operate at the application layer they would need to be IPSec-aware and have a security association for each IPSec client. This is obviously unreasonable and not provided by application proxies.</p>

<A NAME="228"><H2>Other IPSec Considerations</H2></A>

<p>In this section, you will learn about other IPSec configuration considerations. This includes secured communications with SNMP and running server services such as DNS and WINS.</p>

<A NAME="229"><H3>Securing SNMP</H3></A>

<p>All SNMP-enabled systems must be configured to use IPSec, or at a minimum, the IPSec policies must be configured to allow unsecured communications if all the SNMP-enabled hosts <i>cannot also</i> be IPSec-enabled. Otherwise, secured communication will fail and SNMP messages will not be exchanged.</p>

<p>IPSec does not automatically encrypt the SNMP protocol. The only exceptions are the predefined polices Secure Initiator and Lockdown, which have been configured to secure SNMP traffic as well. To secure SNMP, add two pairs of filter specifications to a new or existing policy on the SNMP-enabled host.</p>

<p>The first pair would be for typical SNMP traffic (SNMP messages) and would consist of one inbound and one outbound filter specification.</p>

<p><li><b>In the Addressing page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set the Source address to the IP address of the SNMP management system.</li></p>

<p><li>Set the Destination address to My IP Address, which will translate to the IP address of the host to which the policy is assigned (an SNMP agent).</li></p>

<p><li>Enable Mirrored to automatically create the outbound filter specification.</li></p>
</ol>

<p><li><b>In the Protocol page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set the Protocol Type to TCP or UDP (if both are required, create an additional filter specification).</li></p>

<p><li>Set From This Port and To This Port to 161.</li></p>
</ol>

<p>The second set of filter specifications would be for SNMP trap messages and would also consist of one inbound and one outbound filter specification.</p>

<p><li><b>In the Addressing page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set the Source address to the IP address of the SNMP management system.</li></p>

<p><li>Set the Destination address to My IP Address, which will translate to the IP address of the host to which the policy is assigned (an SNMP agent).</li></p>

<p><li>Enable Mirrored to automatically create the outbound filter specification.</li></p>
</ol>

<p><li><b>In the Protocol page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set the Protocol Type to TCP or UDP (if both are required, create an additional filter specification).</li></p>

<p><li>Set From This Port and To This Port to 162.</li></p>
</ol>

<p>The SNMP management system or console must also be IPSec-enabled. The SNMP service in Windows 2000 supports SNMP management software, but does not currently include SNMP management software. To secure SNMP traffic with IPSec, the third-party management software must be IPSec-capable.</p>

<A NAME="230"><H3>DHCP, DNS, WINS Servers, or Domain Controllers</H3></A>

<p>If enabling IPSec for any servers running these services, consider whether or not all their clients are IPSec-capable. Ensure that the policies, especially the authentication and negotiation settings, are compatible. Otherwise, secure negotiation might erroneously fail, and clients will not be able to access network resources.</p>

<p><b>When DNS Is Not IPSec-Enabled</b></p>

<p>To specify a host's DNS name in an IP Filter List specification (rather than the IP address) if DNS servers are not IPSec-enabled, a special policy setting is required. Otherwise, IPSec will not be able to successfully resolve the DNS host name to a valid IP address. The setting consists of a filter specification to exempt traffic between the host and the DNS server from requiring IPSec.</p>

<p>Add a filter specification to the applicable policy and rule.</p>

<p><li><b>In the Addressing page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set the Source address to My IP Address.</li></p>

<p><li>Set the Destination address to the IP address of the DNS server.</li></p>

<p><li>Enable Mirrored to automatically create the outbound filter specification.</li></p>
</ol>

<p><li><b>In the Protocol page of the IP Filter List dialog box</b></li></p>

<ol>
<p><li>Set From This Port and To This Port to 53. (This is the common port used by most DNS servers for communication; set this to whatever port the DNS service has been configured to for traffic use.)</li></p>
</ol>

<p>Additionally, the negotiation policy for this rule must be set to Do Not Allow Secure Communication: No security methods should be configured. This will ensure that DNS traffic is never secured with IPSec.</p>

<A NAME="231"><H2>TCP/IP Properties</H2></A>

<p>If a computer that is a member of a domain is disconnected from its domain, then a copy of the domain IPSec properties will be retrieved from the computer's registry. If the computer is not a member of a domain, a local IPSec policy will be stored in the registry. The TCP/IP properties allow the nondomain computer to always use IPSec, use IPSec only if possible, or never use IPSec.</p>

<p><div class="note"><blockquote><b>NOTE</b><HR>
If the computer is connected to a domain, these properties will not be configurable.
</blockquote></div></p>

<p>
<img src="images/practic.JPG" width=90 height=72 border="0">
</p>

<A NAME="232"><H2>Practice: Building a Custom IPSec Policy</H2></A>

<p>Several built-in policies have been defined to permit you to examine and investigate their behavior and configuration. However, most deployments of IPSec will require custom policies to be built. In this practice, you will build your own IPSec policy. You should perform this practice on both computers.</p>

<p><li><b>To build your own IPSec policy</b></li></p>

<ol>
<p><li>Using the Administrative Tools on the Start menu, run the Local Security Policy MMC plug-in.</li></p>

<p><li>In the left pane, right-click IP Security Policy On Local Machine.</li></p>

<p><li>From the pop-up menu, choose Create IP Security Policy.</li></p>

<p><li>When the wizard appears, click Next to continue.</li></p>

<p><li>Type the policy name <b>Two Computer Policy</b>, then click Next.</li></p>

<p><li>Accept the default for the Requests For Secure Connection screen by leaving the Default Response Rule check box checked, then click Next.</li></p>

<p><li>Accept the default response rule for Kerberos Authentication, then click Next.</li></p>

<p><li>Be sure to leave the Edit Properties check box checked.</li></p>

<p><li>Click Finish to complete the initial setup.</li></p>

<p><li>The Properties box appears. <i>Do not close it.</i></li></p>
</ol>

<p>At this point, you still have not configured your custom rule. Only the default response rule properties have been configured.</p>

<p>What is the purpose of the default response rule?</p>

<p><a href="chaaa.htm#648">Answer</a></p>

<p>For the remainder of this practice, you will not use the Add wizards when configuring IPSec policies. Instead, you will configure policies manually by navigating through the dialog boxes and property tabs.</p>

<p><li><b>To add a new rule</b></li></p>

<ol>
<p><li>At the bottom of the Properties dialog box, deactivate the Use Add Wizard check box.</li></p>

<p><li>In the Rules tab of the Property screen, click Add.</li></p>

<p><li>The New Rule Properties screen appears.</li></p>
</ol>

<p>You will be configuring filters between your computer and your second computer. You will need to configure an outbound filter specifying your IP address as the source address and your second computer's IP as the destination address. The mirror processing will then automatically configure an inbound filter specifying your second computer as the source address and your computer as the destination address.</p>

<p><li><b>To add a new filter</b></li></p>

<ol>
<p><li>Click the Add button.</li></p>
<p>The IP Filter List appears.</p>

<p><li>In the Name box, name the filter <b>Host A-Host B Filter</b>.</li></p>

<p><li>Deactivate the Use Add Wizard check box.</li></p>

<p><li>Click the Add button in the IP Filter List tab.</li></p>

<p><li>The Filter Properties box appears.</li></p>

<p><li>Change Source Address to a specific IP address.</li></p>

<p><li>Add your IP (<i>w.x.y.z</i>) address.</li></p>

<p><li>Change Destination Address to a specific IP address.</li></p>

<p><li>Add your second computer's IP (<i>w.x.y.z</i>) address.</li></p>

<p><li>Click OK and verify that your filter has been added in the Filters box of the IP Filter List dialog box.</li></p>

<p><li>Click Close.</li></p>

<p><li>In the IP Filter List tab, activate your filter by clicking the radio button next to the filter list you just added.</li></p>
</ol>

<p>In the preceding procedure, you configured input and output filters for matching communication packets. In this procedure, you will configure the actions to take on the filtered packets.</p>

<p><li><b>To specify a filter action</b></li></p>

<ol>
<p><li>Click the Filter Action tab and deactivate the Use Add Wizard check box.</li></p>

<p><li>Click the Add button to create a filter action.</li></p>

<p><li>In the Security Methods tab, ensure Negotiate Security is selected.</li></p>

<p><li>Verify that Allow Unsecured Communication With Non IPSEC Aware Computer is not selected.</li></p>

<p><li>Click Add to choose a security method.</li></p>

<p><li>Select Medium (AH) and click OK.</li></p>

<p><li>Click OK to close the New Filter Action Properties dialog box.</li></p>

<p><li>Click the radio button next to the filter you just created to activate it.</li></p>
</ol>

<p>In this procedure, you will specify how the two computers will trust each other by specifying the authentication method to use when attempting to establish an SA. In this procedure, you will use a preshared key. This is a word or phrase that both computers must know to be trusted by one another. Both sides of the IPSec communication must know this value. It is not used to encrypt application data. Rather, it is used during negotiation to establish whether or not the two computers will trust one another.</p>

<p><li><b>To set authentication method</b></li></p>

<ol>
<p><li>Click the Authentication Methods tab.</li></p>

<p><li>Click Add.</li></p>

<p><li>Click the Pre-Shared Key radio button.</li></p>

<p><li>Type a preshared key or password in the text box and click OK.</li></p>

<p><li>Choose Pre-Shared Key in the list and click Move Up so it appears first in the list.</li></p>
</ol>

<p><li><b>To verify tunnel settings</b></li></p>

<ol>
<p><li>Click the Tunnel Setting tab.</li></p>

<p><li>Verify that This Rule Does Not Specify An IPSEC Tunnel is selected.</li></p>
</ol>

<p><li><b>To verify connection type settings</b></li></p>

<ol>
<p><li>Click the Connection Type tab.</li></p>

<p><li>Verify that All Network Connections is selected.</li></p>
</ol>

<p><li><b>To complete rule creation</b></li></p>

<ol>
<p><li>Click Close to return to Policy Properties and complete the creation of this rule.</li></p>

<p><li>Verify that This New Rule is selected in the list box.</li></p>

<p><li>Close Policy Properties.</li></p>
</ol>

<p><li><b>To activate the new policy</b></li></p>

<ol>
<p><li>In the right pane of the MMC, right-click the Two Computer Policy you just created.</li></p>

<p><li>Click Assign.</li></p>

<p><li>The Policy Assigned column value should now be Yes.</li></p>
</ol>

<p><li><b>To test IPSec</b></li></p>

<ol>
<p><li>Enable the policy on your computer and your second computer.</li></p>

<p><li>PING your second computer.</li></p>

<p><li>The first PING after enabling the policy will usually fail due to the time it takes to negotiate policy.</li></p>

<p><li>With matching policies active on both computers, future PINGs will work.</li></p>

<p><li>Alternatively, enable and disable the policy on your computer and your second computer to see the effects of nonmatching policy settings.</li></p>
</ol>

<A NAME="233"><H2>Lesson Summary</H2></A>

<p>IPSec is very easy to customize with policies and rules. In this lesson, we learned how to secure a network using these various methods and taking into consideration such things as proxies, NAT, SNMP, DHCP, DNS, WINS, and domain controllers.</p>

</BODY>
</HTML>





