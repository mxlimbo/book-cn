<HTML>
<HEAD>
<TITLE>Lesson 4: Virtual Private Networks</TITLE>
<link rel="STYLESHEET" type="text/css" href="mmserver.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch10d.htm", "ch10f.htm", "images/unit_p_a1.gif", "images/unit_p_a2.gif", "images/unit_p_b1.gif", "images/unit_p_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#aa22aa", "2");
//--></SCRIPT><P>

<A NAME="555"><h1>Lesson 4: Virtual Private Networks</h1></A>
<p>A virtual private network (VPN) is an extension of the private network that encompasses encapsulated, encrypted, and authenticated links across shared or public networks. A VPN mimics the properties of a dedicated private network, allowing data to be transferred between two computers across an internetwork, such as the Internet. Point-to-point connections can be simulated through the use of tunneling, and LAN connectivity can be simulated through the use of virtual LANs (VLANs). This lesson introduces you to VPNs and tunneling basics. It explains how to manage the RAS server for VPNs and covers how to troubleshoot common VPN problems.</p>

<p>
<div class="sidebar"><blockquote>
<b>After this lesson, you will be able to</b> 

<ul>
<p><li>Describe the basic characteristics of VPNs and tunneling, including the most common tunneling protocols</li></p>

<p><li>Manage VPN servers</li></p>

<p><li>Troubleshoot VPNs</li></p>
</ul>

<b>Estimated lesson time: 45 minutes</b> 
</blockquote></div>
</p>

<A NAME="556"><h2>Introduction to Virtual Private Networks</h2></A>
<p>VPNs allow users working at home or on the road to connect securely to a remote corporate server by using the routing infrastructure provided by a public internetwork such as the Internet. From the user's perspective, the VPN is a point-to-point connection between the user's computer and a corporate server. The nature of the internetwork is irrelevant because it appears as if the data is being sent over a dedicated private link.</p>

<p>VPN technology also allows a corporation to connect with its branch offices or with other companies over a public internetwork while maintaining secure communications. A VPN connection across the Internet logically operates as a dedicated WAN link.</p>

<p>The secure connection across the internetwork appears to the user as a virtual network interface providing private network communication over a public internetwork. Rather than having a remote user make a long distance call (or toll free call) to a corporate or outsourced NAS, the user calls the local ISP. Using the connection to the local ISP, a VPN is created between the dial-up user and the corporate VPN server across the Internet.</p>

<p>
<img src="images/cd.JPG" border="0">
</p>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
For more information about virtual private networking, see the Supplemental Course Materials CD-ROM (\chapt10\articles\VPNoverview.doc) that accompanies this book.</blockquote></div>
</p>

<A NAME="557"><h3>Connecting Networks over the Internet</h3></A>
<p>When connecting to networks over the Internet, branch offices can use either dedicated lines or dial-up lines.</p>

<p><b>Dedicated Lines</b></p>

<p>Rather than using an expensive long-haul dedicated circuit between the branch office and the corporate hub, both the branch office and the corporate hub routers connect to the Internet through the use of a local dedicated circuit and local ISP. Utilizing the local ISP connections, a VPN is created between the branch office router and corporate hub router across the Internet.</p>

<p><b>Dial-Up Lines</b></p>

<p>Rather than having a router at the branch office make a long distance call to a corporate or outsourced Network Access Server (NAS), the router at the branch office calls its local ISP. From the connection to the local ISP, a VPN is created between the branch office router to the corporate hub router across the Internet. The corporate hub router, acting as a VPN server, must be connected to a local ISP via a dedicated line. The VPN server must be listening 24 hours a day for incoming VPN traffic.</p>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
Whether the branch offices use dedicated lines or dial-up lines, the transfer of data through the VPN is distance insensitive since only local physical links are being used.</blockquote></div>
</p>

<A NAME="558"><h3>Connecting Computers over an Intranet</h3></A>
<p>In some corporate internetworks, the data of certain departments is so sensitive that the department's LAN is physically disconnected from the rest of the corporate internetwork. While this protects the department's data, it also creates information accessibility problems for users that are not physically connected to the separate LAN.</p>

<p>VPNs allow the department's LAN to be physically connected to the corporate internetwork but separated by a VPN server. Note that the VPN server is not acting as a router between the corporate internetwork and the department LAN. Users on the corporate internetwork who have the appropriate credentials (based on a need-to-know policy within the company) can establish a VPN with the VPN server and gain access to the protected resources of the department. Additionally, all communication across the VPN can be encrypted for confidentiality. For users without proper credentials, the department LAN is essentially hidden from view.</p>

<A NAME="559"><h2>Tunneling Basics</h2></A>
<p><i>Tunneling</i>, also known as encapsulation, is a method of using an internetwork infrastructure to transfer a payload. The payload may be the frames (or packets) of another protocol. Instead of sending the frame as produced by the originating node, the frame is encapsulated with an additional header. The additional header provides routing information so that the encapsulated payload can traverse the intermediate internetwork. The encapsulated packets are then routed between tunnel endpoints over the transit internetwork. Once the encapsulated frames reach their destination on the transit internetwork, the frame is de-encapsulated and forwarded to its final destination.</p>

<p>This entire process (the encapsulation and transmission of packets) is known as tunneling. The logical path through which the encapsulated packets travel the transit internetwork is called a <i>tunnel</i>.</p>

<A NAME="560"><h3>Tunnel Maintenance and Data Transfer</h3></A>
<p>The collective functionality of a tunnel maintenance protocol and tunnel data transfer protocol is known as a tunneling protocol. In order for a tunnel to be established, both the tunnel client and the tunnel server must be using the same tunneling protocol. Examples of tunneling protocols are PPTP and L2TP, which are discussed in more detail later in this lesson.</p>

<p><b>Tunnel Maintenance Protocol</b></p>

<p>A tunnel maintenance protocol is used as the mechanism to manage the tunnel. For some tunneling technologies, such as PPTP and L2TP, a tunnel is similar to a session: both endpoints of the tunnel must agree to the tunnel and be aware of its presence. However, unlike a session, a tunnel does not guarantee reliable data delivery. Data transferred across the tunnel is typically sent by a datagram-based protocol such as UDP when L2TP is used or TCP for tunnel management and a modified Generic Routing Encapsulation (GRE) protocol when PPTP is used.</p>

<p><b>Creating the Tunnel</b></p>

<p>A tunnel must be created before data transfer occurs. The tunnel creation is initiated by one end of the tunnel, the tunnel client. At the other end of the tunnel the tunnel server receives the connection request.</p>

<p>To create the tunnel, a connection creation process similar to a PPP connection is performed. The tunnel server requests that the tunnel client authenticate itself. Once validated by the tunnel server, the tunnel connection is granted and data transfer across the tunnel can begin.</p>

<p>Tunnel creation messages are sent by the tunnel client to the internetwork address of the tunnel server. Using the Internet as an example, the tunnel client sends tunnel creation messages from its InterNIC-compliant IP address to the InterNIC-compliant address of the tunnel server on the Internet. If the tunnel client is a dial-up Internet user, the tunnel client uses the IP address as allocated by the ISP as a source IP address and the IP address of the tunnel server as the destination IP address.</p>

<p><b>Maintaining the Tunnel</b></p>

<p>For some tunneling technologies, such PPTP and L2TP, once the tunnel has been created, it must be maintained. Both ends of the tunnel must be aware of the state of the other end of the tunnel in case of a connection fault. Tunnel maintenance is typically performed through a keep-alive process that periodically polls the other end of the tunnel when no data is being transferred.</p>

<p><b>Terminating the Tunnel</b></p>

<p>Certain tunneling technologies allow either end of the tunnel to gracefully terminate the tunnel through an exchange of tunnel termination messages.</p>

<p><b>Tunnel Data Transfer Protocol</b></p>

<p>Once the tunnel is established, tunneled data can be sent. A tunnel data transfer protocol encapsulates the data to be transferred across the tunnel. When the tunnel client sends a tunneled payload to the tunnel server, the tunnel client appends a tunnel data transfer protocol header onto the payload. The resulting encapsulated payload is sent across the transit internetwork and routed to the tunnel server.</p>

<p>The tunnel server accepts the packets, removes the tunnel data transfer protocol header, and forwards the payload appropriately. Information sent between the tunnel server and the tunnel client behaves similarly.</p>

<A NAME="561"><h3>Tunnel Types</h3></A>
<p>There are two basic types of tunnels: voluntary tunnels and compulsory tunnels. Depending upon the client configuration, compulsory tunnels consist of either static or dynamic compulsory tunnels.</p>

<p><b>Voluntary Tunnels</b></p>

<p>Voluntary tunnels are configured and created through a conscious action by the user at the tunnel client computer. The user's computer is a tunnel endpoint and acts as the tunnel client.</p>

<p>Voluntary tunneling occurs when the client workstation volunteers to create the tunnel to the target tunnel server. Since the client is acting as a tunnel client, the appropriate tunneling protocol must be installed on the client computer. Voluntary tunneling can occur in either of the following cases:</p>

<ul>
<p><li>The client already has a connection to the transit internetwork that can provide routing of encapsulated payloads between the client computer and its chosen tunnel server.</li></p>

<p><li>The client may have to establish a connection (via dial-up) to the transit internetwork before the client can set up a tunnel. This is the more common case. The best example of this case is the dial-up Internet user. Internet users must dial their ISP and obtain an Internet connection before a tunnel over the Internet can be created.</li></p>
</ul>

<p><b>Compulsory Tunnels</b></p>

<p>Compulsory tunnels are configured and created automatically for users without their knowledge or intervention. With compulsory tunnels, the user's computer is not a tunnel endpoint. Another device between the user's computer and the tunnel server is the tunnel endpoint and acts as the tunnel client.</p>

<p>If a client computer does not have a tunneling protocol installed and tunneling is still desired, then it is possible for another computer or network device to create the tunnel on the client computer's behalf. This is a functionality referred to as <i>access concentrator</i>. In order to carry out its function, the access concentrator must have the appropriate tunneling protocol installed and be capable of establishing the tunnel when the client computer connects.</p>

<p>When connecting through the Internet, the client computer calls a tunneling-enabled NAS at the ISP. For example, a corporation may have contracted with an ISP to assemble a nationwide set of access concentrators. These access concentrators can establish tunnels across the Internet to a tunnel server connected to the corporation's private network. This configuration is known as compulsory tunneling because the client is compelled to use the tunnel created by the access concentrator. Once the initial connection is made, all network traffic to and from the client is automatically sent through the tunnel.</p>

<p>With compulsory tunneling, the client computer makes a single PPP connection, and when a client dials into the NAS, a tunnel is created and all traffic is automatically routed through the tunnel.</p>

<p>The decision by the access concentrator to tunnel a dial-up client to a specific tunnel server can be based on statically configured information at the access concentrator or by dynamically consulting a user database.</p>

<p><b>Static Compulsory Tunnels</b></p>

<p>Static tunnel configurations typically require either dedicated equipment (automatic tunnels) or manual configuration (realm-based tunnels).</p>

<p>Automatic tunneling is where all dial-in clients to the access concentrator are automatically tunneled to a specific tunnel server. This requires dedicated local access lines and network access equipment, with its associated costs. For example, users might be required to call a specific telephone number in order to connect to an access concentrator that automatically tunnels all connections to a particular tunnel server.</p>

<p>In realm-based tunneling schemes, the access concentrator examines a portion of the user's name (called a realm) to decide where to tunnel the traffic associated with that user. For example, users in the microsoft.com realm (logging on as user@microsoft.com) would be tunneled to one destination, while users in the domain.com realm (logging on as user@domain.com) would be tunneled elsewhere. Realm-based tunneling is relatively simple to implement, does not require dedicated equipment, and has low overhead after initial configuration. However, configuration changes may be expensive and time-consuming. In addition, all traffic for all users of the same realm is tunneled to the same destination. Realm-based tunneling does not allow any further granularity of tunnel server designation.</p>

<p><b>Dynamic Compulsory Tunnels</b></p>

<p>With dynamic compulsory tunneling, the choice of tunnel destination is made on a per-user basis at the time the user connects to the access concentrator. Users from the same realm may be tunneled to different destinations depending upon parameters such as user name, called or calling phone number, department, location, and even the time of day. Dynamic tunnels offer the greatest flexibility of any compulsory tunneling scheme.</p>

<p>Dynamic tunneling also permits the access concentrator to be a multi-use
NAS, allowing the connection of tunneling clients and ordinary (non-tunneled) Internet clients. A dedicated access concentrator or telephone line is not required. In order for the access concentrator to determine whether or not
to tunnel a particular dial-up client, it must consult a database.</p>

<p>While each access concentrator can store its own database of user information, this solution does not scale well administratively. A better solution is to store the user information in a centrally administered location and have the access concentrator consult the central database as needed (when dial-up clients call). RADIUS, for example, can provide this type of solution.</p>

<A NAME="562"><h2>VPN Protocols</h2></A>
<p>The primary protocols used by Windows 2000 for VPN access are PPTP, L2TP, IPSEC, and IP-IP. These protocols may work together or independently of each other.</p>

<A NAME="563"><h3>PPTP</h3></A>
<p>Point-to-Point Tunneling Protocol (PPTP), an extension of PPP, encapsulates PPP frames into IP datagrams for transmission over an IP internetwork such as the Internet. PPTP can also be used in private LAN-to-LAN networking.</p>

<p>PPTP uses a TCP connection for tunnel maintenance and uses modified GRE encapsulated PPP frames for tunneled data. The payloads of the encapsulated PPP frames can be encrypted and compressed.</p>

<p>PPTP was created by the PPTP forum consisting of Microsoft Corporation, Ascend Communications, 3COM, ECI Telematics, and US Robotics.</p>

<p>PPTP tunnels must be authenticated by using the same authentication mechanisms as PPP connections (PAP, MS-CHAP, CHAP, and EAP). PPTP inherits encryption and compression of PPP payloads from PPP. In Windows 2000, PPP encryption can be used only when the authentication protocol is EAP-TLS or MSCHAP. PPP encryption provides confidentiality between the endpoints of the tunnel only. If stronger security or end-to-end security is needed, IPSEC can be used. Figure 10.14 shows a fully constructed PPTP packet.</p>

<p>
<A HREF="javascript:fullSize('f10xx14gx.htm')"> <img src="images/f10xx14g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 10.14</b> <i>PPTP packet showing the encrypted data being sent, including header and trailer information</i><!--/caption-->
</p>

<A NAME="564"><h3>L2TP</h3></A>
<p>Layer 2 Tunneling Protocol (L2TP) is a combination of PPTP and Layer 2 Forwarding (L2F), a technology proposed by Cisco Corporation. L2TP is a hybrid of the best features in PPTP and L2F.</p>

<p>L2TP is a network protocol that encapsulates PPP frames to be sent over IP, X.25, Frame Relay, or ATM networks. When utilizing IP as its datagram transport, L2TP can be used as a tunneling protocol over the Internet. L2TP can also be used in private LAN-to-LAN networking.</p>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
L2TP in Windows 2000 runs only over an IP network. It does not run in Native mode over X.25, Frame Relay, or ATM networks.</blockquote></div>
</p>

<p>L2TP uses UDP and a series of L2TP messages for tunnel maintenance. L2TP also uses UDP to send L2TP-encapsulated PPP frames as the tunneled data. The payloads of encapsulated PPP frames can be both encrypted and compressed. Microsoft chose IPSec instead of PPP encryption for L2TP. However, it is possible for other implementations of L2TP to use PPP encryption. Figure 10.15 shows an L2TP packet prepared to be sent using IPSec authentication and encryption settings over a point-to-point WAN connection, such as a dial-up line. The processing steps are shown in the figure. Steps 1-4 show normal processing prior to IPSec encapsulation. Steps 5-7 show IPSec processing. The remaining steps are necessary in order to send the packet on the network to its final destination.</p>

<p>
<A HREF="javascript:fullSize('f10xx15gx.htm')"> <img src="images/f10xx15g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 10.15</b> <i>L2TP packet showing encrypted data with IPSec authentication, an additional IP header, and data-link header and trailer information</i><!--/caption-->
</p>

<p>L2TP is very similar to PPTP in function. An L2TP tunnel is created between an L2TP client and an L2TP server. The client may already be attached to an IP internetwork (such as a LAN) that can reach the tunnel server, or a client may have to dial into a NAS to establish IP connectivity (for dial-up Internet users).</p>

<p>Creation of L2TP tunnels must be authenticated by using the same authentication mechanisms as PPP connections (PAP, MS-CHAP, CHAP, and EAP). L2TP inherits PPP compression but not encryption. PPP encryption is not used because it does not meet the security requirements of L2TP. PPP encryption could provide confidentiality but would not provide per packet authentication, integrity, or replay protection. Data encryption is provided by IPSec. Using PPP connection encryption with an IPSec encrypted payload, increases processing overhead with little to no added benefit.</p>

<A NAME="565"><h3>PPTP versus L2TP</h3></A>
<p>Both PPTP and L2TP use PPP for point-to-point WAN connections, to provide an initial envelope for the data and then append additional headers for transport through the transit internetwork. However, there are some differences between PPTP and L2TP:</p>

<ul>
<p><li>PPTP requires that the transit internetwork be an IP internetwork. L2TP requires only that the tunnel media provide packet oriented point-to-point connectivity. L2TP can be run over IP (using UDP), Frame Relay PVCs, X.25 VCs or ATM VCs.</li></p>

<p><li>L2TP provides header compression capability. When header compression is enabled, L2TP operates with 4 bytes of overhead, compared to 6 bytes for PPTP.</li></p>

<p><li>L2TP also provides tunnel authentication, while PPTP does not. However, when either PPTP or L2TP is run over IPSec, it provides tunnel authentication, making Layer 2 tunnel authentication unnecessary.</li></p>

<p><li>PPTP uses PPP encryption and L2TP does not. Microsoft's L2TP requires IPSec for encryption.</li></p>
</ul>

<A NAME="566"><h3>IPSec</h3></A>
<p>IPSec, a layer 3 tunneling protocol, is a series of standards that support the secured transfer of information across an IP internetwork. IPSec Encapsulating Security Payload (ESP) Tunnel mode supports the encapsulation and encryption of entire IP datagrams for secure transfer across a private or public IP internetwork.</p>

<p>With IPSec ESP Tunnel mode, a complete IP datagram is encapsulated and encrypted with ESP. The result is then encapsulated&#8212;using a plaintext IP header&#8212;and sent on the transit internetwork (Figure 10.15).</p>

<p>Upon receipt of the encrypted datagram, the tunnel server processes and discards the clear text IP header and authenticates and decrypts the ESP and IP packet. The IP packet is then processed normally. Normal processing may include routing the packet to its final destination.</p>

<p><b>ESP Tunnel Mode versus Transport Mode</b></p>

<p>The main difference between ESP Tunnel mode and ESP Transport mode is the former has an encapsulated IP header. Because of this IP header, when the packet exits the tunnel (IPSec encapsulation and encryption is removed) it can be routed to its final destination. By using ESP Transport mode, the packet is always decrypted by the time it reaches its final destination.</p>

<p><b>IPSec ESP Tunnel Mode Packet Structure</b></p>

<p>IPSec ESP Tunnel mode is performed through multiple layers of encapsulation. Figure 10.15 refers to these steps:</p>

<ul>
<p><li><b>First Layer of Encapsulation</b> The initial IP datagram is appended with an ESP trailer and then encrypted (step 5 in Figure 10.15).</li></p>

<p><li><b>Second Layer of Encapsulation</b> The encrypted payload is encapsulated with an ESP header and an ESP Authentication trailer. The ESP Authentication trailer contains the Integrity Check Value (ICV), a cryptographic checksum that is used to authenticate and verify the integrity of the payload (steps 6 and 7).</li></p>

<p><li><b>Third Layer of Encapsulation</b> The IPSec packet is encapsulated with a final IP header containing the source and destination IP addresses of the tunnel endpoints (step 8).</li></p>

<p><li><b>Data Link Layer of Encapsulation</b> To be sent on a LAN or WAN link, the IP datagram is finally encapsulated with a header and trailer for the data link layer technology of the outgoing physical interface (steps 9 and 10).</li></p>
</ul>

<p>IPSec Tunnel mode is an OSI layer 3 (network layer) tunneling technique. Unlike L2TP and PPTP, IPSec Tunnel mode does not rely on PPP for authentication or security. In addition, it cannot be used as a Windows 2000 Router interface as IPIP can. Because IPSec Tunnel mode cannot be a router interface, it cannot support routing protocols or dial on demand. Instead, IPSec Tunnel mode can be used based on packet filters for each route. The packet filters define the IPSec tunnel destination.</p>

<A NAME="567"><h3>IP-IP</h3></A>
<p>IP-IP, or IP in IP, is a simple OSI layer 3 (network layer) tunneling technique. A virtual network is created by encapsulating an IP packet with an additional IP header. The primary use of IP-IP is for tunneling multicast traffic over sections of a network that does not support multicast routing. The IP-IP packet structure consists of the outer IP header, the tunnel header, the inner IP header, and the IP payload.</p>

<p>The IP payload includes everything above IP. This could be TCP, UDP, or ICMP headers, and data. A limited form of tunnel maintenance is achieved by using standard ICMP messages. ICMP messages allow the tunnel to do tunnel MTU discovery and detect congestion and routing failures.</p>

<A NAME="568"><h2>Managing Virtual Private Networking</h2></A>
<p>In <a href="ch10d.htm">lesson 3</a>, you learned how to manage remote access. In many ways, the management of VPNs is similar to managing remote access. Virtual private networking must be managed just like any other network resource, and VPN security issues must be managed carefully, particularly with Internet VPN connections.</p>

<A NAME="569"><h3>Managing Users</h3></A>
<p>Because it is not practical to have separate user accounts on separate servers for the same user, most administrators set up a master account database at a domain controller or on a RADIUS server. This allows the VPN server to send the authentication credentials to a central authenticating device. The same user account is used for both dial-in remote access and VPN-based remote access.</p>

<A NAME="570"><h3>Managing Addresses and Name Servers</h3></A>
<p>The VPN server must have IP addresses available in order to assign them to the VPN server's virtual interface and to VPN clients during the IP Control Protocol (IPCP) negotiation phase of the connection process. The IP address assigned to the VPN client is assigned to the virtual interface of the VPN client.</p>

<p>For Windows 2000-based VPN servers, the IP addresses assigned to VPN clients are obtained through DHCP by default. You can also configure a static IP address pool. The VPN server must also be configured with name resolution servers, typically DNS and WINS server addresses, to assign to the VPN client during IPCP negotiation.</p>

<A NAME="571"><h3>Managing Access</h3></A>
<p>For Windows 2000, configure the dial-in properties on user accounts and remote access policies to manage access for dial-up networking and VPN connections.</p>

<p><b>Access by User Account</b></p>

<p>If you are managing remote access on a user basis, select the Allow Access radio button on the Dial-In tab of the user's Properties dialog box for those user accounts that are allowed to create VPN connections. If the VPN server is allowing only VPN connections, delete the default remote access policy called Allow Access If Dial-In Permission Is Enabled. Then create a new remote access policy with a descriptive name, such as VPN Access If Allowed By User Account.</p>

<p>
<div class="caution"><blockquote><b>CAUTION</b><hr>
After deleting the default policy, a dial-up client that does not match at least one of the policy configurations you create will be denied access.</blockquote></div>
</p>

<p>If the VPN server is also allowing dial-up remote access services, do not delete the default policy, but move it so that it is the last policy to be evaluated.</p>

<p><b>Access by Group Membership</b></p>

<p>If you are managing remote access on a group basis, select the Control access through remote access policy radio button on all user accounts. Create a Windows 2000 group with members who are allowed to create VPN connections. If the VPN server allows only VPN connections, delete the default remote access policy called Allow Access If Dial-In Permission Is Enabled. Next, create a new remote access policy with a descriptive name such as VPN Access If Member Of VPN-Allowed Group, and then assign the Windows 2000 group to the policy.</p>

<p>If the VPN server also allows dial-up networking remote access services, do not delete the default policy; instead move it so that it is the last policy to be evaluated.</p>

<A NAME="572"><h3>Managing Authentication</h3></A>
<p>The VPN server can be configured to use either Windows or RADIUS as an authentication provider. If Windows is selected as the authentication provider, the user credentials sent by users attempting VPN connections are authenticated using Windows authentication mechanisms and remote access policy configured through the Routing And Remote Access snap-in.</p>

<p>If RADIUS is selected and configured as the authentication provider on the VPN server, user credentials and parameters of the connection request are sent as a series of RADIUS request messages to a RADIUS server.</p>

<p>The RADIUS server receives a user-connection request from the VPN server and authenticates the user by using its authentication database. A RADIUS server can also maintain a central storage database of other relevant user properties. In addition to a yes or no response to an authentication request, RADIUS can inform the VPN server of other applicable connection profile data for users, such as maximum session time, static IP address assignment, and so on. An IAS RADIUS server stores remote access profile information for clients that use the RADIUS server as the authentication provider. If RADIUS authentication is configured for a RAS server, the Remote Access Policies node disappears from the Routing And Remote Access snap-in console tree; remote access policy is then configured in IAS.</p>

<p>RADIUS can respond to authentication requests based on its own database, or it can be a front end to another database server, such as a generic Open Database Connectivity (ODBC) server or a Windows 2000 domain controller. The latter can be located on the same computer as the RADIUS server, or elsewhere. In addition, a RADIUS server can act as a proxy client to a remote RADIUS server.</p>

<A NAME="573"><h2>Troubleshooting</h2></A>
<p>Troubleshooting VPNs is a combination of troubleshooting IP connectivity, remote access connection establishment, routing, and IPSec. A firm understanding of all of these topics is required.</p>

<p>The following sections outline common VPN problems and the troubleshooting tools provided with Windows 2000. VPN problems typically fall into the following categories:</p>

<ul>
<p><li>Connection attempt is rejected when it should be accepted.</li></p>

<p><li>Connection attempt is accepted when it should be rejected.</li></p>

<p><li>Unable to reach locations beyond the VPN server.</li></p>

<p><li>Unable to establish a tunnel.</li></p>
</ul>

<A NAME="574"><h3>Connection Attempt is Rejected When it Should Be Accepted</h3></A>
<p>Verify the following information in order to troubleshoot this problem:</p>

<ul>
<p><li>Verify that the host name or IP address of the VPN server is reachable by using the ping command. If a host name is being used, verify that it is resolved to its correct IP address.</li></p>

<p><li>Verify that RRAS is running on the VPN server.</li></p>

<p><li>Verify that all of the PPTP or L2TP ports on the VPN server are not already being used. If necessary, change the number of PPTP to L2TP ports to allow more concurrent connections. Ports are added and configured from the Ports node in the Routing And Remote Access snap-in.</li></p>

<p><li>Verify that the tunneling protocol of the VPN client is supported by the VPN server. You can do this by checking the Port Properties on the RAS server.</li></p>


<p><li>Remote access VPN clients are set to the Automatic server type by default, which means that they will try to establish a PPTP tunnel first, then try an L2TP over IPSec tunnel. If the server type is set to either Point-to-Point Tunneling Protocol (PPTP) or Layer 2 Tunneling Protocol (L2TP), verify that the selected tunneling protocol is supported by the VPN server.</li></p>

<p><li>A Windows 2000 computer running RRAS is a PPTP and L2TP server with five L2TP ports and five PPTP ports by default (appearing in the details pane of the Ports node in the Routing And Remote Access snap-in). To create a PPTP-only server, set the number of L2TP ports to 0.</li></p>

<p>To create an L2TP-only server, set the number of PPTP ports to 1, because the number of PPTP ports cannot be set to 0, and then clear the Remote Access Connection (Inbound Only) and the Demand Dial Routing Connections (Inbound And Outbound) check boxes. These settings are configured from the properties of the Ports node. On the client computer, change the type of VPN server from automatic to Layer-2 Tunneling Protocol (L2TP).</p>

<p><li>Verify that the VPN client and the VPN server are enabled to use at least one common authentication method.</li></p>

<p><li>For PPTP connections, test whether a PPTP connection can be made without encryption. If so, check the encryption settings on the VPN client and VPN server.</li></p>

<p><li>For L2TP over IPSec connections, test whether a L2TP connection can be made without encryption (without IPSec). If so, check the L2TP over IPSec encryption settings on the VPN client and VPN server.</li></p>


<p>To disable IPSec on the client computer, access the properties of the VPN connection. Click the Networking tab and then access the properties of Internet Protocol (TCP/IP). Next, click the Advanced button and then the Options tab. Finally, access the properties of the IP Security option. From the IP Security dialog box, you can configure the client to not use IPSEC.</p>

<p>To disable IPSec on the server, access the properties of the local area network adapter. From there, access the properties of Internet Protocol (TCP/IP) and then follow the navigation procedure outlined for the client connection. This procedure can also be followed for the client computer if the client computer contains a Local Area Connection option in the Network And Dial-up Connections window.</p>


<p><li>Verify that the parameters of the connection have permission through remote access policies. Remote access policy is configured through the Routing And Remote Access snap-in or through the RADIUS server, depending on the authentication provider.</li></p>
</ul>

<p>In order for the connection to be established, the parameters of the connection attempt must meet the following conditions:</p>
<ul>
<p><li>Match all of the conditions of at least one remote access policy.</li></p>

<p><li>Be granted remote access permission either through the remote access permission of the user object (set to Allow Access) or through a combination of the user object settings and remote access policy. In the latter case, the Control Access Through Remote Access Policy option in the User Object properties is selected and the Grant Remote Access Permission option is selected in the properties of the remote access policy.</li></p>

<p><li>Match all the settings of the profile.</li></p>

<p><li>Match all the settings of the dial-in properties of the user object. Verify that the settings of the remote access policy profile are not in conflict with properties of the routing and remote access server.</li></p>
</ul>

<p>If the settings of the profile of the matching remote access policy are in conflict with the settings of the VPN server, the connection attempt is rejected. For example, if the matching remote access policy profile specifies that the EAP-TLS authentication protocol must be used and EAP-TLS is not enabled on the VPN server, the VPN server rejects the connection attempt.</p>
<ul>
<p><li>Verify that the VPN client's credentials consisting of user name, password, and domain name are correct and can be validated by the VPN server.</li></p>

<p><li>If the VPN server is configured with a static IP address pool, verify that there are enough addresses in the pool. If all the addresses in the static pool have been allocated to connected VPN clients, the VPN server is unable to allocate an IP address and the connection attempt is rejected.</li></p>

<p><li>Verify the configuration of the authentication provider. For a VPN server that is a member server in a mixed or native Windows 2000 domain configured for Windows NT authentication, verify that the machine account of the VPN server computer is a member of the RAS and IAS Servers security group.</li></p>

<p><li>For remote access VPN connections, verify that remote access is enabled on the VPN server.</li></p>

<p><li>For remote access VPN connections, verify that the PPTP and/or L2TP ports are enabled for inbound remote access requests.</li></p>

<p><li>For remote client VPNs, verify that the LAN protocols used by the VPN client are enabled for remote access.</li></p>

<p><li>For router-to-router VPN connections, verify that routing is enabled and LAN and demand-dial routing is selected on the VPN server. This option can be configured from the General tab of the RRAS server's Properties dialog box.</li></p>

<p><li>For router-to-router VPN connections, verify that the PPTP and L2TP ports are enabled for inbound and outbound demand-dial routing connections. This option can be configured from the properties of the Ports node.</li></p>
</ul>

<A NAME="575"><h3>Connection Attempt is Accepted When it Should Be Rejected</h3></A>
<p>Verify that the parameters of the connection do not have permission through remote access policies.</p>

<p>In order for the connection to be rejected, the parameters of the connection attempt must be denied remote access permission through one of the following methods:</p>

<ul>
<p><li>The remote access permission of the user object is set to Deny Access.</li></p>

<p><li>The remote access permission of the user object is set to Control Access Through Remote Access Policy and the first remote access policy that matches the parameters of the connection attempt is set to Deny Remote Access Permission.</li></p>
</ul>

<A NAME="576"><h3>Unable to Reach Locations beyond the VPN Server</h3></A>
<p>Verify the following information in order to troubleshoot this problem:</p>

<ul>
<p><li>For remote client VPNs, verify that the Entire network option is selected for LAN protocols being used by the VPN clients.</li></p>

<p><li>Verify the IP address pool of the VPN server.</li></p>
<ul>
<p><li>If the VPN server is configured to use a static IP address pool, verify that the route to the range of addresses defined by the static IP address pool is reachable by the hosts and routers of the intranet. If not, an IP route consisting of the VPN server static IP address pool (IP Address, Subnet Mask) must be added to the routers of the intranet. If the route is not added, remote access clients will not receive traffic from resources on the intranet. A route for the network can be implemented through static routing entries or through a routing protocol such as RIP or OSPF.</li></p>

<p><li>If the VPN server is configured to use DHCP for IP address allocation and no DHCP server is available, a route to 169.254.0.0/16 (subnet mask 255.255.0.0) must be added to the routers of the intranet. When the VPN server is configured to use DHCP and no DHCP server is found, the VPN server allocates addresses from the AutoNet address range of 169.254.0.0/16. To check this address allocation on the client computer, access the properties of the active connection.</li></p>

<p><li>If the static IP address pool is a range of IP addresses that is a subset of the range of IP addresses for the network to which the VPN server is attached, verify that the range of IP addresses in the static IP address pool are not assigned to other TCP/IP nodes either statically or through DHCP.</li></p>

<p><li>For router-to-router VPNs, verify that the router-to-router VPN connection is being interpreted by the VPN server as a router-to-router VPN connection rather than as a remote access connection.</li></p>

<p><li>If the user name of the calling router's credentials appears under Dial-In Clients in the Routing And Remote Access Manager, then the VPN server has interpreted the calling router as a remote access client. Verify that the user name in the calling router's credentials matches the name of a demand-dial interface on the VPN server.</li></p></ul>
</ul>

<A NAME="577"><h3>Unable to Establish Tunnel</h3></A>
<p>Verify the following information in order to troubleshoot this problem:</p>

<ul>
<p><li>Verify that you are connecting to the correct address. Try to use the IP address of the server interface closest to you. This is the address of the interface that has the route back to you. If you are using DNS to resolve the IP address, the correct address may not be in use. Using the wrong address will cause the PPTP session to reset.</li></p>

<p><li>Verify that packet filtering on a router interface between the VPN client and the VPN server is not preventing the forwarding of tunnel maintenance traffic or tunneled data.</li></p>
<ul>
<p><li>On a Windows 2000 VPN server, IP packet filtering can be configured from the advanced TCP/IP properties and from the Routing And Remote Access snap-in. Check both places for filters that may be excluding VPN traffic.</li></p>

<p><li>Verify that packet filtering on other routers in the path are not blocking the needed protocols.</li></p>

<p><li>Verify the configuration of tunneling protocols:  </li></p>
<ul>

<p><li><b>PPTP</b> Pass TCP port 1723 and IP protocol ID 47 for the control session and GRE.</li></p>

<p><li><b>L2TP</b> Pass UDP port 1701.</li></p>

<p><li><b>IPSec</b> Pass protocol ID 50 and 51 for IPSEC Authentication header and ESP encapsulating security payload.</li></p>

<p><li><b>IP-IP</b> Pass IP protocol ID 4.</li></p>
</ul>
<p><li>Verify that the WinSock Proxy client is not currently running on the VPN client. When the WinSock Proxy client is active, WinSock API calls, such as those used to create tunnels and send tunneled data, are intercepted and forwarded to a configured proxy server.</li></p>
</ul></ul>

<A NAME="578"><h2>Lesson Summary</h2></A>
<p>A VPN mimics the properties of a dedicated private network, allowing data to be transferred between two computers across an internetwork, such as the Internet. Branch offices can use two different methods to connect to a network over the internet: using dedicated lines or dial-up lines. VPNs use tunneling to transfer data. Tunneling is a method of using an internetwork infrastructure to transfer a payload. A tunneling protocol is made up of a tunnel maintenance protocol and a tunnel data transfer protocol. There are two basic types of tunnels: voluntary tunnels and compulsory tunnels. The primary protocols used by Windows 2000 for VPN access are PPTP, L2TP, IPSec, and IP-IP. When managing VPNs, you must manage users, addresses and name servers, access, authentication, and encryption. If you cannot establish a VPN connection, you must troubleshoot the problem. Troubleshooting VPNs is a combination of troubleshooting IP connectivity, remote access connection establishment, routing, and IPSec.</p>

</BODY>
</HTML>



