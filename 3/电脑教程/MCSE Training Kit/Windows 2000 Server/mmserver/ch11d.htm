<HTML>
<HEAD>
<TITLE>Lesson 3: The Kerberos Protocol in Windows 2000</TITLE>
<link rel="STYLESHEET" type="text/css" href="mmserver.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch11c.htm", "ch11e.htm", "images/unit_p_a1.gif", "images/unit_p_a2.gif", "images/unit_p_b1.gif", "images/unit_p_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#aa22aa", "2");
//--></SCRIPT><P>

<A NAME="631"><h1>Lesson 3: The Kerberos Protocol in Windows 2000</h1></A>
<p>A standard process within computer security is to include a function that requires users to prove that they are who they claim to be. This affirmation of identity is accomplished when the user supplies the correct password for the user account. For example, when User1 attempts to connect to a server to access a file, the server must be sure that it is really User1 sending the request. Traditionally, the server assumes that it is User1 because the correct password was supplied when the connection was established. Stronger security is accomplished by having a trusted third party verify the identity of the user. This is a core function of the Kerberos authentication protocol.</p>

<p>
<div class="sidebar"><blockquote>
<b>After this lesson, you will be able to</b> 

<ul>
<p><li>Describe the Kerberos protocol and how it works in Windows 2000</li></p>
</ul>

<b>Estimated lesson time: 35 minutes</b> 
</blockquote></div>
</p>

<A NAME="632"><h2>Overview of the Kerberos Protocol</h2></A>
<p>The Kerberos protocol is the default authentication provider in Windows 2000 and the primary security protocol. It allows users to use a single logon to access all resources. The Kerberos protocol verifies both the identity of the user and the integrity of the session data. This is accomplished by having a Kerberos service installed on each domain controller and a Kerberos client installed on all computers running Windows 2000.</p>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
The Active Directory client for Windows 95 and Windows 98 allows users to log on by using the Kerberos V5 authentication protocol.
</blockquote></div>
</p>

<p>When the Kerberos authentication protocol is used, a trusted Kerberos service on a server verifies the user's identity. Before connecting to the server the user requests a ticket from the Kerberos service, called the Kerberos Key Distribution Center service, to confirm the user's identity. The user then sends this ticket to the target server. Because the server trusts the Kerberos service to vouch for user identities, the server accepts the ticket as proof of the authenticity of the user.</p>

<p>When using the Kerberos authentication protocol, users can no longer log on and then access resources simply by providing a valid user ID and the correct password. Instead of trusting the source, the resource must contact the Kerberos service to obtain a ticket that vouches for the user. The Kerberos service operates as a trusted third party to generate session keys and grant tickets for specific client/server sessions.</p>

<p>When the Kerberos service issues a ticket, it contains the following components:</p>

<ul>
<p><li>Session key</li></p>

<p><li>Name of the user to whom the session key was issued</li></p>

<p><li>Expiration period of the ticket</li></p>

<p><li>Any additional data fields or settings that may be required</li></p>
</ul>

<p>The expiration period of a ticket is defined by the domain policy. If a ticket expires during an active session, the Kerberos service notifies the client and the server to refresh the ticket. The Kerberos service then generates a new session key and the session is resumed.</p>

<A NAME="633"><h3>Kerberos Protocol Terms</h3></A>
<p>To better understand the Kerberos protocol, you should review the following terms used to describe the various components of Kerberos.</p>

<p><b>Principal</b></p>

<p>A <i>principal</i> is a uniquely named user, client, or server that participates in a network communication.</p>

<p><b>Realm</b></p>

<p>A <i>realm</i> is an authentication boundary, which can be compared to a Windows 2000 domain. Each organization wishing to run a Kerberos server establishes its own realm. A Windows 2000 domain is a Kerberos realm but is named domain to maintain naming conventions established previously for Windows NT.</p>

<p><b>Secret Key</b></p>

<p>A <i>secret key</i> is an encryption key that is shared by a client or a server and a trusted third party to encrypt the information that is to be moved between them. In the case of Kerberos, the trusted third party is the Kerberos service. In the case of a principal, the secret key is typically based upon a hash or encryption of the principal's password. Secret keys are never transmitted on the network; only the encrypted information is transmitted.</p>

<p><b>Session Key</b></p>

<p>The <i>session key</i> is a temporary encryption key used between two principals, with a lifetime limited to the duration of a single login session. The session key is exchanged between the communication partners and is therefore known as a shared secret. The session key is always sent encrypted.</p>

<p><b>Authenticator</b></p>

<p>An <i>authenticator</i> is a record that is used to verify that a request actually originated from the principal. An authenticator contains information that verifies the identity of the sender and the time the request was initiated. This information is encrypted with the shared session key that is known only by the communicating principals. An authenticator is typically sent along with a ticket to allow the receiver to verify that the intended client recently initiated a request.</p>

<p><b>Key Distribution Center</b></p>

<p>The <i>key distribution center</i> (KDC) provides two functions: the authentication server (AS) and the ticket granting service (TGS). The TGS distributes tickets to clients that wish to connect to services on the network. However, before a client can use the TGS to obtain tickets, it must first obtain a special ticket (the ticket granting ticket [TGT]) from the AS.</p>

<p><b>Privilege Attribute Certificate</b></p>

<p>The <i>privilege attribute certificate</i> (PAC) is a structure that contains the user's security ID (SID).</p>

<p><b>Tickets</b></p>

<p>In a basic Kerberos exchange, the client will contact the TGS and request a ticket for the target server before contacting the target server. A <i>ticket</i> is a record that allows a client to authenticate itself to a server; it is simply a certificate issued by the Kerberos service. The ticket is encrypted so that only the target server is able to decrypt and read it. Tickets contain the identity of the requesting client, the timestamp, the servers session key, the lifetime of the ticket, and other information (such as the PAC) that will help verify the identity of the client to the target server. Tickets are reusable within their life span, which is usually 8 hours.</p>

<p><b>Ticket Granting Tickets</b></p>

<p>One method for using Kerberos is to simply request a ticket for each target server from the TGS portion of the Kerberos service whenever the user wants to access the specified target server. Using this method, the response from the request would contain a session key and other information that is encrypted with the user's secret key. This method results in a component of the user's secret key being exposed on the network every time a new ticket request is made.</p>

<p>In Windows 2000, Kerberos protects the secret key by initially authenticating the user and then requesting a ticket granting ticket (TGT). A <i>ticket granting ticket</i> is a request for a ticket and a random session key to be used with the TGS portion of the Kerberos service. After obtaining the ticket, the user can contact a service at any time; the requested ticket does not come from the AS, but from the TGS. The reply is encrypted not with the user's secret key, but with the session key that the AS provided for use with the TGS.</p>

<A NAME="634"><h3>Features of the Kerberos Protocol</h3></A>
<p>The Kerberos protocol has several advantages over traditional challenge/response authentication systems.</p>

<p><b>Mature Open Standard</b></p>

<p>The Windows 2000 implementation of the Kerberos protocol complies with RFC 1510 and RFC 1964. It can interoperate with other implementations of Kerberos that also comply with the RFCs. Therefore, Kerberos clients on other platforms, such as UNIX, can be authenticated by Windows 2000. In some cases, however, implementation-dependent values will not exist or will be unavailable. In the absence of required data, the Windows 2000 Kerberos service attempts to match the principal name in the ticket either to a Windows 2000 user account or to a default account created for this purpose.</p>

<p><b>Faster Connection Authentication</b></p>

<p>When using the Kerberos protocol, servers do not need to do pass-through authentication. A server running Windows 2000 can verify the client credentials by using the client-supplied ticket, without having to query the Kerberos service. This is because the client will have already obtained a Kerberos ticket from a domain controller, which the server can then use to build the client's access token. Since the server is required to do less work when establishing a connection, it can more easily accommodate a large number of simultaneous connection requests.</p>

<p><b>Mutual Authentication</b></p>

<p>The Kerberos protocol provides mutual authentication of both the client and server. The Windows NTLM authentication protocol provides only client authentication, and it assumes that all servers are trusted. It does not verify the identity of the server that a client connects to. The assumption that all servers can be trusted is no longer valid. Mutual authentication of both client and server is an important foundation for secure networks.</p>

<p><b>Delegation of Authentication</b></p>

<p>Delegation of authentication allows a user to connect to an application server, which in turn can connect to one or more additional servers on the client's behalf, by using the client's credentials.</p>

<p><b>Transitive Trusts</b></p>

<p>Authentication credentials issued by one Kerberos service are accepted by all Kerberos services within the domain.</p>

<A NAME="635"><h3>Kerberos Authentication Process</h3></A>
<p>The Kerberos authentication process involves the client computer negotiating exchanges between the target server and the KDC. Figure 11.12 provides an overview of the authentication process. The numbered steps in the diagram are described below.</p>

<p>
<A HREF="javascript:fullSize('f11xx12gx.htm')"> <img src="images/f11xx12g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 11.12</b> <i>Kerberos authentication process</i><!--/caption-->
</p>

<p>The Kerberos authentication process works as follows:</p>

<ol>
<p><li>The client sends an initial AS request to the AS portion of the Kerberos service. The AS includes the client's principal name and the principal name of the target server for which it is requesting a ticket.</li></p>

<p><li>The Kerberos service generates an AS reply and sends it to the client. The reply contains the following:</li></p>

<ul>
<p><li>A TGT for the TGS portion of the Kerberos service. The TGT is encrypted with the TGS secret key. The TGT contains the user's SID. By encrypting the TGT with the TGS secret key, the client is unable to change the SID properties.</li></p>

<p><li>A session key for exchanges with the TGS portion of the Kerberos service. The session key is encrypted with the client's secret key. the client's secret key is a computation of the client's password. It is similar to the session key used in NTLM challenge/response. The encryption here makes it difficult for someone to steal the session key.</li></p>
</ul>

<p><li>The client generates and sends a TGS request that contains the client's and target server's principal names, realms, and the TGT that identifies the client.</li></p>

<p><li>The TGS portion of the Kerberos service generates and sends a TGS reply to the client. This reply contains a ticket for the target server. The ticket is encrypted with the server's secret key. The server's secret key is a computation of the password generated when the server joined the domain. The reply also includes other information, including the session key.</li></p>

<p><li>The client extracts the session key for the target server and generates a request for the server. This request contains the target server and an authenticator encrypted with the session key. The client sends this request to the target server by using an established transport path.</li></p>

<p><li>The target server decrypts the ticket by using its secret key to obtain the session key. The server then uses the session key to decrypt the authenticator to verify the client. If the client has requested mutual authentication, the target server generates a reply encrypted with the session key and send it to the client. Mutual authentication not only authenticates the client to the target server, but also authenticates the target server to the client.</li></p>
</ol>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
The AS and TGS exchanges with the Kerberos service operate over User Datagram Protocol (UDP) port 88. The exchanges between the client and target server are dependent on the protocol in use between the two principals.
</blockquote></div>
</p>

<A NAME="636"><h3>Kerberos Delegation</h3></A>
<p>Occasionally, it is necessary for an application server to connect to another server on behalf of a client. Like impersonation, delegation is used to ensure that proper security permissions are applied against the application server's request.</p>

<p>The Kerberos authentication protocol supports delegated authentication. This type of authentication is used when a client transaction involves multiple servers. In this case, each of the verifying servers obtains another ticket and authenticates the ticket to the requested server on behalf of the client. There is no restriction on the number of consecutive servers that can delegate authentication. This is different than impersonation, in that the server accesses remote resources on the behalf of the client instead of local resources.</p>

<p>Figure 11.13 provides an overview of the Kerberos delegation process. The numbered steps in the diagram are described below.</p>

<p>
<A HREF="javascript:fullSize('f11xx13gx.htm')"> <img src="images/f11xx13g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 11.13</b> <i>Kerberos delegation process</i><!--/caption-->
</p>

<p>The following steps describe the access of resources involving two servers:</p>

<ol>
<p><li>The client requests and receives a ticket for target Server A from the Kerberos service.</li></p>

<p><li>The client sends the ticket directly to Server A.</li></p>

<p><li>Server A sends a request, impersonating the client, to the Kerberos service for a ticket for target Server B. The Kerberos service responds with a ticket that allows the client to access Server B.</li></p>

<p><li>Server A can then send the ticket to Server B, accessing Server B as the client.</li></p>
</ol>

<A NAME="637"><h2>Kerberos Logon Processes</h2></A>
<p>The addition of Kerberos as an authentication package in Windows 2000 affects various aspects of the logon process. However, the portions of the logon process that run before an authentication package becomes involved remain unchanged in Windows 2000.</p>

<A NAME="638"><h3>Local Interactive Logon</h3></A>
<p>When a local interactive logon occurs, the user logs on with a user account that exists on the local computer rather than with a domain user account. Figure 11.14 provides an overview of the local interactive logon process in Windows 2000. The numbered steps in the diagram are described below.</p>

<p>
<A HREF="javascript:fullSize('f11xx14gx.htm')"> <img src="images/f11xx14g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 11.14</b> <i>Local interactive logon process</i><!--/caption-->
</p>

<p>For local user accounts, the following occurs in Windows 2000:</p>

<ol>
<p><li>When the Graphical Identification and Authentication DLL (GINA) receives the logon request, it forwards the request to the Local Service Authority (LSA). This request specifies Kerberos as the authentication package to use because this is the default package in Windows 2000.</li></p>

<p><li>LSA processes the request and sends it to the Kerberos authentication package.</li></p>

<p><li>When Kerberos receives the logon request. Kerberos returns an error because it is used only when authenticating logon requests for domain user accounts, not local user accounts.</li></p>

<p><li>LSA receives the error and returns an error to the GINA.</li></p>

<p><li>The GINA resubmits the logon request to LSA specifying the &quot;MSV1_0&quot; authentication package. The logon process then occurs as it would for a local interactive logon under Windows NT 4.0.</li></p>
</ol>

<A NAME="639"><h3>Domain Interactive Logon</h3></A>
<p>The exchange that occurs when a user logs on to Windows 2000 with a domain user account is similar to the basic Kerberos exchange. Figure 11.15 provides an overview of this logon process. The number steps in the diagram are described below.</p>

<p>
<A HREF="javascript:fullSize('f11xx15gx.htm')"> <img src="images/f11xx15g.jpg" border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!--caption--><b>Figure 11.15</b> <i>Domain interactive logon process</i><!--/caption-->
</p>

<p>The domain interactive logon process occurs as follows:</p>

<ol>
<p><li>When the logon request reaches the LSA, it passes the request to the Kerberos authentication package. The client sends an initial AS request to the Kerberos service, providing the user name and domain name. This is a request for authentication and a TGT. The request is made by using the principal name of krbtgt@&lt;<i>domain_name&gt;</i>, where &lt;<i>domain_name&gt;</i> is the name of the domain in which the user account is located. The first domain controller in the domain automatically generates the krbtgt@<i>&lt;domain_name&gt;</i> account.</li></p>

<p><li>The Kerberos service generates an AS reply containing a TGT (encrypted with the Kerberos secret key) and a session key for the TGS exchanges (encrypted with the client's secret key). This response is sent back to the client. The authorization data portion of the TGT contains the SID for the user account and SIDs for any global groups to which the user belongs. The SIDs are returned to the LSA for inclusion in the user's access token. The SIDs are copied by the Kerberos service from the TGT into subsequent tickets obtained from the Kerberos service.</li></p>

<p><li>The client then generates and sends a TGS request containing the client's principal name and realm, the TGT to identify the client, and the local workstation name as the target server. This is done to request access to the local computer for the user.</li></p>

<p><li>The Kerberos service generates and sends a TGS reply. This reply contains a ticket for the workstation and other information, including the session key (encrypted by using the session key from the TGT). Also included in the authorization data portion of the TGS reply are the SIDs for the user account and any global groups copied by the Kerberos service from the original TGT.</li></p>

<p><li>The Kerberos authentication package returns the list of SIDs to the LSA.</li></p>
</ol>

<p>Windows 2000 services use the Kernel Mode Security Support Provider Interface (SSPI) to perform authentication. Instead of communicating directly with the Kerberos authentication package, both services access Kerberos through an authentication package built into LSA. This authentication package is called the Negotiate package.</p>

<p>During startup, both the Server and Workstation services initialize their interface with the Negotiate package in LSA by using SSPI. During this process, the server service obtains a credential handle for its default credentials.</p>

<p>The network communication occurs in two segments: protocol negotiation and session setup. Before a user can establish a session with the server, the client computer and the server must agree on the security protocol to use by determining which version of security they both support. Once the client has been authenticated and has a ticket, it can establish a session with the server.</p>

<A NAME="640"><h3>Kerberos Public Key Support</h3></A>
<p>Windows 2000 extends the functionality of Kerberos to allow it to interact with the Active Directory service. Windows 2000 includes extensions to the Kerberos V5 authentication protocol to support public key-based authentication. The public key extensions allow clients to request an initial TGT by using a private key. The Kerberos service verifies such a request by using the user's public key that is obtained from the user's X.509 certificate published to the Active Directory store. In order to obtain a ticket, the user's X.509 certificate must be stored in their user object. If the Kerberos service finds the certificate, the Kerberos service issues a ticket for the client and the standard Kerberos procedure is followed thereafter. This replaces the secret key that is known only to the principal and the KDC. Smart cards, for example, use public key extensions provided by Kerberos.</p>

<A NAME="641"><h2>Lesson Summary</h2></A>
<p>Kerberos is the default authentication provider in Windows 2000 and the primary security protocol. To better understand the Kerberos protocol, you should be familiar with the terms common to Kerberos, including principal, realm, secret key, session key, authenticator, KDC, AS, TGS, PAC, ticket, and TGT. The Kerberos authentication process involves the client computer negotiating exchanges between the target server and the KDC. The Kerberos authentication protocol supports delegated authentication. When a local interactive logon occurs, the user logs on with a user account that exists on the local computer rather than with a domain user account. The exchange that occurs when a user logs on to Windows 2000 with a domain user account is similar to the basic Kerberos exchange. Windows 2000 services use the Kernel Mode SSPI to perform authentication. In addition, Windows 2000 extends the functionality of Kerberos to allow it to interact with Active Directory services. Windows 2000 includes extensions to the Kerberos V5 authentication protocol to support public key-based authentication.</p>

</BODY>
</HTML>



