<html>
<head>
<title>看雪学苑</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<style type="text/css">
<!--
.p8 {  font-size: 8pt}
.p9 {  font-size: 9pt}
a:hover {  color: #00FF00}
a {  text-decoration: none}
.p12 {  font-size: 12pt; font-weight: bold; color: #FF3333}
-->
</style>
</head>

<body bgcolor="#FFFFFF">
<span class="p9"><font color=blue>标 题:</font>Thebat!139脱壳详情及对Asprotect加壳保护的一点小结 
(4千字)<br>
<font color=blue>发信人:</font>baoleigz（Icebird)<br>
<font color=blue>时 间:</font>2000-3-27 21:43:38 <br>
<font color=blue>详细信息:</font><br>
</span>
<blockquote><span class="p9"> Thebat!139脱壳详情及对Asprotect加壳保护的一点小结 <br>
  <br>
  小弟本想脱thebat141的壳的，但小弟下载的thebat141却没有加壳，没办法，还是拿thebat139开刀了。 <br>
  <br>
  如果小弟下面的内容有错漏的地方，请给小弟指正。 <br>
  <br>
  小弟的脱壳方法和冰毒的不同，他的方法我用不了，我用Procdump32脱不了thebat的壳。 <br>
  <br>
  废话少说，let's go! <br>
  <br>
  所用工具：soft-ice405、icedump6015、procdump1.6.2、ultraedit5.0。 <br>
  <br>
  首先加载softice，再加载icedump。运行procdump32，点击PE Editor，选择thebat.exe <br>
  <br>
  文件，我们要记一下数据了：size of image:00314000&nbsp; image base:00400000， <br>
  <br>
  点击sections，记下.idata的数据：virtual siza:00003000&nbsp; virtual offset:0022E000 ，这样我们 
  <br>
  <br>
  可以知道.idata在内存中的地址为：0062E000，长度为：3000 <br>
  <br>
  启动Symbol Loader，载入thebat.exe（加载过icedump后，softice可以成功拦截thebat)，点击一下Load， <br>
  <br>
  马上被拦截，如下： <br>
  <br>
  XXX:006FF001&nbsp; &nbsp; PUSHAD&nbsp; **第一个PUSHAD指令** <br>
  <br>
  XXX:006FF002&nbsp; &nbsp; CALL&nbsp; 006FF008&nbsp; 按F8进入 <br>
  <br>
  XXX:006FF007&nbsp; &nbsp; NOP <br>
  <br>
  XXX:006FF008&nbsp; &nbsp; POP&nbsp; EBP 按F10一直来到： <br>
  <br>
  XXX:006FF0D6&nbsp; &nbsp; CALL&nbsp; 006FF0DE&nbsp; 按F8进入 <br>
  <br>
  在这之后的一段程序要走的小心一点，我建议用F8，如果离开了thebat的就按一下F12，然后再按F8， <br>
  <br>
  一直来到：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>
  <br>
  XXX:006FFA3B&nbsp; &nbsp; PUSHAD&nbsp; **第二个PUSHAD指令**&nbsp; &nbsp; 改按F10一直来到： 
  <br>
  <br>
  XXX:006FFB6C&nbsp; &nbsp; POPAD&nbsp; &nbsp; **和第二个PUSHAD指令是一对** <br>
  <br>
  XXX:006FFB6D&nbsp; &nbsp; POP EBP <br>
  <br>
  XXX:006FFB6E&nbsp; &nbsp; RET&nbsp; 0008&nbsp; 这个CALL走完了，来到： <br>
  <br>
  XXX:006FF09F&nbsp; &nbsp; MOV&nbsp; ECX，EAX&nbsp; 按F10来到： <br>
  <br>
  XXX:006FF0D6&nbsp; &nbsp; CALL&nbsp; 006FF0DE&nbsp; 按F8进入，然后一直按F10来到：&nbsp; 
  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>
  <br>
  XXX:006FFA3B&nbsp; &nbsp; PUSHAD&nbsp; **第三个PUSHAD指令** （难道又回去了？当然不是。）按F10直到：&nbsp; 
  &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>
  <br>
  XXX:006FFB6C&nbsp; &nbsp; POPAD&nbsp; &nbsp; **和第三个PUSHAD指令是一对** <br>
  <br>
  XXX:006FFB6D&nbsp; &nbsp; POP&nbsp; EBP <br>
  <br>
  XXX:006FFB6E&nbsp; &nbsp; RET&nbsp; 0008 走完这个CALL来到： <br>
  <br>
  XXX:006FF1D3&nbsp; &nbsp; PUSH&nbsp; 04 <br>
  <br>
  XXX:006FF1D5&nbsp; &nbsp; PUSH&nbsp; 00001000&nbsp; 按F10一直到： <br>
  <br>
  XXX:006FF218&nbsp; &nbsp; CALL&nbsp; 006FF220&nbsp; 按F8进入，之后按F10一直到： <br>
  <br>
  XXX:006FF2A2&nbsp; &nbsp; CALL&nbsp; 006FF2AA&nbsp; 这里开始一直按F8，如果离开了thebat，就按一下F12，再按F8来到： 
  <br>
  <br>
  XXX:0099E001&nbsp; &nbsp; PUSHAD&nbsp; **第四个PUSHAD指令** F10一直来到： <br>
  <br>
  XXX:0099E5C5&nbsp; &nbsp; POPAD&nbsp; &nbsp; **和第四个PUSHAD指令是一对** <br>
  <br>
  XXX:0099E5C6&nbsp; &nbsp; JNP&nbsp; 009E5D0 <br>
  <br>
  XXX:0099E5C8&nbsp; &nbsp; MOV&nbsp; EAX,00000001 <br>
  <br>
  XXX:0099E5CD&nbsp; &nbsp; RET&nbsp; 000C <br>
  <br>
  XXX:0099E5D0&nbsp; &nbsp; PUSH&nbsp; 00990B60 <br>
  <br>
  XXX:0099E5D5&nbsp; &nbsp; RET&nbsp; 终于走完了这个CALL，来到这里： <br>
  <br>
  XXX:00990B60&nbsp; &nbsp; PUSH&nbsp; EBP 按F10来到： <br>
  <br>
  XXX:00990B8A&nbsp; &nbsp; CALL&nbsp; 00983DC4&nbsp; F8进入，F10来到： <br>
  <br>
  XXX:00990956&nbsp; &nbsp; CALL&nbsp; 009904F4&nbsp; F8进入，F10来到： <br>
  <br>
  XXX:00990A11&nbsp; &nbsp; CALL&nbsp; 00990110 <br>
  <br>
  XXX:00990A16&nbsp; &nbsp; XOR&nbsp; EAX，EAX&nbsp; &nbsp; （这里和冰毒一样，我可省了不少时间:-)） 
  <br>
  <br>
  这里下： PAGEIN D 62E000 3000 D:\IDATA.BIN&nbsp; &nbsp; 得到完整的.idata部分 <br>
  <br>
  继续F10来到：&nbsp; &nbsp; &nbsp; &nbsp; &nbsp; <br>
  <br>
  XXX:00990B43&nbsp; &nbsp; CALL&nbsp; 009904C8&nbsp; F8进入，来到这里： <br>
  <br>
  XXX:009904D5&nbsp; &nbsp; POPAD&nbsp; **和第一个PUSHAD指令是一对** <br>
  <br>
  XXX:009904D6&nbsp; &nbsp; PUSH&nbsp; EAX <br>
  <br>
  XXX:009904D7&nbsp; &nbsp; RET&nbsp; （这里冰毒用Procdump32脱壳。可以吗？我怎么不行？谁可以就教教我。） <br>
  <br>
  走完这里来到：&nbsp; &nbsp; &nbsp; <br>
  <br>
  XXX:0061C528&nbsp; PUSH&nbsp; EBP <br>
  <br>
  来到这里后Soft-Ice中显示着‘THEBAT！CODE+0021B526’，有‘CODE’的字样，我们可以知道thebat是 <br>
  <br>
  用Broland写，成的,而且我们已经进入了主程序，可以脱壳了。 <br>
  <br>
  下： PAGEIN D 400000 314000 D:\THEBAT.EXE&nbsp; 得到脱壳后的thebat.exe文件&nbsp; <br>
  <br>
  用ultraedit5.0打开thebat.exe及idata.bin，将idata.bin的内容替换到thebat.exe的22E000--230FFF中。 
  <br>
  <br>
  这样得到的程序还不能用，启动Procdump32修改文件Sections。 <br>
  <br>
  将每一项Section的 Raw Size ==> Virtual Size&nbsp; ； Raw Offset ==> Virtual Offset 
  <br>
  <br>
  将程序入口改成：0021C528（61C528-400000=21C528） <br>
  <br>
  我记得冰毒说这样脱壳的程序不行，当然了！因为他漏了最重要的一步（趁冰毒不在，说了他不少坏话， <br>
  <br>
  大家可不要告诉他呦:-D）： <br>
  <br>
  点击Procdump32中的 PE Editor-->Directory，将 Import Table 的值改成：0022E000 <br>
  <br>
  自此程序已脱壳成功，我们来小结一下： <br>
  <br>
  小弟通过对几个用Asprotect加壳的软件脱壳，对Asprotect加的壳有的一定了解，发现了一点共有的特征， <br>
  <br>
  用Asprotect加壳的软件会出现3到4对‘PUSHAD--POPAD’指令（用Aspack或Upx加壳的软件只会出现一对） <br>
  <br>
  在走完这几对‘PUSHAD--POPAD’指令后，我们便进入到主程序了，可以开始脱壳。脱壳后的文件还要还 <br>
  <br>
  原PE文件头，要将完整的‘.idata’或‘.rdata’替换到脱壳后的文件中，至于到底是‘.idata’还是 <br>
  <br>
  ‘.rdata’就要大家自己去判断了，最后修改文件的Sections、Entry Point、Import Table各项。这样也 <br>
  <br>
  就脱壳成功了。 <br>
  <br>
  　 <br>
  <br>
  baoleigz（暴雷） </span></blockquote>
<hr>
</body>
</html>
