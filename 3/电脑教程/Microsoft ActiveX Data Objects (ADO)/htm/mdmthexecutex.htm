<!DOCTYPE HTML PUBLIC "-//W3C//DTD HTML 3.2 Final//EN">
<HTML dir=ltr>
<HEAD>
<META HTTP-EQUIV="Content-Type" Content="text/html; charset=GB_2312-80">
<title>Execute、Requery 和 Clear 方法范例</title>
<style>@import url(/stylesheets/msdn_ie4.css);</style>
<link disabled rel="stylesheet" href="/stylesheets/msdn_ie3.css"></HEAD>
<BODY>

<h3><a name="mdmthexecutex"></a>Execute、Requery 和 Clear 方法范例</h3>
<p>
该范例演示运行来自 <b>Command</b> 对象和 <b>Connection</b> 对象的 <b>Execute</b> 方法。同时使用 <b>Requery</b> 方法检索记录集中的当前数据，并用 <b>Clear</b> 方法清除 <b>Errors</b> 集合的内容。运行该过程需要 ExecuteCommand 和 PrintOutput 过程。</p>
<pre>Public Sub ExecuteX()

   Dim strSQLChange As String
   Dim strSQLRestore As String
   Dim strCnn As String
   Dim cnn1 As ADODB.Connection
   Dim cmdChange As ADODB.Command
   Dim rstTitles As ADODB.Recordset
   Dim errLoop As ADODB.Error

   ' 定义两个 SQL 语句作为命令文本执行。
   strSQLChange = "UPDATE Titles SET Type = " &amp; _
      "'self_help' WHERE Type = 'psychology'"
   strSQLRestore = "UPDATE Titles SET Type = " &amp; _
      "'psychology' WHERE Type = 'self_help'"

   ' 打开连接。
      strCnn = "Provider=sqloledb;" &amp; _
      "Data Source=srv;Initial Catalog=pubs;User Id=sa;Password=; "
   Set cnn1 = New ADODB.Connection
   cnn1.Open strCnn

   ' 创建命令对象。
   Set cmdChange = New ADODB.Command
   Set cmdChange.ActiveConnection = cnn1
   cmdChange.CommandText = strSQLChange
   
   ' 打开标题表。
   Set rstTitles = New ADODB.Recordset
   rstTitles.Open "titles", cnn1, , , adCmdTable

   ' 打印原始数据报告。
   Debug.Print _
      "Data in Titles table before executing the query"
   PrintOutput rstTitles

   ' 清除 Errors 集合的外部错误。
   cnn1.Errors.Clear

   ' 调用 ExecuteCommand 子例程执行 cmdChange 命令。
   ExecuteCommand cmdChange, rstTitles
   
   ' 打印新数据报告。
   Debug.Print _
      "Data in Titles table after executing the query"
   PrintOutput rstTitles

   ' 使用 Connection 对象的 execute 方法执行 SQL 语句以恢复数据。 
   ' 捕获错误，必要时检查 Errors 集合。
   On Error GoTo Err_Execute
   cnn1.Execute strSQLRestore, , adExecuteNoRecords
   On Error GoTo 0

   ' 通过再查询记录集检索当前数据。
   rstTitles.Requery

   ' 打印已恢复数据的报告。
   Debug.Print "Data after executing the query " &amp; _
      "to restore the original information"
   PrintOutput rstTitles

   rstTitles.Close
   cnn1.Close
   
   Exit Sub
   
Err_Execute:

   ' 将任何由执行查询引起的错误通知用户。
   If Errors.Count &gt; 0 Then
      For Each errLoop In Errors
         MsgBox "Error number: " &amp; errLoop.Number &amp; vbCr &amp; _
            errLoop.Description
      Next errLoop
   End If
   
   Resume Next

End Sub

Public Sub ExecuteCommand(cmdTemp As ADODB.Command, _
   rstTemp As ADODB.Recordset)

   Dim errLoop As Error
   
   ' 运行指定的 Command 对象。捕获错误，必要时检查 Errors 集合。
   On Error GoTo Err_Execute
   cmdTemp.Execute
   On Error GoTo 0

   ' 通过再查询记录集检索当前数据。
   rstTemp.Requery
   
   Exit Sub

Err_Execute:

   ' 将任何由执行查询引起的错误通知用户。
   If Errors.Count &gt; 0 Then
      For Each errLoop In Errors
         MsgBox "Error number: " &amp; errLoop.Number &amp; vbCr &amp; _
            errLoop.Description
      Next errLoop
   End If
   
   Resume Next

End Sub

Public Sub PrintOutput(rstTemp As ADODB.Recordset)

   ' 枚举 Recordset。
   Do While Not rstTemp.EOF
      Debug.Print "&nbsp; " &amp; rstTemp!Title &amp; _
         ", " &amp; rstTemp!Type
      rstTemp.MoveNext
   Loop

End Sub
</pre>
<p class=label>
<b>VBScript 版本</b></p>
<p>
下面是使用 VBScript 编写、并用于 Active Server Page (ASP) 的相同范例。如需查看该完整功能范例，请使用与 IIS 一同安装并位于 C:\InetPub\ASPSamp\AdvWorks 的数据源 AdvWorks.mdb，来创建名为 AdvWorks 的系统“数据源名称”(DSN)。这是 Microsoft Access 数据库文件。请使用查找命令定位文件 Adovbs.inc，并将其放入计划使用的目录中。请将以下代码剪切并粘贴到记事本或其他文本编辑器中，另存为“Execute.asp”。这样，便可在任何客户端浏览器中查看结果。</p>
<pre>&lt;!-- #Include file="ADOVBS.INC" --&gt;
&lt;HTML&gt;&lt;HEAD&gt;
&lt;TITLE&gt;ADO Execute Method&lt;/TITLE&gt;&lt;/HEAD&gt;

&lt;BODY&gt; 
&lt;FONT FACE="MS SANS SERIF" SIZE=2&gt;
&lt;Center&gt;&lt;H3&gt;ADO Execute Method&lt;/H3&gt;&lt;H4&gt;Recordset Retrieved Using Connection Object&lt;/H4&gt;
&lt;TABLE WIDTH=600 BORDER=0&gt;
&lt;TD VALIGN=TOP ALIGN=LEFT COLSPAN=3&gt;&lt;FONT SIZE=2&gt;

&lt;!--- Recordsets 使用 Connection 和 Command 对象的 Execute 方法进行检索 --&gt;
&lt;% 
Set OBJdbConnection = Server.CreateObject("ADODB.Connection") 
OBJdbConnection.Open "AdvWorks" 
SQLQuery = "SELECT * FROM Customers" 
' 第一个 Recordset RSCustomerList
Set RSCustomerList = OBJdbConnection.Execute(SQLQuery) 

Set OBJdbCommand = Server.CreateObject("ADODB.Command")
OBJdbCommand.ActiveConnection = OBJdbConnection
SQLQuery2 = "SELECT * From Products"
OBJdbCommand.CommandText = SQLQuery2
Set RsProductList = OBJdbCommand.Execute

%&gt;
&lt;TABLE COLSPAN=8 CELLPADDING=5 BORDER=0&gt;

&lt;!-- Customer 表的 BEGIN 列标头行 --&gt;

&lt;TR&gt;&lt;TD ALIGN=CENTER BGCOLOR="#008080"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Company Name&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER BGCOLOR="#008080"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Contact Name&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER WIDTH=150 BGCOLOR="#008080"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;E-mail address&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER BGCOLOR="#008080"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;City&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER BGCOLOR="#008080"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;State/Province&lt;/FONT&gt;
&lt;/TD&gt;&lt;/TR&gt;

&lt;!-- 显示 Customer 表的 ADO 数据 --&gt;
&lt;% Do While Not RScustomerList.EOF %&gt;
  &lt;TR&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt; 
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RSCustomerList("CompanyName")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RScustomerList("ContactLastName") &amp; ", " %&gt; 
  &lt;%= RScustomerList("ContactFirstName") %&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt;
 &nbsp; 
  &lt;%= RScustomerList("ContactLastName")%&gt; 
 &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RScustomerList("City")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RScustomerList("StateOrProvince")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;/TR&gt; 
&lt;!-Next Row = Record Loop 并添加到 html 表 --&gt;
&lt;% 
RScustomerList.MoveNext 
Loop 
RScustomerList.Close

%&gt;

&lt;/TABLE&gt;&lt;HR&gt;
&lt;H4&gt;Recordset Retrieved Using Command Object&lt;/H4&gt;
&lt;TABLE COLSPAN=8 CELLPADDING=5 BORDER=0&gt;

&lt;!-- Product List 表的 BEGIN 列标头行 --&gt;

&lt;TR&gt;&lt;TD ALIGN=CENTER BGCOLOR="#800000"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Product Type&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER BGCOLOR="#800000"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Product Name&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER WIDTH=350 BGCOLOR="#800000"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Product Description&lt;/FONT&gt;
&lt;/TD&gt;
&lt;TD ALIGN=CENTER BGCOLOR="#800000"&gt;
&lt;FONT STYLE="ARIAL NARROW" COLOR="#ffffff" SIZE=1&gt;Unit Price&lt;/FONT&gt;
&lt;/TD&gt;&lt;/TR&gt;

&lt;!-- 显示 ADO 数据的 Product List --&gt;
&lt;% Do While Not RsProductList.EOF %&gt;
  &lt;TR&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt; 
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RsProductList("ProductType")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt; 
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RsProductList("ProductName")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt;
 &nbsp; &lt;%= RsProductList("ProductDescription")%&gt; 
 &lt;/FONT&gt;&lt;/TD&gt;

  &lt;TD BGCOLOR="f7efde" ALIGN=CENTER&gt;
  &lt;FONT STYLE="ARIAL NARROW" SIZE=1&gt; 
  &lt;%= RsProductList("UnitPrice")%&gt; 
  &lt;/FONT&gt;&lt;/TD&gt;
  
&lt;!--&nbsp; Next Row = Record --&gt;
&lt;% 
RsProductList.MoveNext 
Loop 
' 从内存删除对象以释放资源。
RsProductList.Close
OBJdbConnection.Close
Set ObJdbCommand = Nothing
Set RsProductList = Nothing
Set OBJdbConnection = Nothing
%&gt;
&lt;/TABLE&gt;&lt;/FONT&gt;&lt;/Center&gt;&lt;/BODY&gt;&lt;/HTML&gt;
</pre>
</BODY>
</HTML>
