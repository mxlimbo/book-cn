<HTML>
<HEAD>
<TITLE>Remote Data Services</TITLE>
<LINK REL=STYLESHEET HREF="Library.css" TYPE="text/css">


</HEAD>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch19e.htm", "ch19g.htm", "images/unit_o_a1.gif", "images/unit_o_a2.gif", "images/unit_o_b1.gif", "images/unit_o_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#ff9900", "2");
//--></SCRIPT>


<A NAME="967"><h1>Remote Data Services</h1></A>
<p>In a previous example, I showed you how a DHTML application can use ADO 
to perform a search on an MDB database and display the results as a table in an 
HTML page. When creating real-world Internet applications, however, you obviously 
can't use the approach used in that example because the database isn't local and you 
don't have a path to it.
</p>

<p>Another problem that you must solve when a client communicates with a 
Web browser is that HTTP is a <I>stateless </I>protocol, which means that no information is 
retained between consecutive requests from the browser. This sharply contrasts 
with the ADO way of doing things, which in general expects that the client is always 
in touch with the data source, from its logon and until the connection is closed. 
The ADO objects that get closer to the concept of a connectionless state are 
disconnected Recordsets, which update data through optimistic batch updates.
</p>

<p>How can you read data from and write data to a database located on a 
remote Web server? The answer to this question is provided by Remote Data Services 
(RDS). You can choose one of two ways to use such objects: You can use bound 
DHTML controls or "pure" ADO code.
</p>

<A NAME="968"><h2>DHTML Data Binding </h2></A>

<p>The simplest way to display data coming from a data source on an HTML page is 
to place an RDS.DataControl object on the page and bind one or more controls to 
it. This is conceptually similar to having bound controls on a regular Visual Basic 
form, but the actions you have to undertake are different.
</p>

<A NAME="969"><h3>Creating the RDS.DataControl object</h3></A>

<p>The first thing you have to do is add a RDS.DataControl to the HTML page. This 
object is an ActiveX component exposed by the RDS library, and you can place it on 
an HTML page with the following &lt;OBJECT&gt; tag in the body of the page:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>&lt;OBJECT CLASSID=clsid:BD96C556-65A3-11D0-983A-00C04FC29E33 
   ID=dcPublishers HEIGHT=1 WIDTH=1&gt;
    &lt;PARAM NAME="Server" VALUE="http://www.yourserver.com"&gt;
    &lt;PARAM NAME="Connect" VALUE="DSN=Pubs"&gt;
    &lt;PARAM NAME="SQL" VALUE="SELECT * FROM Publishers"&gt;
&lt;/OBJECT&gt;
</pre>
</td></tr>
</table></p>


<p>You must set at least three properties of the RDS.DataControl object: The 
<I>Server </I>property is the URL of the server where the data source resides, the 
<I>Connect</I> property points to the data source on that server, and 
<I>SQL </I>is the text of the query. You can also create the RDS.DataControl dynamically, which is especially useful when 
you want to assign these properties at run time, when the page has been already 
loaded. You can dynamically create a RDS.DataControl object using plain VBScript 
code placed in the <I>Window_onload </I>event or outside any VBScript procedure:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>&lt;SCRIPT LANGUAGE="VBScript"
' This code executes when the page loads.
Dim dcPublishers
Set dcPublishers = CreateObject("RDS.DataControl")
dcPublishers.Server = "http://www.yourserver.com"
dcPublishers.Connect = "DSN=Pubs"
dcCustomer.SQL = "SELECT * From Publishers"
dcCustomer.Refresh
&lt;/SCRIPT&gt;
</pre>
</td></tr>
</table></p>


<p>The <I>Server </I>property can point to an HTTP URL address or to an HTTPS 
URL address for a secure protocol (HTTPS is the Secure Hypertext Transfer Protocol). 
In both cases, the URL can include a port number. If you're retrieving data 
through DCOM, you can assign the name of the machine where the data source is. Finally, 
if you're working with a local database (typically, during earlier debug phases) you 
can assign an empty string to this property or omit it in the &lt;OBJECT&gt; tab. If you 
don't specify the server, the RDS.DataControl object is instantiated as an in-process 
object. All the demonstration applications on the companion CD use a local 
NWind.mdb, so this property is always left blank. Remember to assign it a meaningful value 
when you move the application to your local network or intranet.
</p>

<A NAME="970"><h3>Binding DHTML elements</h3></A>

<p>You can bind many different types of DHTML elements to a RDS.DataControl 
object, some of which are listed in Table 19-1. All bindable elements support 
three properties:
</p>

<UL>
<p><li> DATASRC<I> </I>is the name of the RDS.DataControl the element is bound 
to, preceded by a # sign, for example, 
<I>#dcPublishers</I>. (It corresponds to the <I>DataSource 
</I>property of a Visual Basic bound control.) 

  <P></P>
 
<p></p><li> DATAFLD is the name of the field in the data source this element 
binds to. (It corresponds to the <I>DataField </I>Visual Basic's property.) 
  <P></P>

<p></p><li> DATAFORMATAS<I> </I>can be <I>text </I>or 
<I>HTML</I>, depending on whether the contents of the source field must be interpreted as plain text or HTML 
code. The default for this property is <I>text</I>, and you can use 
<I>HTML </I>only for the controls that support the 
<I>innerHTML </I>property. 
  <P></P>
</li>
</UL>

<p>Here's an example of TextBox controls that are bound to the 
<I>dcPublishers </I>RDS.DataControl created previously:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Publisher Name: &lt;BR&gt;
&lt;INPUT ID="txtPubName" DATASRC="#dcPublishers" DATAFLD="Pub_Name"&gt;&lt;BR&gt;
City: &lt;BR&gt;
&lt;INPUT ID="txtCity" DATASRC="#dcPublishers" DATAFLD="City"&gt;&lt;BR&gt;
</pre>
</td></tr>
</table></p>
<p>
<B>Table 19-1.</B> <I>Some of the HTML elements that can be bound to 
an RDS.DataControl object.</I>
</p>

<p>
<table valign="top" cellpadding="5" width="95%">
<tr>
<th><i>Element</i></th>
<th><i>Bound Property</i></th>
<th><i>Updatable</i></th>
</tr>

<tr>
<td valign="top">A</td>
<td valign="top"><I>href</I></td>
<td valign="top">No</td>
</tr>

<tr>
<td valign="top">BUTTON</td>
<td valign="top"><I>innerText/innerHTML</I></td>
<td valign="top">Yes</td>
</tr>

<tr>
<td valign="top">DIV</td>
<td valign="top"><I>innerText/innerHTML</I></td>
<td valign="top">Yes</td>
</tr>

<tr>
<td valign="top">IMG</td>
<td valign="top"><I>src</I></td>
<td valign="top">No</td>
</tr>

<tr>
<td valign="top">INPUT</td>
<td valign="top"><I>value </I>or <I>checked</I> (depending on the TYPE attribute)</td>
<td valign="top">Yes</td>
</tr>
     
<tr>
<td valign="top">SELECT</td>
<td valign="top">the text of the selected OPTION tag</td>
<td valign="top">Yes</td>
</tr>

<tr>
<td valign="top">SPAN</td>
<td valign="top"><I>innerText/innerHTML</I></td>
<td valign="top">Yes</td>
</tr>

<tr>
<td valign="top">TEXTAREA</td>
<td valign="top"><I>value</I></td>
<td valign="top">Yes</td>
</tr>
</table>
</p>


<A NAME="971"><h3>Navigating and updating the Recordset</h3></A>

<p>Unlike the standard ADO Data control, the RDS.DataControl object doesn't have 
a visible interface, so you must provide the buttons for navigating the Recordset. 
Such buttons use the methods of the Recordset exposed by the RDS.DataControl 
object. This VBScript code assumes that you've created the four 
<I>btnMove</I>xxxx buttons, plus the <I>btnDelete 
</I>and the <I>btnAddNew </I>controls:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Sub btnMoveFirst_onclick()
    dcPublishers.Recordset.MoveFirst
End Sub

Sub btnMovePrevious_onclick()
    dcPublishers.Recordset.MovePrevious
    If dcPublishers.Recordset.BOF Then dcPublishers.Recordset.MoveFirst
End Sub

Sub btnMoveNext_onclick()
    dcPublishers.Recordset.MoveNext
    If dcPublishers.Recordset.EOF Then dcPublishers.Recordset.MoveLast
End Sub

Sub btnMoveLast_onclick()
    dcPublishers.Recordset.MoveLast
End Sub

Sub btnDelete_onclick()
    dcPublishers.Recordset.Delete
    dcPublishers.Recordset.MoveNext
    If dcPublishers.Recordset.EOF Then dcPublishers.Recordset.MoveLast
End Sub

Sub btnAddNew_onclick()
    dcPublishers.Recordset.AddNew
End Sub
</pre>
</td></tr>
</table></p>


<p>The RDS.DataControl object works with disconnected Recordsets, so all 
the changes you make to it through bound controls are cached locally. When 
you're ready to send the changes to the data source, you execute the 
RDS.DataControl's <I>SubmitChanges </I>method. You typically invoke this method in the 
<I>Window_onunload </I>event or from the <I>onclick 
</I>event of a button:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Sub btnUpdate_onclick()
    dcPublishers.SubmitChanges
End Sub
</pre>
</td></tr>
</table></p>


<p>You can cancel all pending updates using the 
<I>CancelUpdate </I>method. On the companion CD, you'll find an application that uses bound HTML controls to 
connect to the Customers table of a local copy of NWind.mdb; you'll probably have to 
change the <I>Connect </I>property of the RDS.DataControl to have it point to a valid path on 
your system.
</p>

<p>All bound controls can raise two events, which you can trap from a script 
in the page or from Visual Basic code in a DHTML application. The 
<I>onbeforeupdate </I>event fires before a modified value is transferred from the control to the data source; if 
you don't cancel it, the control fires an <I>onafterupdate 
</I>event immediately after the update operation finishes executing. You can use these events to validate the data that 
the user has entered in bound controls, as you can see in Figure 19-17.
</p>

<p>
<A href="javascript:fullSize('F19ph17x.htm')"> <IMG alt="Click to view at full  size." border    =0 height=303 src="images/F19ph17.JPG" width=404 > </A>
</p><p>
<!--caption--><B>Figure 19-17.</B> <I>This DHTML application uses bound controls and some VBScript code behind the navigational buttons.</I><!--/caption-->
</p>

<A NAME="972"><h3>Tabular binding</h3></A>

<p>If you prefer displaying the result of a query in tabular format, you can take 
advantage of the special binding features of the DHTML tables. In this case, you have 
to assign the DATASRC property in the &lt;TABLE&gt; tag and then prepare one single 
row of table cells containing &lt;SPAN&gt; tags with appropriate DATAFLD attributes. 
The following code is taken from the demonstration program (shown in Figure 
19-18) provided on the companion CD:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>&lt;TABLE DATASRC="#dcCustomers" BORDER=1&gt;
 &lt;THEAD&gt;&lt;TR&gt;   
   &lt;TH&gt;Company Name&lt;/TH&gt;
   &lt;TH&gt;Address&lt;/TH&gt;
   &lt;TH&gt;City&lt;/TH&gt;
   &lt;TH&gt;Region&lt;/TH&gt;
   &lt;TH&gt;Country&lt;/TH&gt;
  &lt;/TR&gt;&lt;/THEAD&gt;
 &lt;TBODY&gt;&lt;TR&gt;   
   &lt;TD&gt;&lt;B&gt;&lt;SPAN DATAFLD="CompanyName"&gt;&lt;/SPAN&gt;&lt;B&gt;&lt;/TD&gt;
   &lt;TD&gt;&lt;SPAN DATAFLD="Address"&gt;&lt;/SPAN&gt;&lt;/TD&gt;
   &lt;TD&gt;&lt;SPAN DATAFLD="City"&gt;&lt;/SPAN&gt;&lt;/TD&gt;
   &lt;TD&gt;&lt;SPAN DATAFLD="Region"&gt;&lt;/SPAN&gt;&lt;/TD&gt;
   &lt;TD&gt;&lt;SPAN DATAFLD="Country"&gt;&lt;/SPAN&gt;&lt;/TD&gt;
  &lt;/TR&gt; &lt;/TBODY&gt;
&lt;/TABLE&gt;
</pre>
</td></tr>
</table></p>


<p>For each record in the source, the RDS.DataControl object generates a new 
row of cells. For such dynamically generated rows, RDS.DataControl uses the HTML 
template included between the &lt;TBODY&gt; and &lt;/TBODY&gt; tags. You can format and 
align individual columns by using standard HTML tags. For example, the sample 
application displays the CompanyName field in boldface.
</p>

<p>
<A href="javascript:fullSize('F19ph18x.htm')"> <IMG alt="Click to view at full  size." border    =0 height=303 src="images/F19ph18.JPG" width=404 > </A>
</p><p>
<!--caption--><B>Figure 19-18.</B> <I>Bound DHTML tables automatically resize their columns to display the contents of their cell in the most appropriate way.</I><!--/caption-->
</p>

<A NAME="973"><h3>More on the RDS.DataControl object</h3></A>
<p>The RDS.DataControl object exposes several other properties and methods that 
can be used for fine-tuning your application. For example, the 
<I>InternetTimeout </I>property gives you the timeout in milliseconds for HTTP transmissions, while the 
<I>SortColumn</I> and the <I>SortDirection </I>properties let you sort data in the underlying Recordset:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' Sort on the City field in ascending order.
dcPublishers.SortDirection = True
dcPublishers.SortColumn = "City"
dcPublishers.Reset
</pre>
</td></tr>
</table></p>


<p>The <I>FilterColumn</I>, <I>FilterCriterion</I>, and 
<I>FilterValue </I>properties work together to apply a filter on the retrieved data:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' Display only U.S. publishers.
dcPublishers.FilterColumn = "Country"
' FilterCriterion supports the following operators: &lt;  &lt;=  &gt;  &gt;=  =  &lt;&gt;.
dcPublishers.FilterCriterion = "="
dcPublishers.FilterValue = "USA"
dcPublishers.Reset
</pre>
</td></tr>
</table></p>


<p>By default, the RDS.DataControl executes the query and fetches the 
Recordset asynchronously. You can control how queries are executed using the 
<I>ExecuteOptions </I>property, which can be 1-adcExecSync or 2-adcExecAsync. Similarly, you can 
determine how the Recordset is fetched using the 
<I>FetchOptions </I>property, which can take one of the following values: 1-adcFetchUpFront (synchronous execution, the 
control is returned to the application when the Recordset has been completely 
populated); 2-adcFetchBackground (the control is returned to the application when the first 
batch of records is returned, and the remaining data is retrieved asynchronously); 
or 3adcFetchAsync (the default mode, all the records are retrieved in the background).
</p>

<p>When the RDS.DataControl is working asynchronously, you must test 
the <I>ReadyState</I> property, which returns one of the following values: 
2-adcReadyStateLoaded (the Recordset is open but no data has been retrieved yet); 
3-adcReadyStateInteractive (the Recordset is being populated); 4-adcReadyStateComplete (the Recordset has 
completed retrieving data). When this property receives a new value, the 
RDS.DataControl fires an <I>onreadystatechange 
</I>event. You can cancel an asynchronous operation 
using the <I>Cancel </I>method.
</p>

<p>When an error occurs and no VBScript code is executing, the 
RDS.DataControl object raises an <I>onerror </I>event.
</p>

<A NAME="974"><h2>Using RDS Objects</h2></A>

<p>While binding is always great for creating a prototype, in most cases you must 
write code if you want to remain in control of the whole process. The RDS library 
comprises a few objects that make it possible for a disconnected client to exchange 
data using a stateless protocol. More precisely, when developing applications based 
on RDS you use objects from <I>three </I>different libraries. (See Figure 19-19.)
</p>

<UL>

<p><li> <I> RDS.DataSpace </I>is a 
  component that runs in the client application and represents a link to the 
  server on which the data actually resides. This object is exposed by the 
  Microsoft Remote Data Services library (Msadco.dll). 
  <P></P>
 
<p></p><li> <I>RDSServer.DataFactory</I> is 
  a component that runs on the server. It queries the data source and optionally 
  updates it with data coming from the client. This object is exposed by the 
  Microsoft Remote Data Services Server library (Msadcf.dll). You don't need to 
  install this library on client workstations. 
  <P></P>
<p></p><li> <I>RDS.DataControl</I> 
  (described in the previous section) is an ActiveX component that you can drop 
  on an HTML page. It allows you to bind one or more elements on the page to the 
  remote data source. This object is included in the Msadco.dll library and 
  encompasses the functionality in both RDS.DataSpace and RDSServer.DataFactory. 

  <P></P>
<p></p><li> <I>ADOR.Recordset</I> is 
  functionally similar to a regular ADO Recordset, but it takes fewer resources 
  and is therefore a better choice when the application runs inside the browser 
  and doesn't need the full power and versatility of ADO. This object is exposed 
  by the Microsoft ActiveX Data Object Recordset library (Msador15.dll). The 
  ADOR library also includes the Field and the Property objects, but not the 
  Connection and Command objects. This library is automatically installed with 
  Internet Explorer, so it never requires you to download and install it on the 
  client workstation. 
  <P></P>          
            
            
            
          
           
           
           
</li>
</UL>

<p><div class="note"><blockquote><b>NOTE</b><hr>
Just to give you an idea about the relative weight of the ADOR 
library compared to the regular ADO library, compare these facts: The Msador15.dll 
file a mere 37 KB in size, whereas the full-fledged Msado15.dll file is 332 KB.
</blockquote></div>
<P></P>

<p>
<A href="javascript:fullSize('F19ph19x.htm')"> <IMG alt="Click to view at full  size." border    =0 height=118 src="images/F19ph19.JPG" width=404 > </A>
</p><p>
<!--caption--><B>Figure 19-19.</B> <I>All the objects that partake of a typical RDS session.</I><!--/caption-->
</p>

<A NAME="975"><h3>Establishing a connection</h3></A>

<p>If you're accustomed to the ADO way of doing things, the approach you must 
follow with RDS to establish a connection might seem at first unnatural and 
unnecessarily complex. But it has its inner logic and also offers a lot of flexibility.
</p>

<p>Before trying the code that follows in the Visual Basic IDE, add a reference 
to the RDS and the ADOR libraries in the References dialog box. The next step is to 
create an instance of the RDS.DataSource object and use its 
<I>CreateObject </I>method to create an instance of the remote RDSServer.DataFactory object. You don't need to add 
a reference to the RDSServer library because you're going to assign the return 
value of the <I>CreateObject </I>method to a generic Object variable.
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Dim ds As New RDS.DataSpace
Dim df As Object
Set df = ds.CreateObject("RDSServer.DataFactory", _
    "http://www.yourserver.com")
</pre>
</td></tr>
</table></p>


<p><div class="note"><blockquote><b>NOTE</b><hr>
All the examples in this section are written in Visual Basic code 
running inside a standard Visual Basic application or a DHTMLPage designer 
module. You can easily convert the code so that it runs as a script in an HTML 
page by dropping the <I>As </I>clause in all the 
<I>Dim </I>statements and using the <I>CreateObject 
</I>method instead of the <I>New </I>keyword.
</blockquote></div>
<P></P>

<p>The second argument of the RDS.DataSpace's 
<I>CreateObject</I> method can be an HTTP or HTTPS URL address, the name of another computer in the network, or 
an empty string if you're instantiating a DataFactory object on the same machine on 
which the program is running.
</p>

<p>After you've obtained a reference to a valid RDSServer.DataFactory object, 
you can use its <I>Query </I>method to actually retrieve the Recordset object that contains 
the result of the query:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Dim rs As ADOR.Recordset
Set rs = df.Query("DSN=Pubs", "SELECT * FROM Publishers")
</pre>
</td></tr>
</table></p>


<p>The first argument of the <I>Query </I>method is the connection string that the 
DataFactory object will use to connect to the data source, so you can use all the arguments 
you would use for the <I>ConnectionString </I>property of an ADO.Connection object. 
Don't forget that this connection string will be used by a component that already runs 
on the server (so you don't need a lengthy timeout value), and ensure that you're 
referring to a DSN or other connection attributes that are valid for that particular server.
</p>

<A NAME="976"><h3>Displaying and updating data</h3></A>

<p>You can use the ADOR.Recordset object as you would use a regular ADO 
Recordset because the differences between the two objects are minimal. (See ADO 
documentation for more details.) You can navigate the Recordset and update its fields, but 
all your changes are cached locally. Because you don't have bound controls, you 
must provide the code that moves data to and from the Recordset and the fields in the 
page. It turns out that you can take advantage of the 
<I>dataFld </I>property even when the control isn't bound to a data source. In fact, you can assign the name of the field that 
you want to display in the control to this property and then move data back and 
forth using the following routines:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' You can reuse these routines in any DHTMLPage module.
Sub GetFieldData()
    ' Move data from the Recordset to the fields in the page.
    ' All the "pseudo-bound" controls have a nonempty DataFld property,
    ' so you just need to iterate on the "all" collection.
    Dim ctrl As Object
    On Error Resume Next
    For Each ctrl In Document.All
        If Len(ctrl.dataFld) = 0 Then
            ' Empty or unsupported DataFld property.
        Else
            ' Append an empty string to account for Null values.
            ctrl.Value = rs(ctrl.dataFld) &amp; ""   
        End If
    Next
End Sub

Sub PutFieldData()
    ' Move data from the fields in the page to the Recordset.
    Dim ctrl As Object
    On Error Resume Next
    For Each ctrl In Document.All
        If Len(ctrl.dataFld) = 0 Then
            ' Empty or unsupported DataFld property.
        ElseIf rs(ctrl.dataFld) &amp; "" &lt;&gt; ctrl.Value Then
            ' Don't update the Recordset if it isn't necessary.
            rs(ctrl.dataFld) = ctrl.Value
        End If
    Next
End Sub
</pre>
</td></tr>
</table></p>


<p>Thanks to these routines, it's easy to write the code associated with 
navigational buttons. For example, this is the code that executes when the user clicks 
on the Next button:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>Private Function btnMoveNext_onclick() As Boolean
    PutFieldData                   ' Save current values.
    rs.MoveNext                    ' Move to the next record.
    If rs.EOF Then rs.MoveLast     ' Go back if you moved too far.
    GetFieldData                   ' Display the current record.
End Function
</pre>
</td></tr>
</table></p>


<p>When you're ready to submit changes to the server, you must invoke 
the <I>SubmitChanges </I>method of the RDSServer.DataFactory object. This method 
expects the connection string and a reference to the Recordset that must be marshaled 
back to the data source:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' Specify that you want to marshal only modified values.
rs.MarshalOptions = adMarshalModifiedOnly
' Send modified values to the server.
df.SubmitChanges conn, rs
</pre>
</td></tr>
</table></p>


<p>The <I>SubmitChanges </I>method fails if there were conflicts in just one single 
record. In this circumstance, the RDS library is far less sophisticated than the ADO 
library because in the ADO library you can manage conflicts on a record-by-record basis.
</p>

<A NAME="977"><h2>Custom Business Components</h2></A>

<p>Remote Data Services technology promises much more than a way to move 
a Recordset back and forth between the server and the client. In fact, the 
DataSource's <I>CreateObject </I>method can instantiate 
<I>any </I>ActiveX component that resides on the 
Web server. In a sense, you might consider RDS the extension of DCOM to the HTTP 
and HTTPS protocols. This new technique opens up a new world of opportunities for 
the brave programmer.
</p>

<p>From this perspective, the RDSServer.DataFactory object is just one of the 
many components that can be instantiated on the Web server and deserves special 
attention only because it's provided in the RDS package. But when you dive into 
the production of real world applications, you see that this component has one 
defect: Once the client has created a link to the server, it can query 
<I>any </I>database on that server, provided that it has a correct user name and password. In fact, using a 
trial-and-error approach, a client equipped this way can discover user names and 
passwords it doesn't have. This security scheme is inadequate for a Web server, which 
is exposed to attack from any browser in the world.
</p>

<p><div class="note"><blockquote><b>NOTE</b><hr>
RDS allows a (limited) customization of the behavior of 
the RDSServer.DataFactory object through a default handler object 
named MSDFMAP.Handler or through a custom handler object that you provide. 
The default handler can be controlled by editing the msdfmap.ini configuration 
file in the Windows directory. Open this file with an editor to get an idea of 
what you can achieve with this object, and read the RDS documentation for 
additional details.
</blockquote></div>
<P></P>

<p>The solution to the security problem is to build a custom ActiveX 
component and install it on the Web server. Such a component can expose—through its 
properties and methods—only the data that you want to make available to the 
outside. Additionally, because client workstations access the database through this 
custom component, you have all the benefits of a three-tier architecture:
</p>

<UL>
<p><li> The code in client applications is simplified because 
  the custom component can expose higher level methods that access and process 
  data. 
  <P></P>
<p></p><li> The clients never see the physical structure of the 
  database on the server, so you can change the implementation of the database 
  without worrying about any adverse impact on clients. 
  <P></P>
<p></p><li> The component can process data locally before 
  returning a result to a client, which often makes for a better overall 
  performance. 
  <P></P>            
         
</li>
</UL>

<A NAME="978"><h3>Writing a custom component</h3></A>

<p>A custom component intended to be instantiated via a RDS.DataSpace's 
<I>CreateObject </I>method isn't really different from a regular ActiveX component, so you can make 
use of all you've learned in <A href="ch16a.htm">Chapter 16</a>. The component should expose methods 
that enable the client to execute a query and send new and updated records back 
to the component.
</p>

<p>On the companion CD, you'll find a simple ActiveX DLL component 
named NWindFactory.Shipper. This component lets a Web client query the Shippers 
table in the NWind.mdb database installed on the server computer. The component 
exposes just three methods: <I>GetShippers </I>returns a disconnected ADOR.Recordset with all 
the records in the Shippers table, <I>UpdateShippers 
</I>updates the table with values from the ADOR.Recordset passed to it in its argument, and 
<I>GetEmptyShippers </I>returns an empty ADOR.Recordset that the client can use to insert information about new shippers. 
This is the complete source code of the component:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' This is the path of the NWind.mdb database on the server.
Const DBPATH = "C:\Program Files\Microsoft Visual Studio\Vb98\NWind.mdb"
Dim conn As String

Private Sub Class_Initialize()
    ' Initialize the connection string.
    conn = "Provider=Microsoft.Jet.OLEDB.3.51;Data Source=" &amp; DBPATH
End Sub

' Return the Shippers table in a Recordset object.
Function GetShippers() As ADOR.Recordset
    Dim rs As New ADOR.Recordset
    ' Query the Shippers table.
    rs.CursorLocation = adUseClient
    rs.Open "SELECT * FROM Shippers", conn, adOpenStatic, _
        adLockBatchOptimistic
    ' Disconnect the Recordset.
    Set rs.ActiveConnection = Nothing
    Set GetShippers = rs
End Function

' Update the Shippers table with data contained in a Recordset.
Function UpdateShippers(rs As ADOR.Recordset) As Boolean
    On Error Resume Next
    rs.ActiveConnection = conn           ' Reconnect the Recordset.
    rs.UpdateBatch                       ' Perform the updates.
    Set rs.ActiveConnection = Nothing    ' Disconnect it once again.
    UpdateShippers = (Err = 0)           ' Return True if everything is OK.
End Function

' Return an empty Recordset.
Function GetEmptyShippers() As ADOR.Recordset
    Dim rs As New ADOR.Recordset
    ' Retrieve an empty Recordset from the Shippers table.
    rs.CursorLocation = adUseClient
    ' Notice the WHERE clause in the following SQL SELECT command.
    rs.Open "SELECT * FROM Shippers WHERE 0", conn, adOpenStatic, _
        adLockBatchOptimistic
    ' Disconnect the Recordset.
    Set rs.ActiveConnection = Nothing
    Set GetEmptyShippers = rs
End Function
</pre>
</td></tr>
</table></p>


<p>For better results, you should compile your custom ActiveX DLL 
components using the Unattended Execution option and the Apartment Threading model. 
Both these options are in the General tab of the Project Properties dialog box.
</p>

<A NAME="979"><h3>Registering the component</h3></A>

<p>To make the ActiveX custom component available for installation through RDS, 
you have to take one more step. Not all the components installed on the server can 
be instantiated from an Internet client because it would be very difficult to enforce 
decent security. Only the components that are listed under a given key in the server's 
Registry can be instantiated through RDS. More precisely, you must create the 
following key in the server's Registry:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W3SVC\Parameters\
    ADCLaunch\&lt;servername.classname&gt;
</pre>
</td></tr>
</table></p>


<p>Notice that this key has no value. Moreover, a component for RDS should 
be marked as Safe For Scripting and Safe For Initialization, which means adding 
two more keys to the Registry, as explained in the section "<A href="ch17e.htm#880">Component Download</A>" 
in Chapter 17.
</p>

<p>When you're building the installation package of a component, the best 
way to go is to prepare a REG file that patches the Registry automatically. For 
example, the next code snippet is the REG file for the sample NWindFactory.Shippers 
component. The first entry marks the component as an object that can be instantiated 
through the RDS.DataSpace's <I>CreateObject </I>method, whereas the remaining two entries 
mark it with the Safe For Scripting and Safe For Initialization settings. When you create a REG file for your 
own component, you have to substitute the "NWindFactory.Shippers" string with the component's ProgID, and the string {03C410F7-C7FD-11D2-BAC5-0080C8F21830} with the component's CLSID.
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>REGEDIT4
[HKEY_LOCAL_MACHINE\System\CurrentControlSet\Services\W3SVC\Parameters\
    ADCLaunch\NWindFactory.Shippers]
[HKEY_CLASSES_ROOT\CLSID\{03C410F7-C7FD-11D2-BAC5-0080C8F21830}\
    Implemented Categories\{7DD95801-9882-11CF-9FA9-00AA006C42C4}]
[HKEY_CLASSES_ROOT\CLSID\{03C410F7-C7FD-11D2-BAC5-0080C8F21830}\
    Implemented Categories\{7DD95802-9882-11CF-9FA9-00AA006C42C4}]
</pre>
</td></tr>
</table></p>


<p>You don't need to create a key for the RDSServer.DataFactory object 
because the Registry patching is part of the RDS installation package on the server.
</p>

<A NAME="980"><h3>Using the component</h3></A>

<p>Using a custom component via RDS is similar to using the 
RDSServer.DataFactory object. You just have to create an instance of your component through 
the RDS.DataSpace object's <I>CreateObject</I> and then use your component's methods 
to retrieve and update the Recordset. Because your clients never have to directly 
perform queries on the database, they simply need to reference the ADOR 
lightweight library instead of the full-fledged ADO library.
</p>

<p>Figure 19-20 shows the demonstration client application. Its three 
TextBox controls are dynamically bound to the Recordset retrieved from the component. 
This is a partial listing of the code in the main form of the application:
</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>' Modify this constant to point to your Web server, 
' or use an empty string to connect to a local component.
Const WEB_SERVER = "www.yourserver.com"

Dim ds As New RDS.DataSpace
Dim myObj As Object
Dim rs As ADOR.Recordset

Private Sub Form_Load()
    ' Create the remote component.
    Set myObj = ds.CreateObject("NWindFactory.Shippers", WEB_SERVER)
End Sub

Private Sub cmdGetShippers_Click()
    ' Ask the component to query the table and then return a Recordset.
    Set rs = myObj.GetShippers()
    ' Bind the controls to this Recordset.
    SetDataSource rs
End Sub

Private Sub cmdGetEmptyShippers_Click()
    ' Ask the component to create an empty Recordset.
    Set rs = myObj.GetEmptyShippers()
    ' Bind the controls to this Recordset.
    SetDataSource rs
End Sub

Private Sub cmdUpdateShippers_Click()
    ' This optimizes the update operation.
    rs.MarshalOptions = adMarshalModifiedOnly    
    ' Pass the updated Recordset to the component, and test the result.
    If myObj.UpdateShippers(rs) Then
        MsgBox "Update successful", vbExclamation
    Else
        MsgBox "Unable to update!", vbCritical
    End If
End Sub

Sub SetDataSource(obj As Object)
    ' Use the Recordset as a data source for the fields.
    Set txtShipperID.DataSource = obj
    Set txtCompanyName.DataSource = obj
    Set txtPhone.DataSource = obj
End Sub
</pre>
</td></tr>
</table></p>


<p>
<IMG border=0 height=278 src="images/F19ph20x.gif" width=404>
</p><p>
<!--caption--><B>Figure 19-20.</B> <I>A demonstration application using dynamically bound controls.</I><!--/caption-->
</p>

<p>You can optimize the update process using the Recordset's 
<I>MarshalOptions </I>property; if you set this property to 1-adMarshalModifiedOnly, only the records 
that have been modified, added, or deleted are transferred back to the server. If the 
update operation fails, you can figure out what happened by checking the 
<I>Status </I>property for each record in the Recordset. For all the records that weren't successfully 
updated, this property returns a value different from adRecUnmodified.
</p>
<p><div class="note"><blockquote><b>NOTE</b><hr>
Don't forget that offering a custom component for querying and manipulating a database on the Web server doesn't mean that you've solved all your security problems. For example, a client might connect through the standard RDSServer.DataFactory object, and if he or she happens to know a valid login name and password, your data is at stake. For this reason, you might decide to disable the remote instantiation of the RDSServer.DataFactory object by deleting the corresponding entry in the ADCLaunch key of the Registry.

</blockquote></div>
<P></P>

</BODY>
</HTML>





