<HTML>
<HEAD>
<TITLE>Raw Socket Creation</title>
<link rel="STYLESHEET" type="text/css" href="Library.css">


</head>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch13a.htm" , "ch13c.htm", "images/unit_o_a1.gif", "images/unit_o_a2.gif", "images/unit_o_b1.gif", "images/unit_o_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#ff9900", "2");
//--></SCRIPT>



<A NAME="405"><H1>Raw Socket Creation</H1></A>

<p>The first step in using raw sockets is creating the socket. You can use either <i>socket</i> or <i>WSASocket</i>. Note that typically, no catalog entry in Winsock for IP has the <i>SOCK_RAW</i> socket type. However, this does not prevent you from creating this type of socket. It just means that you cannot create a raw socket using a <i>WSAPROTOCOL_INFO</i> structure. Refer back to <a href="ch05a.htm">Chapter 5</A> for information on enumerating protocol entries with the <i>WSAEnumProtocols</i> function and the <i>WSAPROTOCOL_INFO</i> structure. You must specify the <i>SOCK_RAW</i> flag yourself in socket creation. The following code snippet illustrates the creation of a raw socket using ICMP as the underlying IP protocol.</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>
SOCKET    s;

s = socket(AF_INET, SOCK_RAW, IPPROTO_ICMP);
// Or
s = WSASocket(AF_INET, SOCK_RAW, IPPROTO_ICMP, NULL, 0, 
    WSA_FLAG_OVERLAPPED);
if (s == INVALID_SOCKET)
{
    // Socket creation failed
}
</pre>
</td></tr></table>
</p>

<p>Because raw sockets offer the ability to manipulate the underlying transport, they can be used for malicious purposes and are a security issue in Windows NT. Therefore, only members of the Administrators group can create sockets of type <i>SOCK_RAW</i>. Windows 95 and Windows 98 do not impose any kind of limitation.</p>

<p>To work around this problem in Windows NT, you can disable the security check on raw sockets by creating the following registry variable and setting its value to the integer 1 as a <i>DWORD</i> type.</p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>
HKEY_LOCAL_MACHINE\System\CurrentControlSet
    \Services\Afd\Parameters\DisableRawSecurity
</pre>
</td></tr></table>
</p>

<p>After the registry change, you need to reboot the machine.</p>

<p>In the above code example, we used the ICMP protocol, but you can also use IGMP, UDP, IP, or raw IP using the flags <i>IPPROTO_IGMP</i>, <i>IPPROTO_UDP</i>, <i>IPPROTO_IP</i>, or <i>IPPROTO_RAW</i>, respectively. However, be aware of one limitation: On Windows NT 4, Windows 98, and Windows 95 (with Winsock 2), you can use only IGMP and ICMP when creating raw sockets. The protocol flags <i>IPPROTO_UDP</i>, <i>IPPROTO_IP</i>, and <i>IPPROTO_RAW</i> require the use of the socket option <i>IP_HDRINCL</i>, which is not supported on those platforms. Windows 2000 does, however, support <i>IP_HDRINCL</i>, so it is possible to manipulate the IP header itself (<i>IPPROTO_RAW</i>), the TCP header (<i>IPPROTO_TCP</i>), and the UDP header (<i>IPPROTO_UDP</i>).</p>

<p>Once the raw socket is created with the appropriate protocol flags, you can use the socket handle in send and receive calls. When creating raw sockets, the IP header will be included in the data returned upon any receive, regardless of whether the <i>IP_HDRINCL</i> option is set.</p>

</BODY>
</HTML>




