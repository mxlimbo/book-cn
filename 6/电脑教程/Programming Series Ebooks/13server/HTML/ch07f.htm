<HTML>
<HEAD>
<TITLE>Debugging Your Performance Counter DLL</TITLE>
<link rel="STYLESHEET" type="text/css" href="prosrvwin.css">
<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<BODY BGCOLOR = "#ffffff">
<A HREF="ch07e.htm">[Previous]</A> <A HREF="ch07g.htm">[Next]</A><P>

<A NAME="114"><h1>Debugging Your Performance Counter DLL</h1></A>
<p>As you can see, the data block produced by your DLL's <i>Collect</i> function is complex, and it usually takes most developers quite some time to completely debug it. To help you out, Microsoft has added some support in the operating system to analyze <i>Collect</i> function behavior. If the system detects any problem, it will generate an entry into the system's Application event log. Figure 7-11 provides an example.</p>

<p>
<img src="images/F07FJ11.JPG" width=404 height=448 border="0">
</p><p>
<!-- caption --><b>Figure 7-11.</b> <i>A performance DLL error reported to the Application Log</i><!-- /caption -->
</p>

<p>By default, the system does not perform this additional checking because it adversely affects the speed of retrieving performance counter data. To turn on this checking, go to the subkey in the registry that is listed here.</p>

<p>
<table cellpadding="5" width="95%"><tr><td><pre>
HKEY_LOCAL_MACHINE\SOFTWARE\Microsoft\Windows NT\CurrentVersion\Perflib
</pre></td></tr></table>
</p>

<p>Under this key, add a REG_DWORD value named ExtCounterTestLevel and set it to one of the values listed in Table 7-4.</p>

<p><b>Table 7-4.</b> <i>ExtCounterTestLevel values that specify levels of performance data testing</i></p>

<p>
<table cellpadding=5 width="95%">
<tr> 
<th>Value  </th>
<th>Description  </th></tr>
<tr>
<td valign="top">1   </td>
<td valign="top">The system should check all object and counter lengths for consistency.  </td></tr>
<tr>
<td valign="top">2   </td>
<td valign="top">The system should check for buffer overflows and guard pages.  </td></tr>
<tr>
<td valign="top">3   </td>
<td valign="top">The system should not perform any checking.  </td></tr>
<tr>
<td valign="top">4   </td>
<td valign="top">Don't even allocate a guard page. This is the default if this registry value does not exist.  </td></tr>
</table></p>

<p>Whenever the system detects a problem with performance data, it writes an entry to the system's Application Log. You can control the nature of this entry: under the same registry subkey, create a REG_DWORD value named EventLogLevel and set it to one of the values listed in Table 7-5.</p>

<p><b>Table 7-5.</b> <i>EventLogLevel values that specify what events should be recorded in the event log</i></p> 

<p>
<table cellpadding=5 width="95%">
<tr> 
<th>Value  </th>
<th>Description  </th>
<th>Event ID Range  </th></tr>
<tr>
<td valign="top">0   </td>
<td valign="top">The system should never report anything to the event log. </td>
<td valign="top">(not applicable)  </td></tr>
<tr>
<td valign="top">1   </td>
<td valign="top">The system should report user-related events in the event log. </td>
<td valign="top">1000-1015,<br> 1017-1020 </td></tr>
<tr>
<td valign="top">2   </td>
<td valign="top">The system should report warnings and errors in the event log. </td>
<td valign="top">1000-1015, <br>1017-1020,<br>1016, 2000-2003 </td></tr>
<tr>
<td valign="top">3   </td>
<td valign="top">The system should report information events as well as warnings and errors in the event log. </td>
<td valign="top">1000-1015,<br>  1017-1020,<br>1016, 2000-2002,<br>3000-3001  </td></tr>
</table></p>


<p>Table 7-6 shows the types of events that can be placed in the event log.</p> 

<p><b>Table 7-6.</b> <i>Events that indicate performance data problems</i></p>

<p>
<table cellpadding=5 width="95%">
<tr> 
<th>Event ID  </th>
<th>Description  </th></tr>
<tr>
<td valign="top">1000  </td>
<td valign="top">Access to performance data was denied to &lt;username&gt; as attempted from &lt;calling module name&gt;  </td></tr>
<tr>
<td valign="top">1001  </td>
<td valign="top">The buffer size returned by a collect procedure in Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service was larger than the space available. Performance data returned by counter DLL will not be returned in Perf Data Block. Overflow size is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1002  </td>
<td valign="top"> A Guard Page was modified by a collect procedure in Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service. Performance data returned by counter DLL will not be returned in Perf Data Block. </td></tr>
<tr>
<td valign="top">1003  </td>
<td valign="top">The object length of an object returned by Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service was not correct. The sum of the object lengths returned did not match the size of the buffer returned. Performance data returned by counter DLL will not be returned in Perf Data Block. Count of objects returned is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1004  </td>
<td valign="top"> The instance length of an object returned by Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service was incorrect. The sum of the instance lengths plus the object definition structures did not match the size of the object. Performance data returned by counter DLL will not be returned in Perf Data Block. The object title index of the bad object is data DWORD 0. </td></tr>
<tr>
<td valign="top">1005  </td>
<td valign="top">Unable to locate the open procedure &quot;&lt;open proc name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service. Performance data for this service will not be available. Error Status is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1006   </td>
<td valign="top">Unable to locate the collect procedure &quot;&lt;collect proc name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service. Performance data for this service will not be available. Error Status is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1007  </td>
<td valign="top">Unable to locate the close procedure &quot;&lt;close proc name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service. Performance data for this service will not be available. Error Status is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1008   </td>
<td valign="top">The Open Procedure for service &quot;&lt;service name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; failed. Performance data for this service will not be available. Status code returned is DWORD 0.  </td></tr>
<tr>
<td valign="top">1009  </td>
<td valign="top">The Open Procedure for service &quot;&lt;service name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; generated an exception. Performance data for this service will not be available. Exception code returned is DWORD 0.  </td></tr>
<tr>
<td valign="top">1010   </td>
<td valign="top">The Collect Procedure for the &quot;&lt;service name&gt;&quot; service in DLL &quot;&lt;dll name&gt;&quot; generated an exception or returned an invalid status. Performance data returned by counter DLL will not be returned in Perf Data Block. Exception or status code returned is DWORD 0.  </td></tr>
<tr>
<td valign="top">1011  </td>
<td valign="top">The library file &quot;&lt;dll name&gt;&quot; specified for the &quot;&lt;service name&gt;&quot; service could not be opened. Performance data for this service will not be available. Status code is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1012   </td>
<td valign="top">The system reported an idle process time that was less than the last time reported. The data shows the current time and the last reported time for the system's idle process.  </td></tr>
<tr>
<td valign="top">1013  </td>
<td valign="top">The collect procedure in Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service returned a buffer that was larger than the space allocated and may have corrupted the application's heap. This DLL should be disabled or removed from the system until the problem has been corrected to prevent further corruption. The application accessing this performance data should be restarted. The Performance data returned by counter DLL will not be returned in Perf Data Block. Overflow size is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1014   </td>
<td valign="top">An error occurred while trying to collect data from the Server Object. The Error code returned by the function is DWORD 0. The Status returned in the IO Status Block is DWORD 1. The Information field of the IO Status Block is DWORD 2.  </td></tr>
<tr>
<td valign="top">1015   </td>
<td valign="top">The timeout waiting for the performance data collection function &quot;&lt;function name&gt;&quot; in the &quot;&lt;dll name&gt;&quot; Library to finish has expired. There may be a problem with this extensible counter or the service it is collecting data from or the system may have been very busy when this call was attempted.  </td></tr>
<tr>
<td valign="top">1016  </td>
<td valign="top">The data buffer created for the &quot;&lt;service name&gt;&quot; service in the &quot;&lt;dll name&gt;&quot; library is not aligned on an 8-byte boundary. This may cause problems for applications that are trying to read the performance data buffer. Contact the manufacturer of this library or service to have this problem corrected or to get a newer version of this library.  </td></tr>
<tr>
<td valign="top">1017   </td>
<td valign="top">Performance counter data collection from the &quot;&lt;service name&gt;&quot; service has been disabled due to one or more errors generated by the performance counter library for that service. The error(s) that forced this action have been written to the application event log. The error(s) should be corrected before the performance counters for this service are enabled again.  </td></tr>
<tr>
<td valign="top">1018  </td>
<td valign="top">Performance counter data collection from the &quot;&lt;service name&gt;&quot; service has been disabled for this session due to one or more errors generated by the performance counter library for that service. The error(s) that forced this action have been written to the application event log.  </td></tr>
<tr>
<td valign="top">1019   </td>
<td valign="top">A definition field in an object returned by Extensible Counter DLL &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service was incorrect. The sum of the definitions block lengths in the object definition structures did not match the size specified in the object definition header. Performance data returned by this counter DLL will be not be returned in Perf Data Block. The object title index of the bad object is data DWORD 0.  </td></tr>
<tr>
<td valign="top">1020  </td>
<td valign="top">The size of the buffer used is greater than that passed to the collect function of the &quot;&lt;dll name&gt;&quot; Extensible Counter DLL for the &quot;&lt;service name&gt;&quot; service. The size of the buffer passed in is data DWORD 0 and the size returned is data DWORD 1.  </td></tr>
<tr>
<td valign="top">2000   </td>
<td valign="top">The pointer returned did not match the buffer length returned by the Collect procedure for the &quot;&lt;service name&gt;&quot; service in Extensible Counter DLL &quot;&lt;dll name&gt;&quot;. The Length will be adjusted to match and the performance data will appear in the Perf Data Block. The returned length is data DWORD 0, the new length is data DWORD 1.  </td></tr>
<tr>
<td valign="top">2001   </td>
<td valign="top">The &quot;&lt;service name&gt;&quot; service does not have a Performance subkey or the key could not be opened. No performance counters will be collected for this service. The Win32 error code is returned in the data.  </td></tr>
<tr>
<td valign="top">2002   </td>
<td valign="top">The open procedure for service &quot;&lt;service name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; has taken longer than the established wait time to complete. There may be a problem with this extensible counter or the service it is collecting data from or the system may have been very busy when this call was attempted.  </td></tr>
<tr>
<td valign="top">2003  </td>
<td valign="top">The configuration information of the performance library &quot;&lt;dll name&gt;&quot; for the &quot;&lt;service name&gt;&quot; service does not match the trusted performance library information stored in the registry. The functions in this library will not be treated as trusted.  </td></tr>
<tr>
<td valign="top">3000   </td>
<td valign="top">Open procedure for service &quot;&lt;service name&gt;&quot; in DLL &quot;&lt;dll name&gt;&quot; was called and returned successfully.  </td></tr>
<tr>
<td valign="top">3001   </td>
<td valign="top">An updated performance counter library file has been detected. The performance counters for the &quot;&lt;dll name&gt;&quot; have been enabled.  </td></tr>
</table></p>


<p>You'll notice that some of the events listed in Table 7-6 have to do with timing. For example, if the DLL's <i>Open</i> function takes too long to return, the system assumes that something is wrong with the performance-counter DLL and generates an event with ID 2002. Set the OpenProcedureWaitTime value in the registry to let the system know how long it should wait before reporting this event. This value is listed under the same registry subkey as the other two values (ExtCounterTestLevel and EventLogLevel). Furthermore, this value is also a REG_DWORD value that you set to the number of milliseconds that will be good enough for all <i>Open</i> functions.</p>

<p>
<div class="note"><blockquote><b>NOTE</b><hr>
This value affects only how long the system should wait to generate the event log entry. Setting a timeout does not force the system to abandon the <i>Open</i> function and do something else. If the <i>Open</i> function does not return, the application requesting the performance data stops executing.</blockquote></div>
</p>

<p>Whereas a single registry value is used for all <i>Open</i> functions, each performance-counter DLL can set a unique <i>Collect</i> function timeout value. To set a time limit (in milliseconds) for your DLL's <i>Collect</i> function, create a REG_DWORD registry value named Collect Timeout. (The space between the words is mandatory.) This value must be placed in the following subkey:</p>

<p>
<table cellpadding="5" width="95%"><tr><td><pre>
HKEY_LOCAL_MACHINE\SYSTEM\CurrentControlSet\Services\<i>ServiceName</i>\Performance
</pre></td></tr></table>
</p>

<p>Again, the <i>ServiceName</i> portion of this subkey is the part that uniquely identifies your service or application performance data. If your DLL's <i>Collect</i> function doesn't return in the specified number of milliseconds, an event ID 1015 is added to the system's Application Log.</p>

</BODY>
</HTML>




