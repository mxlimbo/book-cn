<HTML>
<HEAD>
<TITLE>Deleting a Service from the SCM's Database</TITLE>
<link rel="STYLESHEET" type="text/css" href="prosrvwin.css">
<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<BODY BGCOLOR = "#ffffff">
<A HREF="ch04b.htm">[Previous]</A> <A HREF="ch04d.htm">[Next]</A><P>

<A NAME="66"><H1>Deleting a Service from the SCM's Database</H1></A>
<p>Every good software package supports uninstall just as well as it supports 
install. So you'll need to know how to remove a service too. To remove a 
service, you must first open it:</p>

<p>
<table cellpadding=5 width="95%"><tr><td><pre>
SC_HANDLE OpenService(
   SC_HANDLE hSCManager,
   PCTSTR    pszInternalName,
   DWORD     dwDesiredAccess);
</pre></td></tr></table>
</p>

<p>To the <I>OpenService</I> function, you pass the handle returned 
from <I>OpenSCManager</I>, followed by the internal name of the service (the same 
value that you passed in <I>CreateService</I>'s 
<I>pszServiceName </I>parameter), and then DELETE 
for the desired access. Now that you have the handle to the specific service, 
you can delete the service by calling 
<I>DeleteService</I>, passing the handle returned 
from <I>OpenService</I>:</p>

<p>
<table cellpadding=5 width="95%"><tr><td><pre>
BOOL DeleteService(SC_HANDLE hService);
</pre></td></tr></table>
</p>

<p><I>DeleteService</I> does not actually delete the service right away; it simply 
marks the service for deletion. The SCM will delete the service only when the 
service stops running and after all open handles to the service have been closed.</p>

<p>I also write my service executables so that they can delete their services 
from the SCM's database. If &quot;-remove&quot; is passed as a command-line argument, I 
call a function such as <I>ServiceRemove</I>, shown here:</p>

<p>
<table cellpadding=5 width="95%"><tr><td><pre>
void ServiceRemove(PCTSTR pszInternalName) {

   // Open the SCM database
   SC_HANDLE hSCM = OpenSCManager(NULL, NULL, SC_MANAGER_CONNECT);

   // Open the service for delete access
   SC_HANDLE hService = OpenService(hSCM, pszInternalName, DELETE);

   // Mark the service for deletion
   // NOTE: The service is not deleted until all handles
   // to it are closed and the service stops running
   DeleteService(hService);

   // Close the service and the SCM
   CloseServiceHandle(hService);
   CloseServiceHandle(hSCM);
}
</pre></td></tr></table>
</p>

<p>
<div class="note"><blockquote><b>NOTE</b><hr>     For clarity, the preceding code does not have any error 
checking. <I>OpenSCManager</I>, <I>OpenService</I>, and 
<I>DeleteService </I>can fail for many reasons. Please add the proper error checking when adding code like 
this into your own application.
</blockquote></div>
</p>

</BODY>
</HTML>




