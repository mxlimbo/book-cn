<HTML>
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='images/cpcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 魔鬼辞典</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span>
<ol>
  <li><A NAME='top'></A> </li>
</ol>
<TABLE BORDER='0' WIDTH='468' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'>
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='468' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'><IMG SRC='images/yjds.gif' WIDTH='468' HEIGHT='60' ALT='广告Logo' BORDER='0'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='468' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='468' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='468' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='468' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font>CPCW电子版 
      &gt; 2000 年 &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->13期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; 实战Client server编程（下）</td>
  </tr>
</table>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'>
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='468' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 实战Client server编程（下）》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD> 
      <p> 　　<b>四、关于并发控制</b><br>
        　　<b>(一) 引言<br>
        </b> 　　对于Client/Server方式下的编程，不可避免地有并发操作的问题。举一个例子：如果有两个用户A和B都试图访问同一员工记录并同时要求修改该员工工资（salary字段）时，会有什么情况发生呢？假设该员工的工资为1000元，两台机器修改记录之前读出用户工资均正确，为1000元。A用户为此员工加本月奖金200元，变为1200；而此时B用户在不同的机器上扣除此员工的水电费50元，将salary字段置为950，显然这种修改是不能接受的，此员工的薪水正确操作结果应是1150元。<br>
        　　（<b>二）背景知识</b> <br>
        　　DataWindow是PowerBuilder中一个独特的对象，是Sybase的专利技术，功能强大，它可以方便而快速地处理数据。通过数据窗口，我们无需编写复杂的SQL语句，就可以实现对数据库的读写操作。<br>
        　　实际上DataWindow 在更新数据时，会根据用户对 DataWindow 中数据进行的各种操作自动地转换成 SQL 语句，然后再执行。例如：用户新增了一条记录，也就是脚本执行了InsertRow() 
        函数，输入数据后保存（调用 Update() 函数），此时 PB会将其自动转换成 SQL 语句，发送到数据库服务器。对于转换后的SQL语句，我们可以在DataWindow的sqlpreview事件中，加入脚本：<br>
        　　MessageBox(′SQL语句′,sqlsyntax)来查看。<br>
        　　这里需要注意：如果数据库连接的binding参数设定为enable，则sqlsyntax返回将不完整，插入一条记录时sqlsyntax呈如下形式：<br>
        　　INSERT INTO ″personnel″ ( ″id″, ″name″, ″birthday″, ″technical_post″, 
        ″salary″, ″notes″ ) VALUES ( ?, ?, ?, ?, ?, ? ) 　　为了正确返回sqlsyntax，须将binding参数设为disabled, 
        设置方法是在dbprofile对话框中，将transaction标签页的“Disable Bind”选项勾上，或者把在personnel.ini文件中的DbParm改为：<br>
        　　DbParm=Connectstring=′DSN=database_server′,DisableBind=1<br>
        　　则sqlsyntax的完整返回如下：<br>
        　　INSERT INTO ″personnel″ ( ″id″, ″name″, ″birthday″, ″technical_post″, 
        ″salary″, ″notes″ ) VALUES ( 100, ′令狐冲′, ′1975－05－01′, ′工程师′, 1000, ′软件开发′) 
        　<br>
        　　<b>（三）PowerBuilder中的并发控制</b><br>
        　　PowerBuilder中可以通过数据窗口的更新属性（Update Properties）来实现并发控制。打开 DataWindow 画笔板，点击 
        “Rows/Update Properties”菜单，进入Specify Updatae Properties对话框，其中“Where Clause 
        for Update/Delete”组合框中的三个选项就是三种处理并发控制问题的策略。<br>
        　　1．选项“Key Columns”<br>
        　　这种情况是比较更新前后Table的关键字是否发生了变化，即将数据表中当前关键字的实际值和最初查询的值做比较，如果没有改变，则可以更新，反之不能更新。<br>
        　　如用户A将员工号为100的职员的salary字段值改为1200并保存后，B用户也将员工号为100的职员的salary字段值改为950并点击“存盘”按钮，我们可以看到数据窗口sqlpreview事件中的sqlsyntax返回如：<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 <br>
        　　因为关键字id=100没有发生变化，Where条件成立，更新成功，B用户将A用户的修改覆盖，salary值变为950元，员工损失了200元。显然这样没有达到并发控制的目的，未能保证数据的完整性。<br>
        　　2．选项“Key and Updateable Column” <br>
        　　这种情况是比较更新前后数据表的关键字和可修改（更新）的列值是否发生了变化，如果没有一项发生改变，更新成功；反之，若数据库中当前值中若任一项与数据窗口最初检索出的值不一致，则更新失败。对于此例，因所有字段都是可修改（更新）的，即检测是否有任一字段变化。<br>
        　　同上，当用户A更新完后，B用户点击“存盘”按钮，我们可以看到sqlsyntax返回如：<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″name″ = 
        ′令狐冲′ AND ″birthday″ = ′1975－05－01′ AND ″technical_post″ = ′工程师′ AND ″salary″ 
        = 1000 AND ″notes″ = ′软件开发′<br>
        　　显然，id字段没有改变，而可修改（更新）列之一salary的值经A用户修改存盘后，已由1000变为了当前的1200，where条件不成立，因此更新失败，并弹出出错信息如下：<br>
        　　Row changed between retrieve and update. <br>
        　　No changes made to database.<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″name″ = 
        ′令狐冲′ AND ″birthday″ = ′1975－05－01′ AND ″technical_post″ = ′工程师′ AND ″salary″ 
        = 1000 AND ″notes″ = ′软件开发′<br>
        　　此时点击“刷新”按钮，我们可以看到，salary的值已为1200，达到了并发控制的目的，保证数据的完整性。<br>
        　　3．选项“Key and Modified Columns”<br>
        　　这种情况是比较更新前后Table的关键字和要修改（更新）的列值是否发生了变化，如果没有改变，更新成功，反之更新失败。对于本例，即判断关键字id和将要修改字段salary是否发生变化。<br>
        　　同上，当用户A更新完后，B用户点击“存盘”按钮，我们可以看到sqlsyntax返回如：<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″salary″ 
        = 1000 <br>
        　　这里id字段没有改变，而此次将要修改的列salary值已由1000变为了1200，where条件不成立，因此更新失败，并弹出出错信息如下：<br>
        　　Row changed between retrieve and update. <br>
        　　No changes made to database.<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″salary″ 
        = 1000 <br>
        　　此时我们点击“刷新”按钮，我们可以看到，salary的值仍为1200，也达到了并发控制的目的。<br>
        　　再举一个例子：<br>
        　　如果A用户更新的是备注notes字段，而B用户更新的是薪水salary字段，按照业务，这种操作是允许的，而在PowerBuilder中会如何处理呢？<br>
        　　1．对于选项“Key Columns” 因为关键字没有改变，更新成功。<br>
        　　2．对于选项“Key and Updateable Column”<br>
        　　当用户A更新完后，B用户点击“存盘”按钮，我们可以看到sqlsyntax返回如下：<br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″name″ = 
        ′令狐冲′ AND ″birthday″ = ′1975－05－01′ AND ″technical_post″ = ′工程师′ AND ″salary″ 
        = 1000 AND ″notes″ = ′软件开发′<br>
        　　这里，id字段没有改变，salary字段也没有改变，但可修改（更新）列之一notes的值经A用户的修改，已由“软件开发”变为了“硬件维护”，where条件不成立，因此更新失败，系统将报出错信息。<br>
        　　此时点击“刷新”按钮，可以看到，salary的值仍为1200，notes的值为“硬件维护”。<br>
        　　3．对于选项“Key and Modified Columns” <br>
        　　当用户A更新完后，B用户点击“存盘”按钮，我们可以看到sqlsyntax返回如下： <br>
        　　UPDATE ″personnel″ SET ″salary″ = 950 WHERE ″id″ = 100 AND ″salary″ 
        = 1000 <br>
        　　这里，id字段没有改变，而将要修改的列salary值也没有改变（A用户只是修改了notes字段），where条件成立，因此更新成功。<br>
        　　此时点击“刷新”按钮，可以看到，salary的值为950，notes的值为“硬件维护”。注意这里B用户只是修改salary字段，并不修改notes字段，因此notes保留了A用户修改后的值。<br>
        　　从上面例子中我们可以得出如下结论：<br>
        　　1．“Key Columns”选项在控制数据完整性方面最弱，它所允许的并发操作是最多的，所禁止的并发操作发生的可能性非常小，只有当主键被更改后才起并发控制作用，当一条记录的关键字改变了才进行控制，这显然没有多大意义。实际上这种方法一般只在单机版的应用程序中使用，而在Client/Server模式中是很少使用的。<br>
        　　2．“Key and Updateable Columns”的是PB的默认选项，控制最为严格，可以实现最安全的并发控制，充分保证数据的完整性，但它也会禁止我们做一些本当允许的并发修改（如上面所说的第二例），是并发能力最差的方法。<br>
        　　3．“Key and Modified Columns”选项可以说是前两选项的折衷，在控制数据完整性和严格性方面比第一项强，比第二项弱，在允许的并发操作数量方面比第一项少，比第二项多。<br>
        　　至于在程序中选取哪一种控制比较合适，我们应该根据应用的具体情况来选择。<br>
        　　对于并发控制，我们还需要在程序中捕获 DBMS 的出错号，再显示相应的错误信息，否则PowerBuilder给出的那些出错信息，一般用户是看不懂的。这项功能可在数据窗口的dberror事件中编写代码实现。<br>
        <b>　　五、结束语</b> <br>
        　　以上程序的运行环境如下：<br>
        　　开发工具：PowerBuilder6.5 <br>
        　　数据库：Sybase SQL Anywhere 5.0 　<br>
        　　操作系统：Windows98<br>
        　　网络：Windows98 局域网<br>
      </p>
      </TD>
  </TR>
</TABLE>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><A HREF='http://www.mydown.com/dnb/' TARGET='_blank'>下载本期推荐软件</A></TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='468' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='468' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD>&nbsp; 
      
       </TD>
    <TD> <A HREF='/'>CPCW版权所有</A>，<A HREF='mailto:webmaster@cpcw.com'>CPCW网站编辑部</A>设计制作发布</TD>
  </TR>
</TABLE>
</BODY></HTML>