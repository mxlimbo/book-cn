 
<HTML>
<!-- #BeginTemplate "/模板/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 --动态注册ODBC数据源的通用方法</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='http://www.yesky.com'><IMG SRC='images/logo.gif' WIDTH='140' HEIGHT='60' ALT='天极网' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com" target="_blank"><img src="images/0823-3.gif" width="468" height="60" border="0"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='http://www.cpcw.com/index.html'>CPCW电子版</a> 
      &gt; <a href='http://www.cpcw.com/all.html'>2000年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->40期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->{动态注册ODBC数据源的通用方法}<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->{动态注册ODBC数据源的通用方法}<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{　　本文以在Delphi 5.0中利用程序，动态生成并注册ODBC数据源为例，说明了一种通用的动态注册ODBC数据源的方法。此种方法实现简单，不但适用于Delphi，也适用于其它Windows下的开发工具。<br>
      一、引言<br>
      　　ODBC是微软于1993年推出的开放性数据库接口标准，它为不同数据库产品的访问和操作提供了一个统一的解决方案。作为一个开放标准，Windows平台下的许多数据库开发工具都支持通过ODBC方式来存取数据，如：Visual 
      C＋＋,PowerBuiler等。其它，如Borland的Delphi虽然通过BDE(Borland Database Engine)方式来访问数据，但ODBC配置的数据源，在BDE中也可以正确识别和使用。<br>
      　　一般，ODBC数据源的配置是通过Windows控制面板中ODBC管理器手工设置完成的，这一点给程序安装人员和用户都带来了许多不便。对用户来说，程序安装应该越简单越好。因此，对程序就提出了能够根据安装环境，自动注册所需ODBC数据源的要求。虽然，关于动态注册ODBC数据源的实现方法已屡见不鲜，但大多只适用于某种确定的开发工具和环境，且实现复杂，操作不便。经笔者试验，找到了一条简单有效而通用的配置ODBC数据源的方法。<br>
      　　实现原理： 通过导出开发环境下注册表中ODBC数据源信息到一注册表文件中，将所导出内容作为应用程序中的字符串常量进行保存。在程序运行时，如果发现ODBC数据源未正确注册，则根据环境信息和该字符串常量动态确定正确的注册表文件内容，并写入一临时注册表文件中；利用批处理文件将该文件中ODBC数据源信息导入系统注册表中，从而实现ODBC数据源的动态注册。<br>
      　　二、操作步骤<br>
      　　1．运行注册表编辑器程序（Regedit.exe）。<br>
      　　2．导出注册表中\HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\ODBC Data Sources下数据源名称信息到Reg1.reg文件中。注：该路径下存放的是用户定义的数据源信息，如果需要系统数据源信息，则可导出HKEY_Local_Machine\Software\ODBC.INI\ODBC 
      Data Sources到注册文件中。<br>
      　　3．导出要注册的数据源名称的具体连接参数信息到db2.reg中。在此，以导出名称为“PostMdb”的数据为例，具体路径: \HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\PostMdb。<br>
      　　4．用文本编辑器如(NotePad.exe)打开上述db1.reg文件，保留数据源名称为PostMdb的行；并将db2.reg文件内容与当前db1.reg内容合并。假设修改后“PostMdb”数据源注册信息如下：<br>
      　　REGEDIT4<br>
      　　[HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\ODBC Data Sources]<br>
      　　″PostMdb″=″Microsoft Access Driver (＊.mdb)″<br>
      　　[HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\PostMdb]<br>
      　　″Driver″=″C:\\WINDOWS\\SYSTEM\\ODBCJT32.DLL″<br>
      　　″DBQ″=″c:\\My Documents\\db1.mdb″<br>
      　　″Description″=″Post Card Mis Database″<br>
      　　″DriverId″=dword:00000019<br>
      　　″FIL″=″MS Access;″<br>
      　　″SafeTransactions″=dword:00000000<br>
      　　″UID″=″″<br>
      　　[HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\PostMdb\Engines]<br>
      　　[HKEY_CURRENT_USER\Software\ODBC\ODBC.INI\PostMdb\Engines\Jet]<br>
      　　″ImplicitCommitSync″=″″<br>
      　　″MaxBufferSize″=dword:00000800<br>
      　　″PageTimeout″=dword:00000005<br>
      　　″Threads″=dword:00000003<br>
      　　″UserCommitSync″=″Yes″<br>
      　　5．动态注册ODBC数据源的实现<br>
      　　从上述注册信息可以看出，对于特定的数据源来说，实际上要动态确定的只是“Driver”和“DBQ”两项内容。将“Driver”=“C:\\WINDOWS\\SYSTEM\\ODBCJT32.DLL”修改为“Driver”=“％s\\ODBCJT32.DLL”，将“DBQ”=“c:\\My 
      Documents\\db1.mdb”修改为“DBQ”=“％s\\db1.mdb”。复制修改后的注册信息到程序单元中存储为一字符串常量，命名为OdbcStr。以下以Delphi为例说明实现方法。<br>
      　　为便于说明，假设主窗体名称为Form1,通过一命令钮Button1注册ODBC数据源。具体根据读者需要自行设定。<br>
      　　procedure TForm1.Button1Click(Sender: TObject);<br>
      　　var<br>
      　　 I : Integer;<br>
      　　 J : double;<br>
      　　 RegF: TextFile;<br>
      　　 SysDir: PChar;<br>
      　　 AppPath, Params, Path, DbPath: string;<br>
      　　begin<br>
      　　 try<br>
      　　 //生成注册用的批处理文件<br>
      　　 Params := ′Regedit/s tmp.reg′;　//批处理文件内容<br>
      　　 AppPath := ExtractFilePath(Application.ExeName);　//取得应用程序当前路径<br>
      　　 AssignFile(RegF, AppPath ＋ ′Reg.Bat′);　//指定批处理文件路径和名称<br>
      　　 ReWrite(RegF);　//创建和打开指定的文本文件<br>
      　　 WriteLn(RegF, Params);　//将注册命令批处理内容写入文件<br>
      　　 CloseFile(RegF);<br>
      　　 //生成注册表文件<br>
      　　 GetMem(SysDir, 255);<br>
      　　 GetSystemDirectory(SysDir, 255); //取得Windows系统目录<br>
      　　 Path := String(SysDir);<br>
      　　 Path := InsertSplash(Path);　//将类似C:\WINDOWS\SYSTEM变为C:\\WINDOWS\\SYSTEM<br>
      　　 Delete(AppPath, Length(AppPath), 1);　//将字符串尾部′\′字符删除<br>
      　　 DbPath := InsertSplash(AppPath);　//取得数据库存放路径<br>
      　　 Params := Format(OdbcStr, [Path, DbPath]);<br>
      　　 AssignFile(RegF, AppPath ＋ ′Tmp.Reg′);<br>
      　　 ReWrite(RegF);<br>
      　　 WriteLn(RegF, Params);<br>
      　　 CloseFile(RegF);<br>
      　　 //通过Api函数执行reg.bat, Uses中加入对ShellApi的引用<br>
      　　 If ShellExeCute(Application.Handle, ′Open′,′Reg.bat′, ′′, PChar(AppPath), 
      SW_HIDE) &lt;= 32<br>
      　　 then<br>
      　　 Showmessage(′导入注册表文件信息失败′);<br>
      　　 finally<br>
      　　 FreeMem(SysDir);<br>
      　　 end;<br>
      　　 end;<br>
      上述代码调用了一字符串处理函数InsertSplash，用于将路径字符串中所有的′\′处理为′\\′；这样做是必需的，否则，上述注册信息DRIVER和DBQ项无法正确注册。InsertSplash函数代码如下：<br>
      　　function InsertSplash(AStr: string): string;　//需要在单元公有部分进行函数声明<br>
      　　var<br>
      　　 I : Integer;<br>
      　　begin<br>
      　　 For I := 1 to Length(AStr) do<br>
      　　 case AStr[I] = ′\′ of<br>
      　　 True : Result := Result ＋ ′\\′;<br>
      　　 False: Result := Result ＋ AStr[I];<br>
      　　 end;<br>
      　　end;<br>
      　　三、结束语<br>
      　　通过上述操作可以看出，实现ODBC数据源的动态注册并没有通过Delphi特有的功能去完成，而只是通过文件读写功能，根据具体安装环境，生成ODBC数据源注册信息和批处理文件，以完成ODBC数据源的注册。这种实现方法不依赖于某种特定的开发工具，不需要通过手工进行ODBC数据源的配置，具有通用性强和操作简单的特点。而且，用上述同样的方法，读者也可编写能够注册其它类型数据源的程序，甚至，写成ODBC注册动态连接库，以利于程序复用。}<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD> 
      <script language="JavaScript" src="../../download/yeskye.js">
</script>
    </TD>
    <TD> <noscript></noscript> <a href='/'>《电脑报》版权所有</a>，<a href='mailto:webmaster@staff.yesky.com'>YESKY网站编辑部</a>设计制作发布</TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
