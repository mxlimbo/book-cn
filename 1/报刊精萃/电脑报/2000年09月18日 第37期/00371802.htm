 
<HTML>
<!-- #BeginTemplate "/模板/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 添加自定义菜单项到窗体的控制菜单</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='http://www.yesky.com'><IMG SRC='images/logo.gif' WIDTH='140' HEIGHT='60' ALT='天极网' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com"><img src="images/0823-3.gif" width="468" height="60" border="0"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='http://www.cpcw.com/issue/index.html'>CPCW电子版</a> 
      &gt; <a href='http://www.cpcw.com/issue/all.html'>2000年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->37期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->{添加自定义菜单项到窗体的控制菜单}<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->{添加自定义菜单项到窗体的控制菜单}<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{　　有些小软件为了使界面更简洁，干脆把自定义菜单项添加到窗体的控制菜单中。由于控制菜单是由Windows系统直接控制的，因此，在控制菜单上添加自定义菜单项，必须借助API函数来实现。笔者经反复调试，在VB中实现了这一功能。具体实现分以下两步完成：<br>
      　　第一，把自定义菜单项添加到控制菜单中。<br>
      　　第二，给菜单项添加相应的代码。基本原理:当我们单击控制菜单中某一项时，窗体会收到一条WM_SYSCOMMAND消息（在wMsg中），该消息包含了控制菜单中被单击那一项的标识符ID（在wParam中）。此时，窗体的默认函数会根据WM_SYSCOMMAND消息以及菜单标识符ID执行相应的操作，完成菜单命令。我们拦截到达窗体的WM_SYSCOMMAND消息，并且识别出菜单的标识符ID，使自己的菜单项执行指定的动作。<br>
      下面的例子用于在控制菜单上添加一条分隔符和两条菜单项。<br>
      　　新建工程，添加新模块，在模块中声明：<br>
      　　′菜单API函数声明<br>
      　　Public Declare Function GetSystemMenu Lib ″user32″ (ByVal hwnd As Long, 
      ByVal bRevert As Long) As Long<br>
      　　Public Declare Function AppendMenu Lib ″user32″ Alias ″AppendMenuA″ (ByVal 
      hMenu As Long, ByVal wFlags As Long, ByVal wIDNewItem As Long, ByVal lpNewItem 
      As Any) As Long<br>
      　　′窗口API函数声明<br>
      　　Public Declare Function SetWindowLong Lib ″user32″ Alias ″SetWindowLongA″ 
      (ByVal hwnd As Long, ByVal nIndex As Long, ByVal dwNewLong As Long) As Long<br>
      　　Public Declare Function CallWindowProc Lib ″user32″ Alias ″CallWindowProcA″ 
      (ByVal lpPrevWndFunc As Long, ByVal hwnd As Long, ByVal Msg As Long, ByVal 
      wParam As Long, ByVal lParam As Long) As Long<br>
      　　′消息<br>
      　　Public Const GWL_WNDPROC = (－4)<br>
      　　Public Const WM_SYSCOMMAND = ＆H112<br>
      　　′自定义菜单项的ID<br>
      　　Public Const MENU_ABOUT = 1<br>
      　　Public Const MENU_HELP = 2<br>
      　　′其他变量<br>
      　　Public PrevWndFunc As Long<br>
      　　Public Function MenuFunc(ByVal hwnd As Long, ByVal wMsg As Long, ByVal 
      wParam As Long, ByVal lParam As Long) As Long<br>
      　　′wMsg:被发送的消息<br>
      　　 If wMsg = WM_SYSCOMMAND Then<br>
      　　 ′进一步检查是否是自定义菜单项的ID<br>
      　　 Select Case wParam<br>
      　　 ′″关于...″菜单项<br>
      　　 Case MENU_ABOUT<br>
      　　 ′此处可加入″关于…″菜单项的代码<br>
      　　 MsgBox ″Success for you!″, vbInformation, ″关于...″<br>
      　　 ′″帮助″菜单项<br>
      　　 Case MENU_HELP<br>
      　　 MsgBox ″Hi,How are you?″, vbInformation, ″帮助″<br>
      　　 ′其它菜单项交给系统处理<br>
      　　 Case Else<br>
      　　 MenuFunc = CallWindowProc(PrevWndFunc, hwnd, wMsg, wParam, lParam)<br>
      　　 End Select<br>
      　　 Else<br>
      　　 MenuFunc = CallWindowProc(PrevWndFunc, hwnd, wMsg, wParam, lParam)<br>
      　　 End If<br>
      　　End Function<br>
      　　′窗体中的代码：<br>
      　　Private Sub Form_Load()<br>
      　　′取得指定窗体控制菜单的句柄。<br>
      　　Dim hMenu As Long<br>
      　　hMenu = GetSystemMenu(Me.hwnd, False)<br>
      　　′在控制菜单中添加自定义的2条菜单项<br>
      　　 ′添加分隔符<br>
      　　AppendMenu hMenu, 0, 0, vbNullString<br>
      　　′添加″关于…″菜单项<br>
      　　AppendMenu hMenu, 0, MENU_ABOUT, ″关于...″<br>
      　　′添加″帮助″菜单项<br>
      　　AppendMenu hMenu, 0, MENU_HELP, ″帮助″<br>
      　　′加载自定义窗口函数<br>
      　　PrevWndFunc = SetWindowLong(Me.hwnd, GWL_WNDPROC, AddressOf MenuFunc)<br>
      　　End Sub<br>
      　　Private Sub Form_Unload(Cancel As Integer)<br>
      　　Unload Me<br>
      　　End Sub<br>
      　　说明：该程序在Win98、VB6.0中运行通过。<br>
      　　（山东　刘红军）}<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD> 
      <script language="JavaScript" src="../../download/yeskye.js">
</script>
    </TD>
    <TD> <noscript></noscript> <a href='/'>《电脑报》版权所有</a>，<a href='mailto:webmaster@staff.yesky.com'>YESKY网站编辑部</a>设计制作发布</TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
