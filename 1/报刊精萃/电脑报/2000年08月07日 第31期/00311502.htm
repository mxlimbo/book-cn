 
<HTML>
<!-- #BeginTemplate "/Templates/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 在WINDOWS2000中收发传真</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='/'><IMG SRC='../../images/logo.gif' WIDTH='143' HEIGHT='50' ALT='电脑报' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com"><img src="images/0823-3.gif" width="468" height="60" border="0"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='/issue/index.html'>CPCW电子版</a> 
      &gt; <a href='http://drivers.cpcw.com/issue.htm'>2000 年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->31期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->用Delphi设计代理服务器（下）<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->用Delphi设计代理服务器（下）<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->　　//当远程主机断开时 procedure 
      TForm1.ClientSocket1Disconnect(Sender: TObject; Socket: TCustomWinSocket); 
      var i,j,k: integer; begin for i:=1 to sessions do if (session[i-1].CSocket.tag=socket.SocketHandle) 
      and session[i-1].Used then begin session[i-1].remote_connected:=false;{置为未连接} 
      if not session[i-1].client_connected then session[i-1].Used:=false{假如客户机已断开，则置释放资源标志} 
      else for k:=1 to serversocket1.Socket.ActiveConnections do if (serversocket1.Socket.Connections[k-1].SocketHandle=session[i-1].SS_Handle) 
      and session[i-1].used then begin serversocket1.Socket.Connections[k-1].Close; 
      break; end; break; end; j:=sessions; k:=0; for i:=1 to j do begin if session[j-i].Used 
      then break; inc(k); end; if k>0 then{修正会话数组} begin sessions:=sessions-k; 
      setlength(session,sessions); end; edit1.text:=inttostr(sessions); end; //当与远程主机通信发生错误时 
      procedure TForm1.ClientSocket1Error(Sender: TObject; Socket: TCustomWinSocket; 
      ErrorEvent: TErrorEvent; var ErrorCode: Integer); var i,j,k: integer; begin 
      for i:=1 to sessions do if (session[i-1].CSocket.tag=socket.SocketHandle) 
      and session[i-1].Used then begin socket.close; session[i-1].remote_connected:=false;{置为未连接} 
      if not session[i-1].client_connected then session[i-1].Used:=false{假如客户机已断开，则置释放资源标志} 
      else for k:=1 to serversocket1.Socket.ActiveConnections do if (serversocket1.Socket.Connections[k-1].SocketHandle=session[i-1].SS_Handle) 
      and session[i-1].used then begin serversocket1.Socket.Connections[k-1].Close; 
      break; end; break; end; j:=sessions; k:=0; for i:=1 to j do begin if session[j-i].Used 
      then break; inc(k); end; errorcode:=0; if k>0 then{修正会话数组} begin sessions:=sessions-k; 
      setlength(session,sessions); end; edit1.text:=inttostr(sessions); end; //向远程主机发送页面请求 
      procedure TForm1.ClientSocket1Write(Sender: TObject; Socket: TCustomWinSocket); 
      var i: integer; begin for i:=1 to sessions do if (session[i-1].CSocket.tag=socket.SocketHandle) 
      and session[i-1].Used then begin if session[i-1].Request then begin socket.SendText(session[i-1].request_str);{假如有请求，发送} 
      session[i-1].Request:=false;{清标志} end; break; end; end; //远程主机发来页面数据时 procedure 
      TForm1.ClientSocket1Read(Sender: TObject; Socket: TCustomWinSocket); var 
      i,j: integer; rec_bytes: integer;{传回的数据块长度} rec_Buffer: array[0..2047] of 
      char; {传回的数据块缓冲区} begin for i:=1 to sessions do if (session[i-1].CSocket.tag=socket.SocketHandle) 
      and session[i-1].Used then begin rec_bytes:=socket.ReceiveBuf(rec_buffer,2048); 
      {接收数据} for j:=1 to serversocket1.Socket.ActiveConnections do if serversocket1.Socket.Connections[j-1].SocketHandle=session[i-1].SS_Handle 
      then begin serversocket1.Socket.Connections[j-1].SendBuf(rec_buffer,rec_bytes); 
      {发送数据} break; end; break; end; end; //“页面找不到”等错误信息出现时 procedure TForm1.AppException(Sender: 
      TObject; E: Exception); begin inc(invalidrequests); end; //查找远程主机定时 procedure 
      TForm1.Timer1Timer(Sender: TObject); var i,j: integer; begin for i:=1 to 
      sessions do if session[i-1].Used and session[i-1].Lookingup then{假如正在连接} 
      begin inc(session[i-1].LookupTime); if session[i-1].LookupTime>lookuptimeout 
      then{假如超时} begin session[i-1].Lookingup:=false; session[i-1].CSocket.active:=false;{停止查找} 
      for j:=1 to serversocket1.Socket.ActiveConnections do if serversocket1.Socket.Connections[j-1].SocketHandle=session[i-1].SS_Handle 
      then begin serversocket1.Socket.Connections[j-1].Close;{断开客户机} break; end; 
      end; end; end; end. 三、总结 由于这种设计思路仅仅在被代理端和远程主机之间增加了一个重定向功能，被代理端原有的缓存技术等特点均保留，因此效率较高。经过测试，利用1个33.6K的Modem上网时，三到十个被代理工作站同时上网，仍有较好的响应速度。由于被代理工作站和代理服务器之间的连接一般通过高速链路，因此瓶颈主要出现在代理服务器的上网方式上。 
      通过上述方法，作者成功开发了一套完善的代理服务器软件并与机房计费系统完全集成，实现了利用一台工作站完成上网代理、上网计费、用机计费等功能。 有编程经验的朋友完全可以另行增加代理服务器功能，如设定禁止访问站点、统计客户流量、Web访问列表等等。<br>
      （浙江 王国忠4206902@21cn.com） <!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD>&nbsp;</TD>
    <TD> <a name='top'></a> <img src='http://cq.cpcw.com/cgi-bin/Count.cgi?ft=2|md=8|df=cpcw.dat|dd=E|cache=F|expires=18000' width='1' height='1' alt='312345678'> 
      <script language="JavaScript" src="http://nethome.yesky.com/sp/yeskye.js">
</script>
      <noscript> <a href='http://best.nease.net/cgi-bin/view/viewbasic.cgi?cpcw' target='_blank'> 
      <img src='http://best.nease.net/cgi-bin/log.cgi?user=cpcw&refer=http%3A//www.cpcw.com/&cur=http%3A//www.cpcw.com/issue/1999/50/99500312.html#NoJavaScript' width='1' height='1' border='0' alt='网易中文排行榜'></a> 
      <!-- Start of NedStat Basic code --> <a href="http://usa.nedstatbasic.net/cgi-bin/viewstat?name=cpcwissue"><img
src="http://usa.nedstatbasic.net/cgi-bin/nedstat.gif?name=cpcwissue"
border=0 alt="" nosave width=1 height=1></a> <!-- End of NedStat Basic code --> 
      <!-- Start of ReferStat --> 
      <script type="text/javascript" language="JavaScript">
<!--
d=document;
d.write("<img src=\"http://usa.nedstatbasic.net");
d.write("/cgi-bin/referstat.gif?");
d.write("name=cpcwissue&refer=");
d.write(escape(top.document.referrer));
d.write("\" width=1 height=1 align=\"right\">");
// -->
</script>
      <!-- End of ReferStat --></noscript> <A HREF='/'>CPCW版权所有</A>，<A HREF='mailto:webmaster@cpcw.com'>CPCW网站编辑部</A>设计制作发布<script language="JavaScript" src="http://nethome.yesky.com/sp/yeskye.js">
</script></TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
