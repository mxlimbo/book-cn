<html>
<head>
<title>网络编程基础篇之CGI</title>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<link rel="stylesheet" href="ebook.css" type="text/css">
</head>
<body leftmargin="0" topmargin="0" background="bg.jpg">
<table width="100%" cellspacing="0">
  <tr>
    <td valign="top" bgcolor="#FFD26A">
      <table width="180" height="100%">
        <tr align="center" valign="top">
          <td>
            <p><img src="image.jpg"></p>
            <p><a href="list.htm"><img src="bd.gif" border="0"></a><br>
              <a href="05.htm"><img src="ap.gif" border="0"></a></p>
          </td>
        </tr>
        <tr align="center" valign="bottom">
          <td><a href="07.htm"><img src="np.gif" border="0"></a></td>
        </tr>
      </table>
    </td>
    <td valign="top">
      <blockquote>
        <div align="center"><img src="title.gif"></div>
        <!--正文开始-->
        <font color="#0000FF">6.投票程序 </font> 
        <p> 本程序可以教给大家如何使用perl语言或C语言如何处理字符串。<br>
          让我们先看看代码：
        <p> <font color="#0000FF">6.1 页面文件:pote.html</font><br>
        <ul>&lt;HTML&gt;<br>
    &lt;TITLE&gt;投票程序&lt;/TITLE&gt;<br>
    &lt;h1&gt;投票程序&lt;/h1&gt;<br>
    &lt;FORM METHOD="post" ACTION="/cgi-bin/vote.pl"&gt;<br>
      一.你喜欢哪个站点?&lt;br&gt;<br>
      &lt;input type="radio" name="idol" value="A" 
      checked&gt;新浪&lt;br&gt;<br>
      &lt;input type="radio" name="idol" value="B"&gt;网易&lt;br&gt;<br>
      &lt;input type="radio" name="idol" value="C"&gt;搜狐&lt;br&gt;<br>
      &lt;input type="radio" name="idol" value="D"&gt;雅虎&lt;br&gt;<br>
      &lt;input type="radio" name="idol" value="E"&gt;灰鸟&lt;br&gt;<br>
    &lt;input type="submit" value="执行"&gt;<br>
    &lt;input type="reset" value="取消"&gt;<br>
    &lt;/form&gt;<br>
    查询&lt;a href="/cgi-bin/vote.pl?command=view"&gt;选举投票结果&lt;/a&gt;<br>
    &lt;/html&gt;</ul><br>
        <font color="#0000FF">6.2 CGI程序:vote.pl</font><br>
        <ul>
          #!/usr/bin/perl<br>
          print"Content-type:text/html\n\n";<br>
          print"&lt;titel&gt;投票系统&lt;/title&gt;";<br>
          <br>
          if($ENV{'REQUEST_METHOD'}eq"POST"){<br>
          read(STDIN,$buffer,$ENV{'CONTENT_LENGTH'});<br>
          }elsif($ENV{'REQUEST_METHOD'}eq"GET"){<br>
          $buffer=$ENV{'QUERY_STIRNG'}; <br>
          }<br>
          <br>
          @pairs=split(/&amp;/,$buffer);<br>
          foreach $pair(@pairs){<br>
          ($name,$value)=split(/=/,$pair);<br>
          $value=~tr/+//;<br>
          $value=~s/%([a-f A-F 0-9][a-f A-f 0-9])/pack("C",hex($1))/eg;<br>
          $FORM{$name}=$value;}<br>
          <br>
          $filename="/vote.dat";<br>
          %NAME=("A","新浪","B","网易","C","搜狐","D","雅虎","E","灰鸟");<br>
          <br>
          if($ENV{'REQUEST_METHOD'}eq"POST"){<br>
          print"Content-type:text/html\n\n";<br>
          print"&lt;titel&gt;投票系统&lt;/title&gt;";<br>
          print"&lt;h1&gt;投票系统的例子&lt;/h1&gt;";<br>
          open(FILE,"&lt;$filename")||die"不能打开文件，请和管理员联系\n";<br>
          <br>
          for($i=0;$i&lt;2;$i++){<br>
          $file[$i]=&lt;FILE&gt;;<br>
          $file[$i]=~s/\n$//;<br>
          }<br>
          close(FILE);<br>
          <br>
          @item=split(/:/,$file[0]);<br>
          @vote=split(/:/,$file[1]);<br>
          <br>
          for($i=0;$i&lt;@item;$i++){<br>
          if($FORM{'idol'}eq$item[$i]){<br>
          $vote[$i]++;<br>
          last;<br>
          }<br>
          }<br>
          open(FILE,"&gt;filename")||die"Can't Open the file";<br>
          $item=join(":",@item);<br>
          $vote=join(":",@vote);<br>
          pirnt FILE "$item\n";<br>
          print FILE "$vote\n";<br>
          <br>
          close (FILE);<br>
          <br>
          print"&lt;h2&gt;您是投票给$NAME{$FORM{'idol'}},谢谢您的选票！&lt;h2&gt;";<br>
          print"查询&lt;a href=\"/cgi-bin/vote.pl?command=viem\"&gt;投票结果系统&lt;/a&gt;";<br>
          <br>
          }<br>
          <br>
          if($FORM{'command'}eq"view"){<br>
          print "HTTP/1.0 200\n";<br>
          print "Content-type:text/html\n\n";<br>
          print"&lt;title&gt;投票结果&lt;/title&gt;";<br>
          print"&lt;h1&gt;投票结果&lt;/h1&gt;";<br>
          open (FILE,"$filename")||die"文件打开错误";<br>
          <br>
          for($i=0;$i&lt;2;$i++){<br>
          $file[$i]=&lt;FILE&gt;;<br>
          $file[$i]=~s/\n$//;<br>
          }<br>
          close(FILE);<br>
          <br>
          @item=split(/:/,$file[0]);<br>
          @vote=split(/:/,$file[1]);<br>
          <br>
          print"&lt;table border=1&gt;";<br>
          <br>
          for($i=0;$i&lt;@item;$i++){<br>
          print"&lt;tr&gt;&lt;td&gt;站点&lt;/td&gt;&lt;td&gt;$NAME{$item[$i]}&lt;/td&gt;&lt;td&gt;票数&lt;/td&gt;,td&gt;$vote[$i]&lt;/td&gt;&lt;tr&gt;";<br>
          <br>
          }<br>
          print "&lt;/table&gt;";<br>
          }<br>
        </ul>
        <br>
    这个程序是要各位学习Perl的分解字符串的功能。在Perl中，字符串操作是非常简单的。<br>
    我对几句重要语句做一个分析：<br>
    if($ENV{'REQUEST_METHOD'}eq"POST"){<br>
    read(STDIN,$buffer,$ENV{'CONTENT_LENGTH'});<br>
    }elsif($ENV{'REQUEST_METHOD'}eq"GET"){<br>
    $buffer=$ENV{'QUERY_STIRNG'}; <br>
    }<br>
    这是一个非常常见的功能块，几乎所有的CGI程序都会用到它。它判断页面使用何种方式提交变量。如果是post，就从STDIN里把变量读出，存到变量buffer里。注意在perl里，变量是用$开头的。而$ENV{'CONTENT_LENGTH'}则是读出该变量的长度，请注意CONTENT_LENGTH<br>
    是一个环境变量。第二个if则处理get情况，在get情况下，页面提交的信息是存放在环境变量QUERY_STIRNG中的。所以$buffer也就是页面提交的信息。环境变量REQUEST_METHOD表示方式，它的值是一个字符串，前面加上$ENV则表示读出该变量的值。<br>
    <br>
    @pairs=split(/&amp;/,$buffer);<br>
    foreach $pair(@pairs){<br>
    ($name,$value)=split(/=/,$pair);<br>
    $value=~tr/+//;<br>
    $value=~s/%([a-f A-F 0-9][a-f A-f 0-9])/pack("C",hex($1))/eg;<br>
    $FORM{$name}=$value;}<br>
      以上功能块是一个分解过程。页面信息的提交往往是以“名称=值”的形式，比如本例子中就是以“idol=灰鸟”这样的形式提交的，所以我们要去掉字符串中的"="等等信息，但同时要保留“idol”和"灰鸟"之间的对应关系。$FORM{$name}=$value做到这一点，这是一个关联数组。具体其中的语法，在perl教程中有详细说明。<br>
    <br>
        <!--正文结束-->
      <center>
      <hr>
      <p>本书由<a href="http://www.huiniao.com/">【灰鸟资讯】</a>免费制作<br>
          想要更多的免费电子图书，请光临<br>
          <a href="http://www.huiniao.com">http://www.huiniao.com</a></p>
      </center>
      </blockquote>
    </td>
  </tr>
</table>
</body>
</html>
