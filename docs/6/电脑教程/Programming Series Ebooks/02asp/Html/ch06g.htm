<HTML>
<HEAD>
<TITLE>Part V: Publishing the Database</TITLE>
</HEAD>
<BODY BGCOLOR = "#ffffff">
<H1>Part V: Publishing the Database</h1>
<P>In this part of the exercise, you will publish the Bookstore database by 
allowing a user to search the database for a book by title, author, or publisher. 
You will build a form on the home page for searching and publish the results 
on a separate page. 


<P><H2>Step 1</h2>
<P>If you don't already have the Bookstore project open, open it now. To 
start building the form, right-click the file DEFAULT.HTM and choose Open 
With from the pop-up menu. Open the file in Microsoft FrontPage Editor.
<P>In the table where you inserted HOTLIST.GIF, insert the search 
image into the top cell of the right-hand column by choosing Image from the 
Insert menu. In the From Location text box, specify this location:
<P><PRE>/bookstore/images/search.gif</pre>
<P>To create a bookmark to the new image, select the entire image 
and choose Bookmark from the Edit menu. Name the new bookmark Find 
Book. The Agent will use this bookmark later to display the form to the user.
<P><HR><BLOCKQUOTE>
<B>WARNING:</b> When inserting a bookmark for the image, you 
must be careful to select, or highlight, the entire image. If the image 
is not completely highlighted, the bookmark menu will be unavailable.
</blockquote><HR>


<P><H2>Step 2</h2>
<P>In the cell below the search image, build a table to allow searches. Place 
three text boxes in the cell by choosing Form Field/One-Line Text Box from 
the Insert menu for each text box. Use text to label the boxes Title, Author, 
and Publisher, respectively.
<P>To name the controls for the text boxes, right-click each box and 
choose Form Field Properties from the pop-up menu. In the Text Box Properties 
dialog box, name the controls txtTitle, txtAuthor, and txtPublisher.
<P>After creating the text boxes, add Submit and Reset buttons to the 
form by choosing Form Field/Push Button from the Insert menu. Right-click the 
first button, and choose Form Field Properties from the pop-up menu. Change 
the value of the button to <I>Go!</I> Click OK, and right-click the second button 
to change its properties. Change the button type for the second button to 
<I>Reset</I>. Click OK, and save your work.


<P><H2>Step 3</h2>
<P>Now that the form is created, you need to change the form attributes to 
submit the form data to your search engine. Right-click the form in the Web 
page, and choose Form Properties from the pop-up menu. In the Form 
Properties dialog box, name the form frmLocate. Be sure that the form handler 
option is set to Custom ISAPI, NSAPI, Or CGI Script, the appropriate setting for 
sending the form data to an ASP page.
<P>Click the Settings button to change the target for the form. In the 
Action text box in the Settings For Custom Form Handler dialog box, enter 
<I>/BOOKSTORE/LOCATE.ASP</I>, which is the name of the ASP page that will publish 
the database. You have not yet created LOCATE.ASP, but you will shortly. Click 
OK in both dialog boxes, and save your work.


<P><H2>Step 4</h2>
<P>Leave FrontPage Editor, and return to Visual InterDev. To add a new file, 
click the project title on the FileView tab and then choose New from the File 
menu. In the New dialog box, create a new ASP page, name it LOCATE.ASP, and 
click the OK button.
<P>In the BODY section of LOCATE.ASP, create some VBScript code 
that runs a query on the database and returns the results to the browser. Start 
by clicking the Data View tab in the project window. On the tab, double-click 
the Authors table, which should become visible in the work area 
of Visual InterDev.
<P>You should also see the Query toolbar floating over the work area. 
Click the Show Diagram Pane button to view table relationships, and drag the 
Titles, Publishers, and Title Author tables from the project window to the work area.
<P>These data tools can help create a query by selecting fields and 
specifying criteria. Start by clearing all the check marks in the tables you dragged 
to the work area. Next carefully check the Author, Title, and Company 
Name boxes in the Authors, Titles, and Publishers tables.
<P>Now click the Show SQL Pane button on the Query toolbar to view 
the resulting SQL statement. The statement should look like this:
<P><PRE>SELECT&#160;Authors.Author,&#160;Titles.Title,&#160;Publishers.`Company&#160;Name`
FROM&#160;Authors,&#160;`Title&#160;Author`,&#160;Titles,&#160;Publishers
WHERE&#160;Authors.Au_ID&#160;=&#160;`Title&#160;Author`.Au_ID&#160;AND
`Title&#160;Author`.ISBN&#160;=&#160;Titles.ISBN</pre>
<P>This SQL statement is not the complete statement, but you can use it 
as a starting point for modifying your Web page. Add the following code to 
the BODY section to run the query and format the result:
<P><HR><BLOCKQUOTE>
<B>NOTE:</b> This SQL statement can be tricky to 
create. The code is designed to concatenate pieces to produce one complete SQL 
statement. In this construction, you will find strange characters such 
as the back accent (`) and the single quote('). Don't confuse the two!
</blockquote><HR>
<P><PRE>&lt;%

Public&#160;dbBooks
Public&#160;rsBooks
Dim&#160;strSQL

`&#160;Open&#160;a&#160;connection&#160;to&#160;Biblio
Set&#160;dbBooks&#160;=&#160;Server.CreateObject(&quot;ADODB.Connection&quot;)
dbBooks.Open(&quot;WebPages&quot;)

`&#160;Build&#160;SQL&#160;statement
strSQL&#160;=&#160;&quot;SELECT&#160;Authors.Author,&#160;Titles.Title,&#160;Publishers.`Company&#160;Name`&#160;&quot;
strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;FROM&#160;Authors,&#160;`Title&#160;Author`,&#160;Titles,&#160;Publishers&#160;&quot;
strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;WHERE&#160;(Authors.Au_ID&#160;=&#160;`Title&#160;Author`.Au_ID&#160;AND&#160;&quot;
strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;`Title&#160;Author`.ISBN&#160;=&#160;Titles.ISBN&#160;AND&#160;&quot;
strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;Titles.PubID&#160;=&#160;Publishers.PubID)&quot;

If&#160;Request.Form(&quot;txtTitle&quot;)&#160;&lt;&gt;&#160;&quot;&quot;&#160;Then
&#160;&#160;&#160;&#160;strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;&#160;AND&#160;Title&#160;LIKE&#160;`%&quot;&#160;&amp;&#160;Request.Form(&quot;txtTitle&quot;)&#160;&amp;&#160;&quot;%'&quot;
End&#160;If

If&#160;Request.Form(&quot;txtAuthor&quot;)&#160;&lt;&gt;&#160;&quot;&quot;&#160;Then
&#160;&#160;&#160;&#160;strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;&#160;AND&#160;Author&#160;LIKE&#160;`%&quot;&#160;&amp;&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Request.Form(&quot;txtAuthor&quot;)&#160;&amp;&#160;&quot;%'&quot;
End&#160;If

If&#160;Request.Form(&quot;txtPublisher&quot;)&#160;&lt;&gt;&#160;&quot;&quot;&#160;Then
&#160;&#160;&#160;&#160;strSQL&#160;=&#160;strSQL&#160;&amp;&#160;&quot;&#160;AND&#160;`Company&#160;Name`&#160;LIKE&#160;`%&quot;&#160;&amp;&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Request.Form(&quot;txtPublisher&quot;)&#160;&amp;&#160;&quot;%'&quot;
End&#160;If

`&#160;Run&#160;the&#160;query
Set&#160;rsBooks&#160;=&#160;Server.CreateObject(&quot;ADODB.Recordset&quot;)
rsBooks.Open&#160;strSQL,&#160;dbBooks,&#160;3
%&gt;

&lt;!--&#160;Build&#160;the&#160;results&#160;table&#160;--&gt;
&lt;%
If&#160;rsBooks.BOF&#160;And&#160;rsBooks.EOF&#160;Then%&gt;
&#160;&#160;&#160;&#160;&lt;H2&gt;&lt;CENTER&gt;Sorry,&#160;no&#160;results!&#160;Please&#160;try&#160;again!&lt;/CENTER&gt;&lt;/H2&gt;

&lt;%Else
&#160;&#160;&#160;&#160;`&#160;Populate&#160;the&#160;cursor
&#160;&#160;&#160;&#160;rsBooks.MoveLast
&#160;&#160;&#160;&#160;rsBooks.MoveFirst
End&#160;If

If&#160;rsBooks.RecordCount&#160;&gt;&#160;200&#160;Then%&gt;
&#160;&#160;&#160;&#160;&lt;H2&gt;&lt;CENTER&gt;
&#160;&#160;&#160;&#160;Sorry,&#160;too&#160;many&#160;results.&#160;Please&#160;narrow&#160;your&#160;search
&#160;&#160;&#160;&#160;&lt;/CENTER&gt;&lt;/H2&gt;
&lt;%Else%&gt;
&#160;&#160;&#160;&#160;&lt;%If&#160;Not&#160;rsBooks.BOF&#160;Then%&gt;
&#160;&#160;&#160;&#160;&lt;H2&gt;Here&#160;are&#160;the&#160;results&#160;of&#160;your&#160;search:&lt;/H2&gt;

&#160;&#160;&#160;&#160;&lt;TABLE&#160;BORDER&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TR&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Author
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Title
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Publisher
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TH&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TR&gt;
&#160;&#160;&#160;&#160;&lt;%
&#160;&#160;&#160;&#160;Do&#160;While&#160;Not&#160;rsBooks.EOF
&#160;&#160;&#160;&#160;%&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TR&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;%=rsBooks(&quot;Author&quot;)%&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;A&#160;
&#160;&#160;&#160;&#160;HREF=
&#160;&#160;&#160;&#160;&quot;/Chapter7/OrderForm.asp?Title=&lt;%=Server.URLEncode(rsBooks(&quot;Title&quot;))%&gt;&quot;&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;%=rsBooks(&quot;Title&quot;)%&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/A&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;%=rsBooks(&quot;Company&#160;Name&quot;)%&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TD&gt;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&lt;/TR&gt;
&#160;&#160;&#160;&#160;&lt;%
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;rsBooks.MoveNext
&#160;&#160;&#160;&#160;Loop
&#160;&#160;&#160;&#160;%&gt;
&#160;&#160;&#160;&#160;&lt;/TABLE&gt;

&#160;&#160;&#160;&#160;&lt;%End&#160;If%&gt;
&lt;%End&#160;If%&gt;

&lt;%
`&#160;Close&#160;database
rsBooks.Close
dbBooks.Close
Set&#160;rsBooks&#160;=&#160;Nothing
Set&#160;dbBooks&#160;=&#160;Nothing
%&gt;</pre>
<P><HR><BLOCKQUOTE>
<B>NOTE:</b> Normally you would expect such an application to 
present result sets as pages containing sets of 10 or 20. While ADO 
supports paging, not all ODBC drivers do. In particular, the Access 
drivers used in this exercise do not support paging.
</blockquote><HR>


<P><H2>Step 5</h2>
<P>Save your work, and run the project in Internet Explorer. Test the search 
form to see whether results are returned properly.


<P><H2>Step 6</h2>
<P>Now add a new menu command that will automatically submit the search 
form for the user. Close LOCATE.ASP, and open DEFAULT.HTM in Visual 
InterDev Editor. Locate the Window_OnLoad event where you described the 
commands that the Agent would perform. Add a new command named Find Book by 
using the Add method of the Commands object. The following code shows the 
complete Window_OnLoad event for the Agent:
<P><PRE>Sub&#160;Window_OnLoad()
&#160;&#160;&#160;&#160;`&#160;Initialize
&#160;&#160;&#160;&#160;`&#160;the&#160;variables&#160;when&#160;the&#160;page
&#160;&#160;&#160;&#160;`&#160;is&#160;fully&#160;loaded

&#160;&#160;&#160;&#160;`&#160;Scrolling&#160;status
&#160;&#160;&#160;&#160;strMessage&#160;=&#160;&quot;Welcome&#160;to&#160;Web&#160;Pages!!&quot;
&#160;&#160;&#160;&#160;intSpaces&#160;=&#160;100
&#160;&#160;&#160;&#160;intTimeout&#160;=&#160;Window.SetTimeout(&quot;Scroll&quot;,&#160;100)

&#160;&#160;&#160;&#160;`&#160;Dimension&#160;variables
&#160;&#160;&#160;&#160;Dim&#160;Agents
&#160;&#160;&#160;&#160;Dim&#160;AgentPth
&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;`&#160;Set&#160;variables
&#160;&#160;&#160;&#160;Set&#160;Agents&#160;=&#160;Wizard.Characters
&#160;&#160;&#160;&#160;AgentPath&#160;=&#160;&quot;c:\program&#160;files\microsoft&#160;agent\characters\&quot;
&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;`&#160;Load&#160;character
&#160;&#160;&#160;&#160;Agents.Load&#160;&quot;WIZARD&quot;,&#160;AgentPath&#160;&amp;&#160;&quot;Merlin.acs&quot;

&#160;&#160;&#160;&#160;`&#160;Create&#160;custom&#160;commands
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Commands.Caption&#160;=&#160;&quot;Custom&#160;Commands&quot;

&#160;&#160;&#160;&#160;`&#160;Name,&#160;Caption,&#160;Voice&#160;Command,&#160;Enabled,&#160;Visible
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Commands.Add&#160;&quot;Search&quot;,&#160;&quot;Search&quot;,&#160;&quot;Search&quot;,&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;True,&#160;True
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Commands.Add&#160;&quot;Find&#160;Book&quot;,&#160;&quot;Find&#160;Book&quot;,&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&quot;Find&#160;Book&quot;,&#160;True,&#160;True
&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;`&#160;Show&#160;Agent
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Show
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Play&#160;&quot;Surprised&quot;
&#160;&#160;&#160;&#160;Agents(&quot;WIZARD&quot;).Speak&#160;&quot;Welcome&#160;to&#160;WebPages!&quot;
End&#160;Sub</pre>
<P><H2>Step 7</h2>
<P>When a user chooses the Find Book command, the Agent should explain 
how to use the search form to locate a book. This is accomplished through 
the Wizard_Command event, which moves the Agent and explains the form. 
Code for the Wizard_Command event should look like this:
<P><PRE>Sub&#160;Wizard_Command(UserInput)
&#160;&#160;&#160;&#160;`&#160;Set&#160;variables
&#160;&#160;&#160;&#160;Dim&#160;Agent
&#160;&#160;&#160;&#160;Set&#160;Agent&#160;=&#160;Wizard.Characters(&quot;WIZARD&quot;)
&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;`&#160;Go&#160;to&#160;search&#160;page
&#160;&#160;&#160;&#160;If&#160;UserInput.Voice&#160;=&#160;&quot;Search&quot;&#160;Or&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;UserInput.Name&#160;=&#160;&quot;Search&quot;&#160;Then
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Window.Navigate&#160;&quot;search.htm&quot;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;End&#160;If

&#160;&#160;&#160;&#160;`&#160;Explain&#160;book&#160;search
&#160;&#160;&#160;&#160;If&#160;UserInput.Voice&#160;=&#160;&quot;Find&#160;Book&quot;&#160;Or&#160;_
&#160;&#160;&#160;&#160;&#160;&#160;&#160;UserInput.Name&#160;=&#160;&quot;Find&#160;Book&quot;&#160;Then
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Window.Navigate&#160;&quot;#Find&#160;Book&quot;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`&#160;Move&#160;Agent
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Agent.MoveTo&#160;Window.Screen.Width&#160;-&#160;100,&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Window.Screen.Height&#160;-&#160;100

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`&#160;Point&#160;to&#160;form
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Agent.GestureAt&#160;Int(Window.Screen.Width&#160;/&#160;2),&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Int(Window.Screen.Height&#160;/&#160;2)

&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`&#160;Give&#160;instructions
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Agent.Speak&#160;&quot;Use&#160;this&#160;form&#160;to&#160;find&#160;a&#160;book.&quot;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;`&#160;Move&#160;again
&#160;&#160;&#160;&#160;&#160;&#160;&#160;&#160;Agent.MoveTo&#160;0,&#160;0
&#160;&#160;&#160;&#160;End&#160;If
End&#160;Sub</pre>
<P><H2>Step 8</h2>
<P>Save your work, and run the Web site in Internet Explorer. Test the search 
form and the Agent functions.






<P>
</BODY>
</HTML>
