<HTML>
<HEAD>
<TITLE>Internet Control Message Protocol</title>
<link rel="STYLESHEET" type="text/css" href="Library.css">


</head>
<BODY BGCOLOR="#FFFFFF" TEXT="#000000">
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch13b.htm" , "ch13d.htm", "images/unit_o_a1.gif", "images/unit_o_a2.gif", "images/unit_o_b1.gif", "images/unit_o_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#ff9900", "2");
//--></SCRIPT>



<A NAME="406"><H1>Internet Control Message Protocol</H1></A>

<p>ICMP is used as a means of messaging between hosts. Most ICMP messages relate to errors that occur in communication between hosts; the remaining ICMP messages are used to query hosts. The ICMP protocol uses IP addressing because it is a protocol encapsulated within an IP datagram. Figure 13-1 illustrates the fields of an ICMP message. The ICMP message is wrapped in an IP header.</p>

<p>The first field is the ICMP message type, which can be classified as either a query or an error. The code field further defines the type of query or message. The checksum field is the 16-bit one's complement sum of the ICMP header. Finally, the ICMP contents depend on the ICMP type and code. Table 13-1 lists the various types and codes.</p>

<p>When an ICMP error message is generated, the message always contains the IP header and the first 8 bytes of the IP datagram that caused the ICMP error to occur. This allows the host receiving the ICMP error to associate the message with one particular protocol and process associated with that error. In our case, Ping relies on the echo request and echo reply ICMP queries rather than on error messages. Hosts generate ICMP messages in response to problems with TCP or UDP; ICMP doesn't have many applications beyond that. In the next section, we will discuss how to use the ICMP protocol with a raw socket to generate a Ping request by using the echo request and echo reply messages. If you require additional information about ICMP errors or the other types of ICMP queries, consult more in-depth sources, such as Stevens's <i>TCP/IP Illustrated Vol. 1</i>.</p>

<p>
<A HREF="javascript:fullSize('F13JI01x.htm')"> <img src="images/F13JI01.JPG" width=404 height=86 border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 13-1.</b> <i>ICMP header</i><!-- /caption -->
</p>

<p><b>Table 13-1.</b> <i>ICMP message types</i></p>

<table cellpadding="5" border="0" width="95%">
<tr><th><i>Type</i></th><th><i>Query/Error (Error Type)</i></th><th><i>Code</i></th><th><i>Description</i></th></tr>
<tr><td valign="top">0</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Echo reply</td></tr>
<tr><td valign="top">3</td><td valign="top">Error: Destination unreachable</td>
<td valign="top">0<br>1<br>2<br>3<br>4<br>5<br>6<br>7<br>8<br>9<br>10<br>11<br>12<br>13<br>14<br>15<br></td>
<td valign="top">Network unreachable<br>Host unreachable<br>Protocol unreachable<br>Port unreachable<br>Fragmentation needed, but the Don't Fragment bit has been set<br>Source route failed<br>Destination network unknown<br>Destination host unknown<br>Source host isolated (obsolete)<br>Destination network administratively prohibited<br>Destination host administratively prohibited<br>Network unreachable for TOS<br>Host unreachable for TOS<br>Communication administratively prohibited by filtering<br>Host precedence violation<br>Precedence cutoff in effect</td></tr>
<tr><td valign="top">4</td><td valign="top">Error</td><td valign="top">0</td><td valign="top">Source quench</td></tr>
<tr><td valign="top">5</td><td valign="top">Error: Redirect</td><td valign="top">0<br>1<br>2<br>3</td><td valign="top">Redirect for network<br>Redirect for host<br>Redirect for TOS and network<br>Redirect for TOS and host</td></tr>
<tr><td valign="top">8</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Echo request</td></tr>
<tr><td valign="top">9</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Router advertisement</td></tr>
<tr><td valign="top">10</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Router solicitation</td></tr>
<tr><td valign="top">11</td><td valign="top">Error: Time exceeded</td><td valign="top">0<br>1</td><td valign="top">TTL equals 0 during transit<br>TTL equals 0 during reassembly</td></tr>
<tr><td valign="top">12</td><td valign="top">Error: Parameter problem</td><td valign="top">0</td><td valign="top">IP header bad<br>Required option missing</td></tr>
<tr><td valign="top">13</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Time stamp request</td></tr>
<tr><td valign="top">14</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Time stamp reply</td></tr>
<tr><td valign="top">15</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Information request</td></tr>
<tr><td valign="top">16</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Information reply</td></tr>
<tr><td valign="top">17</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Address mask request</td></tr>
<tr><td valign="top">18</td><td valign="top">Query</td><td valign="top">0</td><td valign="top">Address mask reply</td></tr>
</table>


<A NAME="407"><H2>Ping Example</H2></A>

<p>A ping is often used to determine whether a particular host is alive and reachable through the network. By generating an ICMP echo request and directing it to the host you are interested in, you can determine whether you can successfully reach that machine. Of course, this does not guarantee that a socket client will be able to connect to a process on that host (a process on the remote server might not be listening, for example); it just means that the network layer of the remote host is responding to network events. Essentially, the Ping example performs the following steps:</p>

<ol>
<p><li> Creates a socket of type <i>SOCK_RAW</i> and protocol <i>IPPROTO_ICMP</i></li></p>

<p><li> Creates and initializes the ICMP header</li></p>

<p><li> Calls <i>sendto</i> or <i>WSASendto</i> to send the ICMP request to the remote host</li></p>

<p><li> Calls <i>recvfrom</i> or <i>WSARecvfrom</i> to receive any ICMP responses</li></p>
</ol>

<p>When you send the ICMP echo request, the remote machine intercepts the ICMP query and generates an echo reply message back to you. If for some reason the host is not reachable, the appropriate ICMP error message&#8212;such as destination host unreachable&#8212;will be returned by a router somewhere along the path to the intended recipient. If the physical network connection to the host is good but the remote host is either down or not responding to network events, you need to perform your own timeout to determine this. The Ping.c example in Figure 13-2 illustrates how to create a socket capable of sending and receiving ICMP packets, as well as how to use the <i>IP_OPTIONS</i> socket option to implement the record route option.</p>

<p><b>Figure 13-2.</b> <i>Ping.c</i></p>

<p><table cellpadding=5 width="95%"><tr><td>
<pre>
//燤odule燦ame:燩ing.c
//
//燙ommand燣ine燨ptions/Parameters:
//牋牋燩ing燵host]燵packet-size]
//牋牋