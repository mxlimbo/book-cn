<HTML>
<HEAD>
<TITLE>Affinities</TITLE>
<link rel="STYLESHEET" type="text/css" href="advwin4.css">
<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</HEAD>
<BODY BGCOLOR="#ffffff" TEXT="#000000">
<A HREF="ch07j.htm">[Previous]</A> <A HREF="ch08a.htm">[Next]</A><P>

<A NAME="109"><H1>Affinities</H1></A>

<p>By default, Windows 2000 uses <i>soft affinity</i> when assigning
threads to processors. This means that if all other factors are equal,
it tries to run the thread on the processor it ran on last. Having a
thread stay on a single processor helps reuse data that is still in the
processor's memory cache.</p>

<p>There is a new computer architecture called NUMA (Non-Uniform Memory
Access) in which a machine consists of several boards. Each board has
four CPUs and its own bank of memory. The following figure shows a
machine with 3 boards in it, making 12 CPUs available so that any
single thread can run on any of the 12 CPUs.</p>

<p>
<A HREF="javascript:fullSize('G07si06x.htm')"> <img src="images/G07si06.JPG" width=404 height=178 border=0 ALT="Click to view at full size."> </A>
</p>

<p>A NUMA system performs best when a CPU accesses the memory that is on
its own board. If the CPU needs to touch memory that is on another
board, an enormous performance hit is incurred. In such an environment,
it is desirable to have threads from one process run on CPUs 0 through
3 and have threads in another process run on CPUs 4 through 7, and so
on. To accommodate such machine architectures, Windows 2000 allows you
to set process and thread affinities. In other words, you can control
which CPUs can run certain threads. This is called <i>hard
affinity</i>.</p>

<p>The system determines how many CPUs are available in the machine at
boot time. An application can query the number of CPUs on the machine
by calling <i>GetSystemInfo</i> (discussed in <A HREF="ch14a.htm">Chapter 14</A>). By default,
any thread can be scheduled to any of these CPUs. To limit threads in a
single process to run on a subset of the available CPUs, you can call
<i>SetProcessAffinityMask</i>:</p>

<p><table cellpadding=5 width="95%"><tr><td>
<PRE>
BOOL燬etProcessAffinityMask(
牋燞ANDLE爃Process,