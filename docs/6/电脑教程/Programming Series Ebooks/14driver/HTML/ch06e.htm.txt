<HTML>
<HEAD>
<TITLE>Other Configuration Functionality</TITLE>
<link rel="STYLESHEET" type="text/css" href="waltoney.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</head>
<BODY bgcolor="#ffffff" text="#000000">
<p>
<A HREF="ch06d.htm">[Previous]</A> <A HREF="ch06f.htm">[Next]</a>
</p>

<A NAME="204"><H1>Other Configuration Functionality</H1></A>

<p>Up to this point I've talked about the important concepts you need to know to write a
hardware device driver. To close the chapter, I'll discuss two less important minor
function codes&#8212;IRP_MN_FILTER_RESOURCE_REQUIREMENTS and IRP_MN_DEVICE_USAGE_NOTIFICATION&#8212;that you might need to process in a practical driver. Then
I'll discuss how to write a miniature bus driver to support nonstandard controller or
multifunction devices. Finally, I'll mention how you can register to receive notifications
about PnP events that affect other devices besides your own.</p>

<p>
<div class="note"><blockquote><b>NOTE</b> <hr>
Other flavors of PnP requests exist that I haven't discussed in this
chapter because it's not my purpose to simply reiterate the DDK reference manuals. For
example, it's potentially useful to be able to export a direct call interface to other
drivers, but you probably don't need to in any garden-variety situation. I'm therefore
not going to provide a sample or an explanation of IRP_MN_QUERY_INTERFACE. I'll mention IRP_MN_QUERY_CAPABILITIES in <A HREF="ch08a.htm">Chapter 8</A>, on power management,
to which it's most relevant.</blockquote></div>
</p>

<A NAME="205"><H2>Filtering Resource Requirements</H2></A>

<p>Sometimes the PnP Manager is misinformed about the resource requirements of your driver.
This can occur because of hardware and firmware bugs, mistakes in the INF file for a legacy
device, or other reasons. The system provides an escape valve in the form of the
IRP_MN_FILTER_RESOURCE_REQUIREMENTS request, which affords you a chance to examine and possibly
alter the list of resources before the PnP Manager embarks on the arbitration and assignment
process that culminates in your receiving a start device IRP.</p>

<p>When you receive a filter request, the <b>FilterResourceRequirements</b> substructure of the
Parameters union in your stack location points to an IO_RESOURCE_REQUIREMENTS_LIST data structure that lists the resource requirements for your device. In
addition, if any of the drivers above you have processed the IRP and modified the resource
requirements, the <b>IoStatus.Information</b> field of the IRP will point to a second
IO_RESOURCE_REQUIREMENTS_LIST, which is the one from which you should work. Your overall
strategy will be as follows: If you wish to <i>add</i> a resource to the current list of
requirements, you do so in your dispatch routine. Then you pass the IRP down the stack
synchronously&#8212;that is, by using the ForwardAndWait method you use with a start device
request. When you regain control, you can <i>modify</i> any of the resource descriptions that
appear in the list.</p>

<p>Here is a brief and not very useful example that illustrates the mechanics of the filtering
process:</p>

<P><table cellpadding=5 width="95%"><TR><TD VALIGN=TOP>
<pre>




1<img src="images/arorite2.jpg" width=17 height=10 border="0">

2<img src="images/arorite2.jpg" width=17 height=10 border="0">

3<img src="images/arorite2.jpg" width=17 height=10 border="0">

4<img src="images/arorite2.jpg" width=17 height=10 border="0">

5<img src="images/arorite2.jpg" width=17 height=10 border="0">







6<img src="images/arorite2.jpg" width=17 height=10 border="0">





7<img src="images/arorite2.jpg" width=17 height=10 border="0">


8<img src="images/arorite2.jpg" width=17 height=10 border="0">




9<img src="images/arorite2.jpg" width=17 height=10 border="0">
</pre></td>
<td valign=top>
<PRE>
NTSTATUS燞andleFilterResources(PDEVICE_OBJECT爁do,燩IRP營rp)
牋{
牋PDEVICE_EXTENSION爌dx