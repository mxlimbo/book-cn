<HTML>
<HEAD>
<TITLE>The AddDevice Routine</TITLE>
<link rel="STYLESHEET" type="text/css" href="waltoney.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</head>
<BODY bgcolor="#ffffff" text="#000000">
<p>
<A HREF="ch02c.htm">[Previous]</A> <A HREF="ch02e.htm">[Next]</a>
</p>

<A NAME="44"><H1>The AddDevice Routine</H1></A>

<p>In the preceding main section, I showed how you initialize a WDM driver when it's first
loaded. In general, though, a driver might be called upon to manage more than one actual
device. In the WDM architecture, a driver has a special <b>AddDevice</b> function that the PnP
Manager can call for each such device. The function has the following prototype:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>
NTSTATUS燗ddDevice(PDRIVER_OBJECT燚riverObject,燩DEVICE_OBJECT爌do)
牋{
牋}
</pre>
</td></tr>
</table>
</p>

<p>The <b>DriverObject</b> argument points to the same driver object that you initialized in
your DriverEntry routine. The <b>pdo</b> argument is the address of the physical device object
at the bottom of the device stack, even if there are already filter drivers below.</p>

<p>The basic responsibility of AddDevice in a function driver is to create a device object and
link it into the stack rooted in this PDO. The steps involved are as follows:</p>

<ol>
<p><li> Call IoCreateDevice to create a device object and an instance of your own device
extension object.</li></p>

<p><li> Register one or more device interfaces so that applications know about the
existence of your device. Alternatively, give the device object a name and then create a
symbolic link.</li></p>

<p><li> Next initialize your device extension and the Flags member of the device
object.</li></p>

<p><li> Call IoAttachDeviceToDeviceStack to put your new device object into the
stack.</li></p>
</ol>

<p>Now I'll explain these steps in more detail.</p>

<A NAME="45"><H2>Creating a Device Object</H2></A>

<p>You create a device object by calling <b>IoCreateDevice</b>. For example:</p>

<p>
<table cellpadding=5 width="95%"><tr><td>
<pre>
PDEVICE_OBJECT爁do;
NTSTATUS爏tatus