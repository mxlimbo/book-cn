 
<HTML>
<!-- #BeginTemplate "/模板/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 用VB编写网络监控软件</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='http://www.yesky.com' target="_blank"><IMG SRC='images/logo.gif' WIDTH='140' HEIGHT='60' ALT='天极网' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com" target="_blank"><img src="images/0823-3.gif" width="468" height="60" border="0" alt="天极飞翔聊天室"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='http://www.cpcw.com/'>《电脑报》电子版</a> 
      &gt; <a href='http://www.cpcw.com/all.html'>2000年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->42期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->{用VB编写网络监控软件}<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->{用VB编写网络监控软件}<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{　　随着互联网迅速的膨胀发展，学校、企业、网吧大部分都通过局域网连上了Internet，但是由于人员多、上网机器分散，给上网管理带来了种种不便。为此，笔者编写了一个小程序，在局域网内的每个工作站运行此程序，可以对每个工作站访问的网址进行记录。在网吧中，可以为网络犯罪提供可靠的依据；在学校里，我们可以及时地限制同学们访问非法站点和有不健康内容的网站。程序用VB6.0编写，下面是程序实现的步骤。该程序在Windows 
      98和IE5.5下调试通过。<br>
      　　一、程序核心<br>
      　　本程序的核心是通过API函数获得窗口句柄并获得浏览器访问的网址，在此基础上可以实现用Winsock控件进行远程的监视和管理。<br>
      　　1.先创建一个工程并在窗口Form1中，并声明下面的四个API函数和两个常量：<br>
      　　Option Explicit Private Declare Function FindWindow Lib ″user32″ Alias 
      ″FindWindowA″ (ByVal lpCl assName As String， ByVal lpWindowName As String) 
      As Long<br>
      　　′Findwindow函数的功能是找到当前运行的IE窗口的url地址的句柄<br>
      　　Private Declare Function SendMessage Lib ″user32″ Alias ″SendMessageA″ 
      (ByVal hwnd As Long， ByVal wMsg As Long， ByVal wParam As Long， lParam As 
      Long) As Long<br>
      　　′SendMessage函数的功能是向操作系统发送一条消息<br>
      　　Private Declare Function FindWindowEx Lib ″user32″ Alias ″FindWindowExA″ 
      (ByVal hWnd1 As Long，ByVal hWnd2 As Long， ByVal lpsz1 As String， ByVal lpsz2 
      As String) As Long<br>
      　　′FindwindowEx函数的功能是找到子窗体的句柄<br>
      　　Private Declare Function SendMessageByString Lib ″user32″ Alias ″SendMessageA″ 
      (ByVal hwnd As Long， ByVal wMsg As Long， ByVal wParam As Long， ByVal lParam 
      As String) As Long<br>
      　　Private Const WM_GETTEXT = ＆HD<br>
      　　Private Const WM_GETTEXTLENGTH = ＆HE<br>
      　　2.在窗体上添加Command控件，并命名为GetURLstring，单击此命令按钮，并为其添加下面的程序代码：<br>
      　　Private Sub GetURLstring_Click()<br>
      　　On Error GoTo CallErrorA<br>
      　　Dim sClassName As String ′设定一个字符串变量，是类变量<br>
      　　Dim lhwnd As Long ′设定一个长整形变量用来接收函数返回值<br>
      　　Dim WindowHandle As Long ′设定一个长整形变量用来接收函数的返回句柄<br>
      　　lhwnd = 0<br>
      　　sClassName = (″IEFrame″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得URL地址栏的句柄，获得IE窗口的句柄<br>
      　　sClassName = (″WorkerA″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得IE窗口的工作区的句柄<br>
      　　sClassName = (″ReBarWindow32″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得IE窗口的菜单栏的句柄<br>
      　　sClassName = (″ComboBoxEx32″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得IE窗口的下拉菜单的句柄<br>
      　　sClassName = (″ComboBox″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得IE窗口的下拉菜单当前项的句柄<br>
      　　sClassName = (″Edit″)<br>
      　　lhwnd = FindWindowEx(lhwnd， 0， sClassName， vbNullString) ′获得这个下拉菜单的编辑框句柄<br>
      　　WindowHandle = lhwnd ′接收当前我们想要的句柄<br>
      　　Dim buffer As String ′设定字符串变量接收当前的字符串<br>
      　　Dim TextLength As Long ′设定长整形变量接收字符串的长度<br>
      　　TextLength = SendMessage(WindowHandle， WM_GETTEXTLENGTH， 0＆， 0＆) ′向系统发送获得IE窗口的地址栏中的字符串长度命令<br>
      　　buffer = String(TextLength， 0) ′<br>
      　　Call SendMessageByString(WindowHandle， WM_GETTEXT， TextLength ＋ 1， buffer) 
      ′向系统发送获得IE窗体地址栏中的字符串命令<br>
      　　If buffer = ″″ Then<br>
      　　MsgBox ″MicroSoft InternetExplorer浏览器没有运行.″， vbOKOnly<br>
      　　Else<br>
      　　MsgBox buffer ′IE运行时显示当前网址<br>
      　　End If<br>
      　　Exit Sub<br>
      　　CallErrorA:<br>
      　　MsgBox Err.Description<br>
      　　Err.Clear<br>
      　　End Sub<br>
      　　二、添加定时保存功能<br>
      　　我们对上面的程序稍作改动，即可实现定时把当前访问的网址保存到文件，这样就为我们进行网络监控提供了保证。<br>
      　　1．在窗体上添加Timer控件Timer1，并将其属性Interval设置为1000，双击此控件，定义代码如下：<br>
      　　Private Sub Timer1_Timer()<br>
      　　GetURLstring_Click<br>
      　　End Sub<br>
      　　2． 在窗体代码开始的声明部分定义变量curUrl<br>
      　　Dim curUrl As String<br>
      　　3．用文件操作函数把Buffer变量中的字符串写进磁盘文件中，添加代码如下<br>
      　　Private Sub Form_Load()<br>
      　　Open App.Path ＆ ″\TestFile.txt″ For Output Access Write As ＃1 ′打开一个文件End 
      Sub<br>
      　　Private Sub Form_QueryUnload(Cancel As Integer， UnloadMode As Integer)<br>
      　　Close ＃1 ′关闭开始打开的文件<br>
      　　End Sub<br>
      　　并把GetURLstring_Click()中的如下部分<br>
      　　If buffer = ″″ Then <br>
      　　MsgBox ″MicroSoft InternetExplorer浏览器没有运行.″， vbOKOnly<br>
      　　Else<br>
      　　MsgBox buffer ′IE运行时显示当前网址<br>
      　　End If<br>
      　　改为如下代码:<br>
      　　If buffer &lt;&gt; ″″ And buffer &lt;&gt; curUrl Then<br>
      　　Write ＃1， Now ＆ vbTab ＆ buffer<br>
      　　curUrl = buffer<br>
      　　End If<br>
      　　三、隐蔽运行<br>
      　　为了防止运行在客户端的程序被用户发现，可以把窗体隐藏，并调用API函数让其在Ctrl＋Alt＋Del的程序列表中消失，需要把自己的程序注册为服务器（Service），这可以利用RegisterService 
      API函数将程序的进程ID进行注册来实现。在程序退出时再次使用此API函数将服务器注册取消。方法如下：<br>
      　　1.在窗体的声明部分声明加入API函数和需要的常数：<br>
      　　Private Declare Function GetCurrentProcessId Lib ″kernel32″ () As Long<br>
      　　Private Declare Function GetCurrentProcess Lib ″kernel32″ () As Long<br>
      　　Private Declare Function RegisterServiceProcess Lib ″kernel32″ (ByVal 
      dwProcessID As Long， _ ByVal dwType As Long) As Long<br>
      　　Private Const RSP_SIMPLE_SERVICE = 1<br>
      　　Private Const RSP_UNREGISTER_SERVICE = 0<br>
      　　2.注册为service和释放注册的过程：<br>
      　　在Form_Load事件的开始添加如下代码<br>
      　　Dim pid As Long<br>
      　　Dim reserv As Long<br>
      　　pid = GetCurrentProcessId() ′得到当前进程ID<br>
      　　regserv = RegisterServiceProcess(pid， RSP_SIMPLE_SERVICE) ′把本程序注册为service<br>
      　　把Form_QueryUnload事件修改为如下代码，即在程序结束时把服务器注册取消<br>
      　　Private Sub Form_QueryUnload(Cancel As Integer， UnloadMode As Integer)<br>
      　　Dim pid As Long<br>
      　　Dim reserv As Long<br>
      　　Close ＃1<br>
      　　pid = GetCurrentProcessId()<br>
      　　regserv = RegisterServiceProcess(pid， RSP_UNREGISTER_SERVICE)<br>
      　　End Sub<br>
      　　如果让程序开机运行，需要先把文件编译为可执行文件放到特定目录下，并修改注册表让其开机便运行，路径是\HKEY_LOCAL_MACHINE\Software\Microsoft\Windows\CurrentVerson\Run，用API函数在里面写入个字符串型的键值，并把内容修改成为你的文件名(包括路径)即可，当然，更为实用的功能是把访问的网址信息定时传送到服务器，需要用到Winsock控件和定时传输。<br>
      　　如果你对此程序感兴趣，可以到http://www.d1vb.com下载完整的源代码，也可和我们交流。<br>
      　　(河北　孙寿天　张广坡)}<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD> 
      <script language="JavaScript" src="../../download/yeskye.js">
</script>
    </TD>
    <TD> <noscript></noscript> <a href='/'>《电脑报》版权所有</a>，<a href='mailto:webmaster@staff.yesky.com'>YESKY网站编辑部</a>设计制作发布</TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
