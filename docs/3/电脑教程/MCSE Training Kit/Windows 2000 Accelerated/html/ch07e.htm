<!DOCTYPE html SYSTEM "msxhtml1-strict.dtd">
<html lang="en" xml:lang="en">
<head>
<link rel="stylesheet" type="text/css" href="styles.css" />
<script type="text/javascript" language="JavaScript" src="expando.js"></script>
<title>Lesson 4: Increasing Security with EFS</title>


</head>
<body>
<div class="prevnext"><p><a href="ch07d.htm">3</a> <a href="ch07f.htm">4</a></p></div>

<h1><a name="550">Lesson 4: Increasing Security with EFS</a></h1>


<p>The Microsoft Encrypting File System (EFS) provides encryption for data in NTFS files stored on disk. EFS encryption is public key-based and runs as an integrated-system service, making it easy to manage, difficult to attack, and transparent to the file owner. If a user who attempts to access an encrypted NTFS file has the private key to that file, the file can be decrypted so that the user can open the file and work with it transparently as a normal document. A user without the private key is denied access.</p>

<p>Windows 2000 includes the Cipher command-line utility, which enables you to encrypt and decrypt files and folders from a command prompt. Windows 2000 also provides a recovery agent utility so that if the owner loses the private key, the recovery agent can still recover the encrypted file.</p>

<hr />
<p><b>After this lesson, you will be able to</b></p>
<ul>
<li>Encrypt folders and files</li>
</ul>
<p><b>Estimated lesson time: 30 minutes</b></p>
<hr />

<h2><a name="551">Understanding EFS</a></h2>


<p>EFS allows users to encrypt NTFS files by using a strong public key-based cryptographic scheme that encrypts all files in a folder. Users with roaming profiles can use the same key with trusted remote systems. No administrative effort is needed, and most operations are transparent. Backups and copies of encrypted files are also encrypted if they are in NTFS volumes. Files remain encrypted if you move or rename them, and encryption isn't defeated by temporary files created during editing and left unencrypted in the paging file or in a temporary file.</p>

<p>You can set policies to recover EFS-encrypted data when necessary. The recovery policy is integrated into the overall Windows 2000 security policy. Control of this policy can be delegated to individuals with recovery authority, and different recovery policies can be configured for different parts of the enterprise. Data recovery discloses only the recovered data, not the key that was used to encrypt the file. Several protections are in place to ensure that data recovery is possible and that no data is lost in the event of a total system failure.</p>

<p>EFS is implemented either from Windows Explorer or from the command line. It can be enabled or disabled for a computer, domain, or organizational unit by resetting recovery policy in the Group Policy console in the MMC.</p>

<blockquote><div class="note"><b>NOTE</b><hr />
To set group policy for the domain or for an organizational unit, your computer must be part of a Windows 2000 domain.
</div></blockquote>

<p>You can use EFS to encrypt and decrypt files on remote file servers but not to encrypt data that is transferred over the network. Windows 2000 provides network protocols, such as Secure Sockets Layer (SSL) authentication, to encrypt data over the network.</p>

<p>Table 7.6 describes the key features provided by Windows 2000 EFS.</p>

<p><b>Table 7.6</b><i> EFS Features</i></p>

<table>
<tr><th>Feature</th><th>Description</th></tr>
<tr><td>Transparent encryption</td><td>In EFS, file encryption doesn't require the file owner to decrypt and re-encrypt the file on each use. Decryption and encryption happen transparently on file reads and writes to disk.</td></tr>
<tr><td>Strong protection of encryption keys</td><td>Public key encryption resists all but the most sophisticated methods of attack. Therefore, in EFS, the file encryption keys that are used to encrypt the file are encrypted by using a public key from the user's certificate. (Note: Windows 2000 uses X.509 v3 certificates.) The list of encrypted file- encryption keys is stored with the encrypted file and is unique to it. To decrypt the file-encryption keys, the file owner supplies a private key, which only the file owner has.</td></tr>

<tr><td>Integral data recovery</td><td>If the owner's private key is unavailable, the recovery system agent can open the file using his or her own private key. There can be more than one recovery agent, each with a different public key, but at least one public recovery key must be present on the system to encrypt a file.</td></tr>

<tr><td>Secure temporary and paging files</td><td>Many applications create temporary files while you edit a 
document, and these temporary files can be left unencrypted on the disk. On computers running Windows 2000, EFS is implemented at the folder level, so any temporary copies of an encrypted file are also encrypted, provided that all files are on NTFS volumes. EFS resides in the Windows operating system kernel and uses the nonpaged pool to store file encryption keys, ensuring that they are never copied to the paging file.</td></tr>
</table>

<h2><a name="552">Encrypting</a></h2>


<p>The recommended method to encrypt files is to create an NTFS folder and then &quot;encrypt&quot; the folder. To encrypt a folder, in the Properties dialog box for the folder, click the General tab. On the General tab, click the Advanced button, and then select the Encrypt Contents To Secure Data check box. All files placed in the folder will be encrypted. The folder is now marked for encryption. Folders that are marked for encryption aren't actually encrypted; only the files within the folder are encrypted.</p>

<blockquote><div class="note"><b>NOTE</b><hr />
Compressed files can't be encrypted, and encrypted files can't be compressed.
</div></blockquote>

<p>After you encrypt the folder, when you save a file in that folder, the file is encrypted by using <i>file encryption keys,</i> which are fast symmetric keys designed for bulk encryption. The file is encrypted in blocks, with a different file encryption key assigned to each block. All of the file encryption keys are stored and encrypted in the Data Decryption Field (DDF) and the Data Recovery Field (DRF) in the file header.</p>

<blockquote><div class="note"><b>NOTE</b><hr />
By default, encryption provided by EFS is standard 56-bit encryption. For additional security, North American users can obtain 128-bit encryption by ordering the Enhanced CryptoPAK from Microsoft. Files encrypted by the CryptoPAK cannot be decrypted, accessed, or recovered on a system that supports only 56-bit encryption.
</div></blockquote>

<p>You use a file that you encrypted just as you would use any other file. Encryption is transparent. You don't need to decrypt a file you encrypted before you can use it. When you open an encrypted file, your private key is applied to the DDF to unlock the list of file-encryption keys, allowing the file contents to appear in plain text. EFS automatically detects an encrypted file and locates a user certificate and associated private key. You open the file, make changes to it, and save it as you would any other file. However, if someone else tries to open your encrypted file, he or she will be unable to access the file and will receive an &quot;access denied&quot; message.</p>

<blockquote><div class="note"><b>NOTE</b><hr />
Encrypted files can't be shared.
</div></blockquote>

<h2><a name="553">Decrypting</a></h2>


<p>Decrypting a folder or file refers to clearing the Encrypt Contents To Secure Data check box in a folder's or file's Advanced Attributes dialog box, which you access from the Properties dialog box for the folder or file. Once decrypted, the file remains decrypted until you select the Encrypt Contents To Secure Data check box. The only reason you might want to decrypt a file is if other people needed access to the folder or file; for example, if you want to share the folder or make the file available across the network.</p>

<h2><a name="554">Using the Cipher Command</a></h2>


<p>Windows 2000 also includes command-line utilities for the richer functionality that is required for some administrative operations. The Cipher command-line utility allows you to encrypt and decrypt files and folders from a command prompt.</p>

<p>The following syntax example shows the available options for the Cipher command. Table 7.7 describes these options.</p>

<div class="code">
<pre>
cipher [/e | /d] [/s:<i>folder_name</i>] [/a] [/i] [/f] [/q] [/h] [/k] [<i>file_name</i> [...]]
</pre>
</div>

<p><b>Table 7.7 </b><i>Cipher Command Options and Descriptions</i></p>

<table>
<tr><th>Option</th><th>Description</th></tr>
<tr><td>/e</td><td>Encrypts the specified folders. Folders are marked so that files that are added later will be encrypted.</td></tr>
<tr><td>/d</td><td>Decrypts the specified folders. Folders are marked so that files that are added later will not be encrypted.</td></tr>
<tr><td>/s</td><td>Performs the specified operation on folders in the given folder and all subfolders.</td></tr>
<tr><td>/a</td><td>Performs the specified operation on files as well as folders. Encrypted files could be decrypted when modified, if the parent folder is not encrypted. To avoid this, encrypt the file and the parent folder.</td></tr>
<tr><td>/I</td><td>Continues performing the specified operation even after errors have occurred. By default, Cipher stops when an error is encountered.</td></tr>
<tr><td>/f</td><td>Forces the encryption operation on all specified files, even those that are already encrypted. Files that are already encrypted are skipped by default.</td></tr>
<tr><td>/q</td><td>Reports only the most essential information.</td></tr>
<tr><td>/h</td><td>Displays files with the hidden or system attributes, which are not shown by default.</td></tr>
<tr><td>/k</td><td>Creates a new file encryption key for the user running the Cipher command. Using this option causes the Cipher command to ignore all other options.</td></tr>
<tr><td><i>file_name</i></td><td>Specifies a pattern, file, or folder.</td></tr>
</table>

<p>If you run the Cipher command without parameters, it displays the encryption state of the current folder and any files that it contains. You can specify multiple filenames and use wildcards. You must put spaces between multiple parameters.</p>

<h2><a name="555">Using the Recovery Agent</a></h2>


<p>If the owner's private key is unavailable, a person designated as the recovery agent can open the file using his or her own private key, which is applied to the DRF to unlock the list of file-encryption keys. If the recovery agent is on another computer in the network, send the file to the recovery agent. The recovery agent can bring his or her private key to the owner's computer, but it is never a good security practice to copy a private key onto another computer.</p>

<blockquote><div class="note"><b>NOTE</b><hr />
The default recovery agent is the administrator of the local computer unless the computer is part of a domain. In a domain, the domain administrator is the default recovery agent.
</div></blockquote>

<p>It is a good security practice to rotate recovery agents. However, if the agent designation changes, access to the file is denied. Therefore, Microsoft recommends that you keep recovery certificates and private keys until you have updated all files that are encrypted with them.</p>

<p>The person designated as the recovery agent has a special certificate and associated private key that allow data recovery. To recover an encrypted file, the recovery agent would do the following:</p>

<ol>
<li>Use Backup or another backup tool to restore a user's backup version of the encrypted file or folder to the computer on which his or her file recovery certificate is located.</li>
<li>In Windows Explorer, open the Properties dialog box for the file or folder, and on the General tab, click the Advanced button.</li>
<li>Clear the Encrypt Contents To Secure Data check box.</li>
<li>Make a backup version of the decrypted file or folder and return the backup version to the user.</li>
</ol>

<p><img src="images/practice.jpg" /></p>
<h2><a name="556">Practice: Encrypting and Decrypting Files</a></h2>


<p>In this practice, you encrypt a folder and its files.</p>

<h3><a name="557">Exercise 1: Encrypting Files</a></h3>


<p><b>To encrypt a file</b></p>

<ol>
<li>Ensure you are logged on as Administrator and in Windows Explorer, on the root of drive C, create the folder Secret and in the folder Secret, create the file File1.txt. Then right-click File1 and click Properties.
<p>Windows 2000 displays the Properties dialog box with the General tab active.</p></li>
<li>Click Advanced.
<p>The Advance Attributes dialog box appears.</p></li>
<li>Click the Encrypt Contents To Secure Data check box and then click OK.</li>
<li>Click OK to close the File1 Properties dialog box.
<p>An Encryption Warning dialog box informs you that you are about to encrypt a file that isn't in an encrypted folder. The default is to encrypt the folder and file, but you can also choose to encrypt only the file.</p></li>
<li>Click Cancel, and then click Cancel again to close the Owner Properties dialog box.</li>
<li>In Windows Explorer, right-click the Secret folder and then click Properties.</li>
<li>Click Advanced.
<p>The Advance Attributes dialog box appears.</p></li>
<li>Click the Encrypt Contents To Secure Data check box and then click OK.</li>
<li>Click OK to close the Secret Properties dialog box.
<p>The Confirm Attribute Changes dialog box informs you that you are about to encrypt a folder. You have two choices: you can encrypt only this folder, or you can encrypt the folder and all subfolders and files in the folder.</p></li>
<li>Select the Apply Changes To This Folder, Subfolders And Files option, and then click OK.</li>
</ol>

<p><b>To verify that the folder's content is encrypted</b></p>

<ol>
<li>In the Secret folder, right-click File1 and then click Properties.
<p>The File1 Properties dialog box appears.</p></li>
<li>Click Advanced.
<p>The Advanced Attributes dialog box appears. Notice that the Encrypt Contents To Secure Data check box is selected.</p></li>
<li>Close the Advanced Attributes dialog box.</li>
<li>Close the Properties dialog box.</li>
<li>Close all windows and log off.</li>
</ol>

<h3><a name="558">Exercise 2: Testing the Encrypted Files</a></h3>


<p>In this exercise, you log on using the User3 account and then attempt to open an encrypted file. You then try to disable encryption on the encrypted files.</p>

<p><b>To test an encrypted file</b></p>

<ol>
<li>Log on as User3 with a password of <i>password.</i></li>
<li>Start Windows Explorer and open the file File1.txt in the Secret folder.
<p>What happens?</p>

<p><a href="chaaa.htm#q22">Answer</a></p></li>
<li>Close Notepad.</li>
</ol>

<p><b>To attempt to disable the encryption</b></p>

<ol>
<li>Right-click File1.txt and then click Properties.</li>
<li>Click Advanced.</li>
<li>Clear the Encrypt Contents To Secure Data check box and then click OK.</li>
<li>Click OK to close the File1 Properties dialog box.
<p>The Error Applying Attributes dialog box appears and informs you that access to the file is denied.</p></li>
<li>Click Cancel.</li>
<li>Close all open windows and dialog boxes.</li>
<li>Log off as User3 and log on as Administrator.</li>
</ol>

<h3><a name="559">Exercise 3: Decrypting Folders and Files</a></h3>


<p>In this exercise, you decrypt the folder and file that you previously encrypted.</p>

<ol>
<li>Start Windows Explorer.</li>
<li>Right-click File1.txt, and then click Properties.</li>
<li>Click Advanced.</li>
<li>Clear the Encrypt Contents To Secure Data check box and then click OK.</li>
<li>Click OK to close the File1 Properties dialog box.</li>
<li>Close Windows Explorer and log off.</li>
</ol>

<h2><a name="560">Lesson Summary</a></h2>


<p>In this lesson, you learned that EFS provides the core file-encryption technology for storage of NTFS files on disk. EFS allows users to encrypt NTFS files by using a strong public key-based cryptographic scheme that encrypts all files in a folder. Users with roaming profiles can use the same key with trusted remote systems. Backups and copies of encrypted files are also encrypted if they are in NTFS volumes. Files remain encrypted if you move or rename them, and encryption is not defeated by leakage to paging files. Windows 2000 also provides a recovery agent utility. If an owner loses the private key, the recovery agent can still recover the encrypted file.</p>

<p>You also learned that EFS is implemented either from Windows Explorer or from the command line, using commands such as Cipher. EFS can be enabled or disabled for a computer, domain, or organizational unit by resetting recovery policy in the Group Policy console in the MMC.</p>

<p>Finally, you learned that you can use EFS to encrypt and decrypt files on remote computers, but you can't use it to encrypt data that is transferred over the network. Windows 2000 provides network protocols, such as SSL, to encrypt data over the network.</p>

</body>
</html>



