<html>
<head>
<title>Lesson 7: Restoring Active Directory</title>
<link rel="STYLESHEET" type="text/css" href="mmads.css">

<SCRIPT LANGUAGE="JavaScript"><!-- 
function fullSize(sURL){window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}
--></SCRIPT>
</head>
<SCRIPT LANGUAGE="JavaScript">
<!--

function fullSize(sURL){
	window.open(sURL,'scrshot','width=500,height=375,top=20,left=20,directories=no , Toolbar = no, resizable = yes, menubar = no, ScrollBars = yes ');
}

function LibraryHeaderNav(sBackward, sForward, sImgLeftOff, sImgLeftOn, sImgRightOff, sImgRightOn, iH, iW, sImgLeftStyle, sImgRightStyle, sImgRuleStyle, sRuleColor, sRuleSize){
	var tableStr;
	//validate questionable args for defs
	tableStr = "<TABLE BORDER=0 CELLPADDING=0 CELLSPACING=0 border=0 width=100%>";
	tableStr += "<TR VALIGN=top ALIGN=right>";

	tableStr += "<TD align=right class=" + sImgRuleStyle + ">&nbsp;</TD>";	
	
	tableStr += "<TD width=34 align=right class=" + sImgLeftStyle + ">";
	tableStr += "<A href='" + sBackward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgLeftOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgLeftOff + '\'\"';
	tableStr += " SRC='" + sImgLeftOff + "' vspace=0 hspace=0></a></TD>";
	
	tableStr += "<TD width=34 align=left class=" + sImgRightStyle + ">";
	tableStr += "<A href='" + sForward + "'>";
	tableStr += "<IMG HEIGHT=" + iH + " WIDTH=" + iW + " BORDER=0";
	tableStr += ' OnMouseOver=\"this.src=\'' + sImgRightOn + '\'\"';
	tableStr += ' OnMouseOut=\"this.src=\'' + sImgRightOff + '\'\"';
	tableStr += " SRC='" + sImgRightOff + "' vspace=0 hspace=0></a></TD></TR>";

	tableStr += "<TR VALIGN=top>";
	tableStr += "<TD height=3 align=center colspan=3 class=" + sImgRuleStyle + ">";
	tableStr += "<HR color=" + sRuleColor + " size=" + sRuleSize + "></TD></TR></TABLE>";
	//alert(tableStr);
	document.write(tableStr);
}

 																						     //purple is: #aa22aa   orange is: #ff9900
LibraryHeaderNav("ch11g.htm", "ch11i.htm", "images/unit_p_a1.gif", "images/unit_p_a2.gif", "images/unit_p_b1.gif", "images/unit_p_b2.gif", 18, 34, "unit01", "unit02", "headerrule", "#aa22aa", "2");
//--></SCRIPT><P>

<A NAME="572"><h1>Lesson 7: Restoring Active Directory</h1></A>
<p>There are two ways to restore Active Directory: nonauthoritatively and authoritatively. In this lesson you will learn how to restore Active Directory.</p>

<p>
<div class="sidebar"><blockquote>

<b>After this lesson, you will be able to</b>

<ul>

<p><li>Explain the difference between nonauthoritative and authoritative restore</li></p>

<p><li>Restore Active Directory</li></p>

</ul>

<p><b>Estimated lesson time: 25 minutes</b></p>

</blockquote></div>
</p>


<A NAME="573"><h2>Preparing to Restore Active Directory</h2></A>
<p>Like the backup process, when you choose to restore Active Directory, you can only restore all of the System State data that was backed up, including the registry, the COM+ Class Registration database, system boot files, the SYSVOL directory, the Active Directory, and the Certificate Services database (if the server is a certificate server). You cannot choose to restore individual components (for example, only the Active Directory) of the System State data.</p>

<p>If you are restoring the System State data to a domain controller, you must choose whether you want to perform a <i>nonauthoritative restore</i> or an <i>authoritative restore</i>. The default method of restoring the System State data to a domain controller is nonauthoritative.</p>


<A NAME="574"><h2>Nonauthoritative Restore</h2></A>
<p>In nonauthoritative mode, any component of the System State that is replicated with another domain controller, such as Active Directory directory service, will be brought up to date by replication after you restore the data. For example, if the last backup was performed a week ago, and the System State is restored nonauthoritatively, any changes made subsequent to the backup operation will be replicated from the other domain controllers. The Active Directory replication system will update the restored data with newer data from your other servers.</p>


<A NAME="575"><h2>Authoritative Restore</h2></A>
<p>If you do not want to replicate the changes that have been made subsequent to the last backup operation you must perform an authoritative restore. For example, you must perform an authoritative restore if you inadvertently delete users, groups, or OUs from Active Directory and you want to restore the system so that the deleted objects are recovered and replicated.</p>

<p>To authoritatively restore Active Directory data, you must run the NTDSUTIL utility after you have performed a nonauthoritative restore of the System State data but before you restart the server. The NTDSUTIL utility allows you to mark objects as authoritative. Marking objects as authoritative changes the update sequence number of an object so it is higher than any other update sequence number in the Active Directory replication system. This ensures that any replicated or distributed data that you have restored is properly replicated or distributed throughout your organization. The NTDSUTIL utility can be found in the <i>systemroot</i>\system32 directory and accompanying documentation within the Windows 2000 Help files (available from the Start menu).</p>

<p>For example, suppose you back up the system on Monday, and then create a new user called James Smith on Tuesday, which replicates to other domain controllers in the domain, but on Wednesday, another user, Amy Anderson, is accidentally deleted. To authoritatively restore Amy Anderson without reentering information, you can nonauthoritatively restore the domain controller with the backup created on Monday. Then, using NTDSUTIL, you can mark Amy Anderson as authoritative. The result is that Amy Anderson is restored without any effect on James Smith.</p>


<A NAME="576"><h2>Performing a Nonauthoritative Restore</h2></A>
<p>To restore the System State data on a domain controller, you must first start your computer in a special safe mode called Directory Services Restore Mode. This allows you to restore the SYSVOL directory and Active Directory directory services database. You can only restore System State data on a local computer. You cannot restore the System State data on a remote computer.</p>

<p>
<div class="note"><blockquote><b>NOTE</b><hr>
If you restore the System State data and you do not designate an alternate location for the restored data, Backup will erase the System State data that is currently on your computer and replace it with the System State data you are restoring. Also, if you restore the System State data to an alternate location, only the registry files, SYSVOL directory files, and system boot files are restored to the alternate location. The Active Directory directory services database, Certificate Services database, and COM+ Class Registration database are not restored if you designate an alternate location.
</blockquote></div>
</p>

<p><li><b>To nonauthoritatively restore Active Directory</b></li></p>

<ol>

<p><li> Restart the computer.</li></p>

<p><li> During the phase of startup where the operating system is normally selected, press F8.</li></p>

<p><li> On the Windows 2000 Advanced Options Menu, select Directory Services Restore Mode and press Enter. This ensures that the domain controller is offline and is not connected to the network.</li></p>

<p><li> At the Please Select The Operating System To Start prompt, select Microsoft Windows 2000 Server and press Enter.</li></p>

<p><li> Log on as Administrator.</li></p>

<p><li> On the Desktop message box that warns you that Windows is running in Safe Mode, click OK.</li></p>

</ol>

<p>
<div class="note"><blockquote><b>NOTE</b><hr>
When you restart the computer in Directory Services Restore Mode, you must log on as an Administrator by using a valid Security Accounts Manager (SAM) account name and password, <i>not</i> the Active Directory Administrator's name and password. This is because Active Directory is offline, and account verification cannot occur. Rather, the SAM accounts database is used to control access to Active Directory while it is offline. You specified this password when you set up Active Directory.
</blockquote></div>
</p>

<ol start=7>

<p><li> Point to Start, point to Programs, point to Accessories, point to System Tools, then select Backup.</li></p>

<p><li> On the Welcome To The Windows 2000 Backup And Recovery Tools page, select Restore Wizard.</li></p>

<p><li> Click Next to begin using the Restore Wizard.</li></p>

<p><li> In the Restore Wizard What To Restore page (see Figure 11.10), expand the media type that contains the data that you want to restore or click Import File. This can be either tape or file media.</li></p>

<p>
<A HREF="javascript:fullSize('11wtk10x.htm')"> <img src="images/11wtk10.JPG" width=404 height=309 border=0 ALT = "Click to view at full size."> </A>
</p><p>
<!-- caption --><b>Figure 11.10</b> <i>Restore Wizard What To Restore page</i><!-- /caption -->
</p>


<p><li> Expand the appropriate media set until the data that you want to restore is visible. You can restore a backup set or specific files and folders.</li></p>

<p><li> Select the data you want to restore, then click Next.</li></p>

<p><li> Do one of the following:</li></p>

<ul>

<p><li>Click Finish to start the restore process. The Restore Wizard requests verification for the source of the restore media and then performs the restore. During the restore, the Restore Wizard displays status information about the restore.</li></p>

<p><li>Click Advanced to specify advanced restore options.</li></p>

</ul>

</ol>


<A NAME="577"><h2>Specifying Advanced Restore Settings</h2></A>
<p>The Advanced settings in the Restore Wizard vary, depending on the type of backup media from which you are restoring. Table 11.10 describes the advanced restore options.</p>

<p><b>Table 11.10</b> <i>Advanced Restore Options</i></p>

<p>
	<table valign="top" cellpadding="5" width="95%">
	
		<tr>
			<th>Advanced Settings Page</th>
			<th>Option</th>
			<th>Description</th>
		</tr>
		
		<tr>
			<td valign="top">Where To Restore</td>
			<td valign="top">Restore Files To</td>			
			<td valign="top">The target location for the data that you are restoring. The choices in the list are:<br>
<i>Original Location&#8212;</i>replaces corrupted or lost data<br>
<i>Alternate Location&#8212;</i>restores an older version of a file to a folder you designate<br>
<i>Single Folder&#8212;</i>consolidates the files from a tree structure into a single folder. For example, use this option if you want copies of specific files but do not want to restore the hierarchical structure of the files. If you select either an alternate location or a single folder, you must also provide the path.</td>
		</tr>

		<tr>
			<td valign="top">How To Restore</td>
			<td valign="top">When Restoring Files That Already Exist</td>			
			<td valign="top">Whether or not to overwrite existing files. The choices are:<br>
<i>Do Not Replace The File On My Disk</i>&#8212;prevents accidental overwriting of existing data. This is the default<br>
<i>Replace The File On Disk Only If It Is Older Than The</i> 
<i>Backup Copy</i>&#8212;verifies that the most recent copy exists on the computer<br>
<i>Always Replace The File On Disk</i>&#8212;Windows Backup does not provide a confirmation message if it encounters a duplicate file name during the restore operation.<br></td>
		</tr>

		<tr>
			<td valign="top">Advanced Restore Options</td>
			<td valign="top">Select The Special Restore Options You Want To Use</td>			
			<td valign="top">Whether or not to restore security or special system files. The choices are:<br>
<i>Restore Security</i>&#8212;applies the original permissions to files that you are restoring to a Windows NTFS volume. Security settings include access permisions, audit entries, and ownership. This option is only available if you have backed up data from an NTFS volume and are restoring to an NTFS volume<br>
<i>Restore Removable Storage Database&#8212;</i>restores the configuration database for removable storage management (RSM) devices and the media pool settings. The database is located in <i>systemroot</i>\ system32\Ntmsdata<br>
<i>Restore Junction Points, Not The Folders And File Data They Reference&#8212;</i>restores junction points on your hard disk as well as the data that the junction points refer to. If you have any mounted drives and you want to restore the data that the mounted drives point to, you should select this check box. If you do not select this check box, the junction point will be restored but the data your junction point refers to may not be accessible.</td>
		</tr>
		
	</table>
</p>

<p>After you have finished the Restore Wizard, Windows Backup does the following:</p>

<ul>

<p><li>Prompts you to verify your selection of the source media to use to restore data. After the verification, Windows Backup starts the restore process.</li></p>

<p><li>Displays status information about the restore process. As with a backup process, you can choose to view the report (restore log) of the restore. It contains information about the restore, such as the number of files that have been restored and the duration of the restore process.</li></p>

</ul>


<A NAME="578"><h2>Performing an Authoritative Restore</h2></A>
<p>An authoritative restore occurs after a nonauthoritative restore and designates the entire directory, a subtree, or individual objects to be recognized as authoritative with respect to replica domain controllers in the forest. The NTDSUTIL utility allows you to mark objects as authoritative so that they are propagated through replication, thereby updating existing copies of those objects throughout the forest.</p>

<p><li><b>To authoritatively restore Active Directory</b></li></p>

<ol>

<p><li> Perform a nonauthoritative restore as described previously.</li></p>

<p><li> Restart the computer.</li></p>

<p><li> During the phase of startup where the operating system is normally selected, press F8.</li></p>

<p><li> On the Windows 2000 Advanced Startup Options Menu, select Directory Services Restore Mode and press Enter. This ensures that the domain controller is offline and is not connected to the network.</li></p>

<p><li> Select Windows 2000 Server.</li></p>

<p><li> Log on as Administrator.</li></p>

</ol>

<p>
<div class="note"><blockquote><b>NOTE</b><hr>
When you restart the computer in Directory Services Restore Mode, you must log on as an Administrator by using a valid SAM account name and password, <i>not</i> the Active Directory Administrator's name and password. This is because Active Directory is offline and account verification cannot occur. Rather, the SAM accounts database is used to control access to Active Directory while it is offline.
</blockquote></div>
</p>

<ol start=7>

<p><li> On the Desktop message box that warns you that Windows is running in Safe Mode, click OK.</li></p>

<p><li> Point to Start, point to Programs, point to Accessories, then select Command Prompt.</li></p>

<p><li> At the command prompt, type <b>NTDSutil</b> and press Enter.</li></p>

<p><li> At the NTDSUTIL prompt, type <b>authoritative restore</b> and press Enter.</li></p>

<p><li> At the authoritative restore prompt:</li></p>

<ul>

<p><li>To authoritatively restore the entire directory, type <b>restore</b> <b>database</b> and press Enter.</li></p>

<p><li>To authoritatively restore a portion or subtree of the directory, such as an OU, use the OU's distinguished name, type <b>restore subtree</b> &lt;<i>subtree distinguished name</i>&gt; and press Enter.</li></p>

</ul>

<p>For example, to restore the Security1 OU in the Microsoft.com domain, the commands would be:</p>

<p>
<table cellpadding=5 width="95%"><tr><td><pre>
NTDSutil
authoritative restore
restore subtree OU=Security1,DC=Microsoft,DC=COM
</pre></td></tr></table>
</p>

<ul>

<p><li>To authoritatively restore the entire directory <i>and</i> override the version increase, type <b>restore</b> <b>database verinc &lt;</b><i>version increase</i><b>&gt;</b> and press Enter.</li></p>

<p><li>To authoritatively restore a subtree of the directory <i>and</i> override the version increase, type <b>restore subtree &lt;</b><i>subtree distinguished name</i><b>&gt;verinc &lt;</b><i>version increase</i><b>&gt;</b> and press Enter.</li></p>

</ul>

<p>The authoritative restore opens the NTDS.DIT, increases version numbers, counts the records that need updating, verifies the number of records updated, and reports completion. If a version number increase is not specified, one is automatically calculated.</p>

<p><li> Type <b>quit</b> and press Enter to exit the NTDSUTIL utility, then close the Command Prompt window.</li></p>

<p><li> Restart the domain controller in normal mode and connect the restored domain controller to the network.</li></p>

</ol>

<p>When the restored domain controller is online and connected to the network, normal replication brings the restored domain controller up to date with any changes from the additional domain controllers that were not overridden by the authoritative restore. Replication also propagates the authoritatively restored object(s) to other domain controllers in the forest. The deleted objects that were marked as authoritative are replicated from the restored domain controller to the additional domain controllers. Because the objects that are restored have the same object GUID and object SID, security remains intact, and object dependencies are maintained.</p>


<A NAME="579"><h3>Additional Tasks for Authoritatively Restoring the Entire Active Directory Database</h3></A>
<p>When you authoritatively restore the entire Active Directory database, you also must perform an additional procedure involving the SYSVOL directory. This is necessary to ensure the integrity of the computer's group policy. To ensure the proper elements are authoritatively restored, you must also:</p>

<ul>

<p><li>Copy the SYSVOL directory on the alternate location over the existing one <i>after</i> the SYSVOL share is published.</li></p>

</ul>

<p>When you authoritatively restore a portion of the Active Directory database (including policy objects), you also must perform an additional procedure involving the SYSVOL directory. To ensure the proper elements are authoritatively restored, you must also:</p>

<ul>

<p><li>Copy only policy folders (identified by the GUID) corresponding to the restored Policy objects from the alternate location <i>after</i> the SYSVOL share is published. Then, copy them over the existing ones.</li></p>

</ul>

<p>When authoritatively restoring either the entire Active Directory database or selected objects, it is important that you copy the SYSVOL and policy data from the alternate location <i>after</i> the SYSVOL share is published. If the computer is in a replicated domain, it may take several minutes before the SYSVOL share is published because it needs to synchronize with its replication partners. If all computers in the domain are authoritatively restored and restarted at the same time, then each will be waiting (indefinitely) to synchronize with each other. In this case, restore one of the domain controllers first so that its SYSVOL share can be published; then restore the other computers nonauthoritatively.</p>


<A NAME="580"><h2>Lesson Summary</h2></A>
<p>In this lesson you learned how to restore Active Directory using nonauthoritative and authoritative restore. You learned that you must choose whether to restore in nonauthoritative or authoritative mode. In nonauthoritative restore mode, any component of the System State data that is replicated with another domain controller, such as Active Directory directory service, will be brought up to date by replication after you restore the data. In authoritative mode, changes that have been made, subsequent to the last backup operation are not restored; the deleted objects are recovered and replicated.</p>

<p>To restore the System State data on a domain controller, you must first start your computer in a special safe mode called Directory Services Restore Mode. This allows you to restore the SYSVOL directory and Active Directory directory services database. You can only restore System State data on a local computer. You cannot restore the System State data on a remote computer.</p>

<p>When performing a nonauthoritative restore, the Restore Wizard helps you restore data. When performing an authoritative restore, you first perform a nonauthoritative restore and then use the NTDSUTIL utility to mark objects as authoritative so that they are propagated through replication.</p>


</BODY>
</HTML>







