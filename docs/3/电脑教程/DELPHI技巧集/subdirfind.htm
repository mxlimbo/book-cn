<html>

<head>
<meta http-equiv="Content-Type" content="text/html; charset=gb2312">
<title>子目录级的文件查询的实现</title>
</head>

<body bgcolor="#FFFFFF" text="#000000">

<p>　<b><font SIZE="5"></p>

<p ALIGN="CENTER"></font><font size="6" color="#008080">子目录级的文件查询的实现</font></b><font
FACE="宋体" SIZE="4"></p>

<p ALIGN="JUSTIFY">在应用实践中，我们经常会用到文件查询功能。通过</font><font
FACE="Times New Roman" SIZE="4">Win95</font><font FACE="宋体" SIZE="4">中提供的文件查找，我们可以<br>
方便的找出磁盘上任何子目录下的文件，其原因是该查找功能可以遍历指定目录下的所有子<br>
目录中的文件。从编程角度讲，它实现了子目录级的文件查询。</p>

<p ALIGN="JUSTIFY">其实，这项功能并不难实现，关键是能理解并掌握递归这种程序设计思路。本人用</font><font
FACE="Times New Roman" SIZE="4">Delphi</font><br>
<font FACE="宋体" SIZE="4">实现了该项功能（任意子目录级），由于使用了递归，程序思路清晰，代码量小。</font><font
SIZE="4"> </font><font FACE="宋体" SIZE="5"><b></p>

<p ALIGN="JUSTIFY">实现方法：</p>

<blockquote>
  <blockquote>
    </b></font><font FACE="宋体" SIZE="4"><p ALIGN="JUSTIFY">1． 
    获取当前目录下的所有下一级子目录，2． 存入字符串列表中（</font><font
    FACE="Times New Roman" SIZE="4">Tstrings</font><font FACE="宋体" SIZE="4">）。</p>
    <p ALIGN="JUSTIFY">其中，用到了几个</font><font FACE="Times New Roman" SIZE="4">API</font><font
    FACE="宋体" SIZE="4">函数。</p>
    </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">FindFirst</font><font
    FACE="宋体" SIZE="4">是找出指定目录下第一个文件或目录。</p>
    </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">FindNext</font><font
    FACE="宋体" SIZE="4">一般和</font><font FACE="Times New Roman" SIZE="4">FindFirst</font><font
    FACE="宋体" SIZE="4">配合使用，用来找出下一个文件或目录。</p>
    </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">FindClose</font><font
    FACE="宋体" SIZE="4">用来关闭查询。</p>
    <p ALIGN="JUSTIFY">（以上函数</font><font FACE="Times New Roman" SIZE="4">Delphi</font><font
    FACE="宋体" SIZE="4">在线帮助中有详尽解释，在此不赘述）；</p>
    <p ALIGN="JUSTIFY">3． 用</font><font FACE="Times New Roman" SIZE="4">FileExists</font><font
    FACE="宋体" SIZE="4">函数查找当前目录，4． 
    寻找是否有满足条件的文件存在。</p>
    <p ALIGN="JUSTIFY">5． 依次使各个子目录成为当前目录，6． 
    递归调用本函数。</p>
    <p ALIGN="JUSTIFY">7． 释放资源，8． 返回查询结果。</p>
    </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY"></font>　</p>
  </blockquote>
</blockquote>

<p>　<font FACE="宋体" SIZE="5"><b></p>

<p ALIGN="JUSTIFY">代码如下：</p>

<blockquote>
  <blockquote>
    </b></font><font FACE="宋体" SIZE="4"><p ALIGN="JUSTIFY">1． 
    从搜索记录中判断是否是子目录。</font></p>
  </blockquote>
</blockquote>

<p>　<font FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">function IsValidDir(SearchRec:TSearchRec):Boolean;</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">if (SearchRec.Attr=16) and</p>

<p ALIGN="JUSTIFY">(SearchRec.Name&lt;&gt;'.') and</p>

<p ALIGN="JUSTIFY">(SearchRec.Name&lt;&gt;'..') then</p>

<p ALIGN="JUSTIFY">Result:=True</p>

<p ALIGN="JUSTIFY">else</p>

<p ALIGN="JUSTIFY">Result:=False;</p>

<p ALIGN="JUSTIFY">end;</p>

<blockquote>
  <blockquote>
    </font><font FACE="宋体" SIZE="4"><p ALIGN="JUSTIFY">2． 这是查询主体函数。</p>
  </blockquote>
  <p ALIGN="JUSTIFY">参数介绍：</p>
  </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">Mainpath</font><font
  FACE="宋体" SIZE="4">：</font><font SIZE="4"> </font><font FACE="宋体" SIZE="4">指定的查询目录。</p>
  </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">Filename</font><font
  FACE="宋体" SIZE="4">：</font><font SIZE="4"> </font><font FACE="宋体" SIZE="4">欲查询的文件。</p>
  </font><font FACE="Times New Roman" SIZE="4"><p ALIGN="JUSTIFY">Foundresult</font><font
  FACE="宋体" SIZE="4">：</font><font SIZE="4"> </font><font FACE="宋体" SIZE="4">返回的含完整路径的匹配文件（可能有多个）。</p>
  <p ALIGN="JUSTIFY">如果有匹配文件，函数返回</font><font FACE="Times New Roman"
  SIZE="4">True</font><font FACE="宋体" SIZE="4">，否则，返回</font><font
  FACE="Times New Roman" SIZE="4">False;</p>
  <p ALIGN="JUSTIFY"></font><font SIZE="4">　</font><font FACE="Times New Roman" SIZE="4"></p>
</blockquote>

<p ALIGN="JUSTIFY">function SearchFile(mainpath:string;filename:string;</p>

<p ALIGN="JUSTIFY">var foundresult:TStrings):Boolean;</p>

<p ALIGN="JUSTIFY">var</p>

<p ALIGN="JUSTIFY">i:integer;</p>

<p ALIGN="JUSTIFY">Found:Boolean;</p>

<p ALIGN="JUSTIFY">subdir1:TStrings;</p>

<p ALIGN="JUSTIFY">searchRec:TsearchRec;</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">found:=false;</p>

<p ALIGN="JUSTIFY">if Trim(filename)&lt;&gt;'' then</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">subdir1:=TStringList.Create;//</font><font FACE="宋体" SIZE="4">字符串列表必须动态生成</font><font
FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">//</font><font FACE="宋体" SIZE="4">找出所有下级子目录。</font><font
FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">if (FindFirst(mainpath+'*.*', faDirectory, SearchRec)=0) then</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">if IsValidDir(SearchRec) then</p>

<p ALIGN="JUSTIFY">subdir1.Add(SearchRec.Name);</p>

<p ALIGN="JUSTIFY">while (FindNext(SearchRec) = 0) do</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">if IsValidDir(SearchRec) then</p>

<p ALIGN="JUSTIFY">subdir1.Add(SearchRec.Name);</p>

<p ALIGN="JUSTIFY">end;</p>

<p ALIGN="JUSTIFY">end;</p>

<p ALIGN="JUSTIFY">FindClose(SearchRec);</p>

<p ALIGN="JUSTIFY">//</font><font FACE="宋体" SIZE="4">查找当前目录。</font><font
FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">if FileExists(mainpath+filename) then</p>

<p ALIGN="JUSTIFY">begin</p>

<p ALIGN="JUSTIFY">found:=true;</p>

<p ALIGN="JUSTIFY">foundresult.Add(mainpath+filename);</p>

<p ALIGN="JUSTIFY">end;</p>

<p ALIGN="JUSTIFY">//</font><font FACE="宋体" SIZE="4">这是递归部分，查找各子目录。</font><font
FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">for i:=0 to subdir1.Count-1 do</p>

<p ALIGN="JUSTIFY">found:=Searchfile(mainpath+subdir1.Strings[i]+</p>

<blockquote>
  <blockquote>
    <blockquote>
      <blockquote>
        <blockquote>
          <p ALIGN="JUSTIFY">'\',Filename,foundresult)or found;</p>
        </blockquote>
      </blockquote>
    </blockquote>
  </blockquote>
</blockquote>

<p ALIGN="JUSTIFY">//</font><font FACE="宋体" SIZE="4">资源释放并返回结果。</font><font
FACE="Times New Roman" SIZE="4"></p>

<p ALIGN="JUSTIFY">subdir1.Free;</p>

<p ALIGN="JUSTIFY">end;</p>

<p ALIGN="JUSTIFY">result:=found;</p>

<p ALIGN="JUSTIFY">end;</p>

<p ALIGN="JUSTIFY"></font><font SIZE="4">　</font><font FACE="宋体" SIZE="4"></p>

<p ALIGN="JUSTIFY">总之，只要掌握了思路，用哪种编程语言都可以实现。现在，你可以轻松的给你的系统挂上<br>
一个非常使用的功能了。</font></p>
</body>
</html>
