 
<HTML>
<!-- #BeginTemplate "/Templates/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 用DELPHI设计代理服务器（上）</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='/'><IMG SRC='../../images/logo.gif' WIDTH='143' HEIGHT='50' ALT='电脑报' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesk.com"><img src="images/0823-3.gif" width="468" height="60"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='/issue/index.html'>CPCW电子版</a> 
      &gt; <a href='http://drivers.cpcw.com/issue.htm'>2000 年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->29期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->用DELPHI设计代理服务器（上）<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->用DELPHI设计代理服务器（上）<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->　　用Delphi开发串口通信软件一般有两种方法：一是利用Windows的通信API函数，另一种是采用Microsoft的MSComm控件。利用API编写串口通信程序较为复杂，需要掌握大量通信知识，其优点是可实现的功能更强大，应用面更广泛，更适合于编写较为复杂的低层次通信程序。而利用MSComm控件则相对较简单，该控件具有丰富的与串口通信密切相关的属性及事件，提供了对串口的各种操作。<br>
      　　一、MSComm控件的主要属性及事件<br>
      　　（1）CommPort：设置或返回串行端口号，缺省为1。<br>
      　　（2）Setting：设置或返回串口通信参数，格式为“波特率，奇偶校验位，数据位，停止位”。例如：MSComm1.Setting:='9600,n,8,1'<br>
      　　（3）PortOpen：打开或关闭串行端口，格式为：MSComm1.PortOpen:={True|False}<br>
      　　（4）InBufferSize：设置或返回接收缓冲区的大小，缺省值为1024字节。<br>
      　　（5）InBufferCount：返回接收缓冲区内等待读取的字节数，可通过设置该属性为0来清空接收缓冲区。<br>
      　　（6）RThreshold：该属性为一阀值，它确定当接收缓冲区内的字节个数达到或超过该值后就产生代码为ComEvReceive的OnComm事件。<br>
      　　（7）SThreshold：该属性为一阀值，它确定当发送缓冲区内的字节个数少于该值后就产生代码为ComEvSend的OnComm事件。<br>
      　　（8）InputLen：设置或返回接收缓冲区内用Input读入的字节数，设置该属性为0表示Input读取整个缓冲区的内容。<br>
      　　（9）Input：从接收缓冲区读取一串字符。<br>
      　　（10）OutBufferSize：设置或返回发送缓冲区的大小，缺省值为512字节。<br>
      　　（11）OutBufferCount：返回发送缓冲区内等待发送的字节数，可通过设置该属性为0来清空缓冲区。<br>
      　　（12）OutPut：向发送缓冲区传送一串字符。<br>
      　　如果在通信过程中发生错误或事件，就会引发OnComm事件，并由CommEvent属性代码反映错误类型，在通信程序的设计中可根据该属性值来执行不同的操作。CommEvent属性值及其含义如下：<br>
      　　（1）ComEvSend：值为1，发送缓冲区的内容少于SThreshold指定的值。<br>
      　　（2）ComEvReceive：值为2，接收缓冲区内字符数达到RThreshold指定的值。<br>
      　　（3）ComEvFrame：值为1004，硬件检测到帧错误。<br>
      　　（4）ComEvRxOver：值为1008，接收缓冲区溢出。<br>
      　　（5）ComEvTxFull：值为1010，发送缓冲区溢出。<br>
      　　（6）ComEvRxParity：值为1009，奇偶校验错误。<br>
      　　（7）ComEvEOF：值为7，接收数据中出现文件尾（ASCII码为26）字符。<br>
      　　二、程序样例<br>
      　　在Delphi3.0中无法使用MSComm控件，笔者使用的是Delphi5.0。MSComm控件是VB中的OCX控件，首先需要将其添加到Delphi中，选择菜单“Component”→“Import 
      ActiveX Control”，在“Import ActiveX”页内选择“Microsoft Comm Control”，点击“Install”安装，安装后在“ActiveX”组件板中出现MSComm图标，即可被使用。有一点要注意，在Object 
      Inspector中MSComm控件的Input和Output属性是不可见的，但它们仍然存在，这两个属性的类型是OleVariant（Ole万能变量）。<br>
      　　下面是一接收程序的样例（主要部分），大家可根据实际需要进行完善。<br>
      　　在Form中放置一Memo控件用于显示接收的数据，Combobox1选择通信参数（Setting属性值），Combobox2选择串口（CommPort属性值），按Button1开始接收数据，按Button2停止接收。<br>
      　　procedure TForm1.FormCreate(Sender: TObject);<br>
      　　begin<br>
      　　Mscomm1.InBufferCount :=0; // 清空接收缓冲区<br>
      　　Mscomm1.InputLen :=0; // Input读取整个缓冲区内容<br>
      　　Mscomm1.RThreshold :=1; // 每次接收到字符即产生OnComm事件<br>
      　　end;<br>
      　　procedure TForm1.Button1Click(Sender: TObject);<br>
      　　begin<br>
      　　Mscomm1.Settings :=ComboBox1.Text;<br>
      　　if ComboBox2.Text ='com1' then // 假设只考虑com1和com2两种情况<br>
      　　　　Mscomm1.CommPort :=1<br>
      　　else<br>
      　　　　Mscomm1.CommPort :=2;<br>
      　　Mscomm1.PortOpen :=true; // 打开串口<br>
      　　Mscomm1.DTREnable :=true; // 数据终端准备好<br>
      　　Mscomm1.RTSEnable :=true; // 请求发送<br>
      　　end;<br>
      　　procedure TForm1.Button2Click(Sender: TObject);<br>
      　　begin<br>
      　　Mscomm1.PortOpen :=false; // 关闭串口<br>
      　　 Mscomm1.DTREnable :=false;<br>
      　　Mscomm1.RTSEnable :=false;<br>
      　　end;<br>
      　　procedure TForm1.MSComm1Comm(Sender: TObject);<br>
      　　var<br>
      　　recstr:Olevariant;<br>
      　　begin<br>
      　　　if Mscomm1.CommEvent = 2 then<br>
      　　　　begin<br>
      　　recstr := Mscomm1.Input ;<br>
      　　Memo1.text := Memo1.Text ＋ recstr;<br>
      　　end;<br>
      　　end;<br>
      　　（江西 万雪勇）<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD>&nbsp;</TD>
    <TD> <a name='top'></a> <img src='http://cq.cpcw.com/cgi-bin/Count.cgi?ft=2|md=8|df=cpcw.dat|dd=E|cache=F|expires=18000' width='1' height='1' alt='312345678'> 
      <script language="JavaScript" src="http://nethome.yesky.com/sp/yeskye.js">
</script>
      <noscript> <a href='http://best.nease.net/cgi-bin/view/viewbasic.cgi?cpcw' target='_blank'> 
      <img src='http://best.nease.net/cgi-bin/log.cgi?user=cpcw&refer=http%3A//www.cpcw.com/&cur=http%3A//www.cpcw.com/issue/1999/50/99500302.html#NoJavaScript' width='1' height='1' border='0' alt='网易中文排行榜'></a> 
      <!-- Start of NedStat Basic code --> <a href="http://usa.nedstatbasic.net/cgi-bin/viewstat?name=cpcwissue"><img
src="http://usa.nedstatbasic.net/cgi-bin/nedstat.gif?name=cpcwissue"
border=0 alt="" nosave width=1 height=1></a> <!-- End of NedStat Basic code --> 
      <!-- Start of ReferStat --> 
      <script type="text/javascript" language="JavaScript">
<!--
d=document;
d.write("<img src=\"http://usa.nedstatbasic.net");
d.write("/cgi-bin/referstat.gif?");
d.write("name=cpcwissue&refer=");
d.write(escape(top.document.referrer));
d.write("\" width=1 height=1 align=\"right\">");
// -->
</script>
      <!-- End of ReferStat --></noscript> <A HREF='/'>CPCW版权所有</A>，<A HREF='mailto:webmaster@cpcw.com'>CPCW网站编辑部</A>设计制作发布<script language="JavaScript" src="http://nethome.yesky.com/sp/yeskye.js">
</script></TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
