 
<HTML>
<!-- #BeginTemplate "/模板/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 --用Delphi设计代理服务器（中）</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='/'><IMG SRC='../../images/logo.gif' WIDTH='143' HEIGHT='50' ALT='电脑报' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com"><img src="images/0823-3.gif" width="468" height="60" border="0"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='/issue/index.html'>CPCW电子版</a> 
      &gt; <a href='http://drivers.cpcw.com/issue.htm'>2000 年</a> &gt; <a href='index.html'><!-- #BeginEditable "%C6%DA" -->30期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->{用Delphi设计代理服务器（中）}<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->{用Delphi设计代理服务器（中）<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{//主窗口建立<br>
      procedure TForm1.FormCreate(Sender: TObject);<br>
      begin<br>
      Service_Enabled:=false;<br>
      timer2.Enabled:=true;{窗口建立时，打开定时器}<br>
      end;<br>
      //窗口关闭时<br>
      procedure TForm1.FormClose(Sender: TObject; var Action: TCloseAction);<br>
      begin<br>
      timer1.Enabled:=false;{关闭定时器}<br>
      if Service_Enabled then<br>
      serversocket1.Active:=false;{退出程序时关闭服务}<br>
      end;<br>
      //退出程序按钮<br>
      procedure TForm1.N01Click(Sender: TObject);<br>
      begin<br>
      form1.Close;{退出程序}<br>
      end;<br>
      //开启代理服务后<br>
      procedure TForm1.ServerSocket1Listen(Sender: TObject;<br>
      Socket: TCustomWinSocket);<br>
      begin<br>
      Service_Enabled:=true;{置正在服务标志}<br>
      N11.Enabled:=false;<br>
      N21.Enabled:=true;<br>
      end;<br>
      //被代理端连接到代理服务器后，建立一个会话，并与套接字绑定...<br>
      procedure TForm1.ServerSocket1ClientConnect(Sender: TObject;<br>
      Socket: TCustomWinSocket);<br>
      var<br>
      i,j: integer;<br>
      begin<br>
      j:=－1;<br>
      for i:=1 to sessions do{查找是否有空白项}<br>
      if not session[i－1].Used and not session[i－1].CSocket.active then<br>
      begin<br>
      j:=i－1;{有，分配它}<br>
      session[j].Used:=true;{置为在用}<br>
      break;<br>
      end<br>
      else<br>
      if not session[i－1].Used and session[i－1].CSocket.active then<br>
      session[i－1].CSocket.active:=false;<br>
      if j=－1 then<br>
      begin{无，新增一个}<br>
      j:=sessions;<br>
      inc(sessions);<br>
      setlength(session,sessions);<br>
      session[j].Used:=true;{置为在用}<br>
      session[j].CSocket:=TClientSocket.Create(nil);<br>
      session[j].CSocket.OnConnect:=ClientSocket1Connect;<br>
      session[j].CSocket.OnDisconnect:=ClientSocket1Disconnect;<br>
      session[j].CSocket.OnError:=ClientSocket1Error;<br>
      session[j].CSocket.OnRead:=ClientSocket1Read;<br>
      session[j].CSocket.OnWrite:=ClientSocket1Write;<br>
      session[j].Lookingup:=false;<br>
      end;<br>
      session[j].SS_Handle:=socket.socketHandle; {保存句柄，实现绑定}<br>
      session[j].Request:=false;{无请求}<br>
      session[j].client_connected:=true;{客户机已连接}<br>
      session[j].remote_connected:=false;{远程未连接}<br>
      edit1.text:=inttostr(sessions);<br>
      end;<br>
      //被代理端断开时<br>
      procedure TForm1.ServerSocket1ClientDisconnect(Sender: TObject;<br>
      Socket: TCustomWinSocket);<br>
      var<br>
      i,j,k: integer;<br>
      begin<br>
      for i:=1 to sessions do<br>
      if (session[i－1].SS_Handle=socket.SocketHandle) and session[i－1].Used then<br>
      begin<br>
      session[i－1].client_connected:=false; {客户机未连接}<br>
      if session[i－1].remote_connected then<br>
      session[i－1].CSocket.active:=false {假如远程尚连接，断开它}<br>
      else<br>
      session[i－1].Used:=false;{假如两者都断开，则置释放资源标志}<br>
      break;<br>
      end;<br>
      j:=sessions;<br>
      k:=0;<br>
      for i:=1 to j do{统计会话数组尾部有几个未用项}<br>
      begin<br>
      if session[j－i].Used then<br>
      break;<br>
      inc(k);<br>
      end;<br>
      if k&gt;0 then{修正会话数组，释放尾部未用项}<br>
      begin<br>
      sessions:=sessions－k;<br>
      setlength(session,sessions);<br>
      end;<br>
      edit1.text:=inttostr(sessions);<br>
      end;<br>
      //通信错误出现时<br>
      procedure TForm1.ServerSocket1ClientError(Sender: TObject;<br>
      Socket: TCustomWinSocket; ErrorEvent: TErrorEvent;<br>
      var ErrorCode: Integer);<br>
      var<br>
      i,j,k: integer;<br>
      begin<br>
      for i:=1 to sessions do<br>
      if (session[i－1].SS_Handle=socket.SocketHandle) and session[i－1].Used then<br>
      begin<br>
      session[i－1].client_connected:=false;{客户机未连接}<br>
      if session[i－1].remote_connected then<br>
      session[i－1].CSocket.active:=false{假如远程尚连接，断开它}<br>
      else<br>
      session[i－1].Used:=false;{假如两者都断开，则置释放资源标志}<br>
      break;<br>
      end;<br>
      j:=sessions;<br>
      k:=0;<br>
      for i:=1 to j do<br>
      begin<br>
      if session[j－i].Used then<br>
      break;<br>
      inc(k);<br>
      end;<br>
      if k&gt;0 then<br>
      begin<br>
      sessions:=sessions－k;<br>
      setlength(session,sessions);<br>
      end;<br>
      edit1.text:=inttostr(sessions);<br>
      errorcode:=0;<br>
      end;<br>
      //被代理端发送来页面请求时<br>
      procedure TForm1.ServerSocket1ClientRead(Sender: TObject;<br>
      Socket: TCustomWinSocket);<br>
      var<br>
      tmp,line,host: string;<br>
      i,j,port: integer;<br>
      begin<br>
      for i:=1 to sessions do{判断是哪一个会话}<br>
      if session[i－1].Used and (session[i－1].SS_Handle=socket.sockethandle) then<br>
      begin<br>
      session[i－1].request_str:=socket.ReceiveText; {保存请求数据}<br>
      tmp:=session[i－1].request_str; {存放到临时变量}<br>
      memo1.lines.add(tmp);<br>
      j:=pos(char(13)＋char(10),tmp);{一行标志}<br>
      while j&gt;0 do{逐行扫描请求文本，查找主机地址}<br>
      begin<br>
      line:=copy(tmp,1,j－1);{取一行}<br>
      delete(tmp,1,j＋1);{删除一行}<br>
      j:=pos('Host',line);{主机地址标志}<br>
      if j&gt;0 then<br>
      begin<br>
      delete(line,1,j＋5);{删除前面的无效字符}<br>
      j:=pos(':',line);<br>
      if j&gt;0 then<br>
      begin<br>
      host:=copy(line,1,j－1);<br>
      delete(line,1,j);<br>
      try<br>
      port:=strtoint(line);<br>
      except<br>
      port:=80;<br>
      end;<br>
      end<br>
      else<br>
      begin<br>
      host:=trim(line);{获取主机地址}<br>
      port:=80;<br>
      end;<br>
      if not session[i－1].remote_connected then{假如远征尚未连接}<br>
      begin<br>
      session[i－1].Request:=true;{置请求数据就绪标志}<br>
      session[i－1].CSocket.host:=host;{设置远程主机地址}<br>
      session[i－1].CSocket.port:=port;{设置端口}<br>
      session[i－1].CSocket.active:=true;{连接远程主机}<br>
      session[i－1].Lookingup:=true;{置标志}<br>
      session[i－1].LookupTime:=0;{从0开始计时}<br>
      end<br>
      else<br>
      {假如远程已连接，直接发送请求}<br>
      session[i－1].CSocket.socket.sendtext(session[i－1].request_str); <br>
      break;{停止扫描请求文本}<br>
      end;<br>
      j:=pos(char(13)＋char(10),tmp);{指向下一行}<br>
      end;<br>
      break;{停止循环}<br>
      end;<br>
      end;<br>
      //当连接远程主机成功时<br>
      procedure TForm1.ClientSocket1Connect(Sender: TObject;<br>
      Socket: TCustomWinSocket);<br>
      var<br>
      i: integer;<br>
      begin<br>
      for i:=1 to sessions do<br>
      if (session[i－1].CSocket.socket.sockethandle=socket.SocketHandle) and session[i－1].Used 
      then<br>
      begin<br>
      session[i－1].CSocket.tag:=socket.SocketHandle;<br>
      session[i－1].remote_connected:=true;{置远程主机已连通标志}<br>
      session[i－1].Lookingup:=false;{清标志}<br>
      break;<br>
      end;<br>
      　　end;<br>
      (未完待续)}<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD>&nbsp;</TD>
    <TD> <a name='top'></a> <img src='http://cq.cpcw.com/cgi-bin/Count.cgi?ft=2|md=8|df=cpcw.dat|dd=E|cache=F|expires=18000' width='1' height='1' alt='312345678'> 
       <A HREF='/'>CPCW版权所有</A>，<A HREF='mailto:webmaster@cpcw.com'>CPCW网站编辑部</A>设计制作发布<script language="JavaScript" src="http://nethome.yesky.com/sp/yeskye.js">
</script></TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
