 
<HTML>
<!-- #BeginTemplate "/模板/software.dwt" --> 
<HEAD>
<META HTTP-EQUIV='Content-Type' CONTENT='text/html; charset=gb2312'>
<META NAME='author' CONTENT='William Wan'>
<LINK REL='STYLESHEET' HREF='epcw.css' TYPE='text/css'>
<!-- #BeginEditable "doctitle" --> 
<TITLE>电脑报电子版 -- 自己动手编写电子邮件接收程序</TITLE>
<!-- #EndEditable --> 
<style type="text/css">
<!--
.centertitle {  font-weight: bold; text-align: center; line-height: 35px; font-size: 9pt; color: #000000}
.lefttitle {  line-height: 35px; font-weight: bold; font-size: 9pt; color: #000000}
-->
</style>
</HEAD>
<BODY BGCOLOR='white'>
<span class="centertitle"></span> 
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='6' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='top'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='Center'>
  <TR> 
    <TD WIDTH='145' BGCOLOR='#CCCC99' 	ALIGN='Center' VALIGN='top'><A HREF='http://www.yesky.com'><IMG SRC='images/logo.gif' WIDTH='140' HEIGHT='60' ALT='天极网' BORDER='0'></A></TD>
    <TD WIDTH='470' BGCOLOR='#CCCC99' HEIGHT='50'> 
      <a href="http://chat.yesky.com"><img src="images/0823-3.gif" width="468" height="60" border="0"></a>
    </TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='2' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR> 
    <TD WIDTH='100%'><IMG SRC='../../images/pixel.gif' WIDTH='1' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE BORDER='0' WIDTH='615' CELLSPACING='0' CELLPADDING='0' HEIGHT='3' ALIGN='Center' BGCOLOR='#CCCC99'>
  <TR VALIGN='bottom'> 
    <TD WIDTH='100%'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<table width='615' border='0' cellspacing='0' cellpadding='2' align='Center'>
  <tr> 
    <td width='615' colspan='2'><font color="#FF6666">当前位置：</font><a href='http://www.cpcw.com/issue/index.html'>CPCW电子版</a> 
      &gt; <a href='http://www.cpcw.com/issue/all.html'>2000年</a> &gt; <a href="index.html"><!-- #BeginEditable "%C6%DA" -->10期<!-- #EndEditable --></a> 
      &gt; <!-- #BeginEditable "%C0%B8%C4%BF" --><a href="software.html">软件世界</a><!-- #EndEditable --> 
      &gt; <!-- #BeginEditable "%B1%EA%CC%E2" -->{自己动手编写电子邮件接收程序}<!-- #EndEditable --></td>
  </tr>
</table>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' BGCOLOR='#FFCC66' ALIGN='center'>
  <TR> 
    <TD><SPAN CLASS='title'>《 <!-- #BeginEditable "%CE%C4%D5%C2%CD%B7" -->{自己动手编写电子邮件接收程序}<!-- #EndEditable --> 
      》</SPAN></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD><!-- #BeginEditable "%CE%C4%D5%C2%C4%DA%C8%DD" -->{　　2000年第1期发表了《自己动手编写电子邮件发送程序》一文后，相信很多朋友都拥有自己的个性化电子邮件发送程序了。今天，我就带大家学习用POP3协议收取邮件的方法。<br>
      　　一、先试试手工收信<br>
      　　同发信一样，你要用TELNET程序登录到POP3服务器，必要时可以打开“本地回现”选项，最好打开“选项”菜单下的“开始记录”项，用日志文件记录下你和服务器的交互信息，供以后分析用。连接时，注意把端口设为POP3协议默认的110号。<br>
      　　连接成功，服务器会返回以下信息：<br>
      　　＋OK ...........<br>
      　　字符＋OK是POP3协议的返回信息。它的回应信息不像SMTP协议那样用丰富多变的数字表示，只有两个：＋OK或者－ERR。其中，＋OK表示连结成功，－ERR表示连结失败。<br>
      　　接下来，输入<br>
      　　USER &lt;用户名&gt;<br>
      　　该命令告诉服务器你的用户名（ 注意，有些服务器会区分字母大小写）。<br>
      　　服务器返回＋OK之后，输入<br>
      　　PASS &lt;口令&gt;<br>
      　　服务器返回＋OK之后，还返回一些邮箱的统计信息，如：我的邮箱服务器返回<br>
      　　＋OK clyde has 2 messages<br>
      　　不同的服务器返回的信息格式不太一样，所以我们可以用STAT命令来查看邮箱的情况。<br>
      　　STAT命令的回应中有两个数字，分别表示邮件数量和邮件的大小。<br>
      　　如果信箱里有信，就可以用RETR命令来获取邮件正文。RETR命令的格式是：<br>
      　　RETR &lt;邮件编号&gt;<br>
      　　如果返回结果第一行是＋OK信息，表示成功。第二行起是邮件正文。最后一行和SMTP协议一样，是一个单独的英文句号，表示邮件的末尾部分。<br>
      　　把邮件存储起来以后要用DELE命令删除邮箱中的邮件，要不然，你的信箱撑崩了可别怨我没告诉你。DELE命令的格式是：<br>
      　　DELE &lt;邮件编号&gt;<br>
      　　如果删错了，可以用RSET命令恢复所有删除的邮件。条件是你还没退出。一旦退出，就一切都晚了。<br>
      　　全部完成以后，输入QUIT命令退出POP3服务器。<br>
      　　另外，有一个UIDL命令，是提供一个供邮件程序使用的十六进制邮件识别码，它对我们没太大用处。<br>
      　　二、自己编个小程序<br>
      　　弄懂了POP3协议的原理，我们就可以用VB编一个小程序来完成这些工作。<br>
      　　首先，在窗体上放上一个WINSOCK控件，取名POP3，一个按钮cmdStart和三个文本框，分别叫USER、PASS和SERVER，用以输入用户名、口令、服务器名等信息。<br>
      　　在按钮的Click事件中启动WINSOCK控件的连接。<br>
      　　Private Sub cmdStart_Click()<br>
      　　POP3.RemoteHost = SERVER.Text<br>
      　　POP3.RemotePort = 110<br>
      　　Tag = ″conn″<br>
      　　POP3.Connect<br>
      　　End Sub<br>
      　　对于处理邮件服务器的返回信息，有些编程爱好者喜欢用WAITFOR过程。我认为这种方法不妥。如果程序等的是＋OK，但是服务器返回一个－ERR，那岂不是永远也等不到了？所以在DataArrival事件中通过判断返回的信息再进行响应的处理比较好。DataArrival事件的处理代码如下：<br>
      　　Private Sub POP3_DataArrival(ByVal bytesTotal As Long)<br>
      　　Dim DATA As String, StartAt As Integer, Length As Integer<br>
      　　POP3.GetData DATA<br>
      　　 Select Case Left(DATA, 1)<br>
      　　 Case ″＋″ ′判断状态<br>
      　　 Select Case Tag ′刚刚发送了哪条命令<br>
      　　 Case ″conn″ ′刚连接<br>
      　　 POP3.SendData ″USER ″ ＆ USER ＆ vbCrLf ′发送 ′用户名<br>
      　　 Tag = ″user″<br>
      　　 Case ″user″<br>
      　　 POP3.SendData ″PASS ″ ＆ PASS ＆ vbCrLf ′发送口令<br>
      　　 Tag = ″pass″<br>
      　　 Case ″pass″<br>
      　　 POP3.SendData ″STAT″ ＆ vbCrLf<br>
      　　 Tag = ″stat″<br>
      　　 Case ″stat″ ′获取邮箱状态<br>
      　　 Total = Val(Mid(DATA, 5, InStr(5, DATA, Chr(32)) － 5)) ′共有几封信<br>
      　　 If Total = 0 Then ′如果没有信,退出<br>
      　　 Tag = ″quit″<br>
      　　 POP3.SendData ″quit″ ＆ vbCrLf<br>
      　　 Exit Sub<br>
      　　 End If<br>
      　　 Current = 1 ′否则 ′开始接收<br>
      　　 POP3.SendData ″RETR 1″ ＆ vbCrLf<br>
      　　 Tag = ″retr″<br>
      　　 Case ″retr″ ′接收到＋OK以后初 ′始化邮件正文变量,准备接受正文<br>
      　　 MailText = ″″<br>
      　　 Case ″dele″ ′删除完毕<br>
      　　 Current = Current ＋ 1<br>
      　　 If Current &lt; Total Then ′如果这 ′不是最后一封,接收下一封<br>
      　　 POP3.SendData ″RETR ″ ＆ Current ＆ vbCrLf<br>
      　　 Tag = ″retr″<br>
      　　 Else<br>
      　　 POP3.SendData ″QUIT″ ＆ vbCrLf ′否则退出<br>
      　　 Tag = ″quit″<br>
      　　 End If<br>
      　　 Case ″quit″<br>
      　　 Tag = ″″<br>
      　　 End Select<br>
      　　 Case ″－″ ′如果错误,提示,退出<br>
      　　 MsgBox ″错误″ ＆ DATA<br>
      　　 POP3.SendData ″quit″<br>
      　　 Tag = ″quit″ Case Else ′其他数据，是邮件正文<br>
      　　 If Right(DATA, 5) = vbCrLf ＆ ″.″ ＆ vbCrLf Then ′最后是单独的一个句点，表示这是最后一部分<br>
      　　 MailText = MailText ＆ Left(DATA, Len(DATA) － 5)<br>
      ′获取邮件正文,并且保存邮件<br>
      　　 SaveMail<br>
      　　 POP3.SendData ″DELE ″ ＆ Current ＆ vbCrLf <br>
      ′删除该邮件<br>
      　　 Tag = ″dele″<br>
      　　 Else ′不是最后一部分,仅获取正文，等待下一部分<br>
      　　 MailText = MailText ＆ DATA<br>
      　　 End If<br>
      　　 End Select<br>
      　　End Sub<br>
      　　如果因为网络可能堵塞，邮件不能一次传过来。所以在接收邮件的那一段程序中须要判断接收到的是不是邮件的结尾，如果是的话就把邮件存盘，如果不是就继续接收。<br>
      　　三、对邮件的保存和解码<br>
      　　大家知道，绝大部分邮件都是经过Base64或者Quote－Printable编码的。这使邮件变得不可以直接阅读，必须对它解码才行。在邮件处理程序中，可调用SaveMail过程，用以保存已经收到的邮件。SaveMail过程的代码如下：<br>
      　　Sub SaveMail()<br>
      　　Open Current ＆ ″.eml″ For Output As ＃1<br>
      　　Print ＃1, MailText<br>
      　　Close ＃1<br>
      　　End Sub<br>
      　　经过以上的处理，服务器上的邮件被保存成.EML的文件。这种文件可以直接由Outlook Express打开，也可以在Foxmail中导入，从而省去了我们在程序中解码的麻烦。<br>
      　　以上程序在Win98，VB5中通过。}<!-- #EndEditable --></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR> 
    <TD>&nbsp;</TD>
    <TD ALIGN='right'><A HREF='#top'>页 首</A></TD>
  </TR>
</TABLE>
<BR>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='0' ALIGN='center'>
  <TR ALIGN='center' VALIGN='bottom'> 
    <TD HEIGHT='6'><IMG SRC='../../images/dot.gif' WIDTH='615' HEIGHT='1'></TD>
  </TR>
</TABLE>
<TABLE WIDTH='615' BORDER='0' CELLSPACING='0' CELLPADDING='2' ALIGN='center'>
  <TR ALIGN='center'> 
    <TD> 
      <script language="JavaScript" src="../../download/yeskye.js">
</script>
    </TD>
    <TD> <noscript></noscript> <a href='/'>《电脑报》版权所有</a>，<a href='mailto:webmaster@staff.yesky.com'>YESKY网站编辑部</a>设计制作发布</TD>
  </TR>
</TABLE>
</BODY>
<!-- #EndTemplate -->
</HTML>
