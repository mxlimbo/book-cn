name: CI

on:
  push:
    branch: [mdoc]

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v2
        with:
          ref: doc
          path: doc
      - name: update
        shell: bash 
        run: |
           cd doc
           #git fetch origin docs:docs
           #git checkout docs
           git config pull.rebase false
           git config --local user.email "bot@users.noreply.github.com"
           git config --local user.name "bot"
           find docs/2 -name "*htm" > /tmp/todo
           find docs/3 -name "*htm" >> /tmp/todo
           find docs/4 -name "*htm" >> /tmp/todo
           while IFS= read -r line
           do
             iconv -f GB18030 -t utf-8 "$line" > "${line}.txt" && mv "$line.txt" "$line" || echo "$line" &
           done < /tmp/todo
           cat /tmp/todo >> book.md
           git add -A .
           git commit -m "fix encoding 2-4"
           git push "https://${GITHUB_ACTOR}:${{ github.token }}@github.com/${GITHUB_REPOSITORY}.git" HEAD:doc
